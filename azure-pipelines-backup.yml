# Azure DevOps Pipeline for Eptura Engage Android Automation
# This pipeline downloads APK from Azure Blob Storage and runs automated tests

trigger:
  branches:
    include:
      - main
      - master
      - develop
  paths:
    exclude:
      - README.md
      - docs/*

pr:
  branches:
    include:
      - main
      - master
      - develop

pool:
  vmImage: 'ubuntu-latest'

variables:
  MAVEN_CACHE_FOLDER: $(Pipeline.Workspace)/.m2/repository
  MAVEN_OPTS: '-Dmaven.repo.local=$(MAVEN_CACHE_FOLDER)'
  ANDROID_HOME: $(Agent.ToolsDirectory)/android-sdk
  APPIUM_VERSION: '3.0.0'
  # Azure Blob Storage variables
  AZURE_STORAGE_ACCOUNT: 'entstorage'
  AZURE_STORAGE_CONTAINER: 'mobilebuilds'
  # AZURE_SAS_TOKEN: Configure this as a SECRET variable in Azure DevOps Pipeline Variables
  APK_BLOB_NAME: 'Engage/Android/EpturaEngage.apk'
  APK_LOCAL_PATH: '$(Build.SourcesDirectory)/EpturaEngage.apk'

stages:
  - stage: Setup
    displayName: 'Setup Environment'
    jobs:
      - job: SetupAndroidSDK
        displayName: 'Setup Android SDK and Appium'
        steps:
          - task: JavaToolInstaller@0
            displayName: 'Install Java 11'
            inputs:
              versionSpec: '11'
              jdkArchitectureOption: 'x64'
              jdkSourceOption: 'PreInstalled'

          - script: |
              mkdir -p $(MAVEN_CACHE_FOLDER)
            displayName: 'Create Maven Cache Directory'

          - task: Cache@2
            displayName: 'Cache Maven Dependencies'
            inputs:
              key: 'maven | "$(Agent.OS)" | **/pom.xml'
              restoreKeys: |
                maven | "$(Agent.OS)"
                maven
              path: $(MAVEN_CACHE_FOLDER)

          - script: |
              set -e
              echo "üì¶ Installing Android SDK..."
              mkdir -p $(ANDROID_HOME)
              cd $(ANDROID_HOME)
              wget -q https://dl.google.com/android/repository/commandlinetools-linux-9477386_latest.zip
              unzip -q commandlinetools-linux-9477386_latest.zip
              mkdir -p cmdline-tools/latest
              mv cmdline-tools/* cmdline-tools/latest/ 2>/dev/null || true
              export PATH=$(ANDROID_HOME)/cmdline-tools/latest/bin:$PATH
              yes | sdkmanager --licenses || true
              sdkmanager "platform-tools" "platforms;android-30" "emulator" "build-tools;30.0.3"
              echo "‚úÖ Android SDK installed"
            displayName: 'Install Android SDK'

          - script: |
              set -e
              echo "üì± Installing Appium..."
              sudo npm install -g appium@$(APPIUM_VERSION)
              appium driver install uiautomator2
              appium -v
              echo "‚úÖ Appium installed successfully"
            displayName: 'Install Appium'

  - stage: DownloadAPK
    displayName: 'Download APK from Azure Blob'
    dependsOn: Setup
    jobs:
      - job: DownloadFromBlob
        displayName: 'Download APK'
        steps:
          - script: |
              echo "üì• Downloading APK from Azure Blob Storage using SAS Token..."
            displayName: 'Prepare Download'

          - task: PythonScript@0
            displayName: 'Download APK from Blob Storage'
            inputs:
              scriptSource: 'filePath'
              scriptPath: '$(Build.SourcesDirectory)/scripts/download_apk_from_blob.py'
            env:
              AZURE_STORAGE_ACCOUNT: $(AZURE_STORAGE_ACCOUNT)
              AZURE_STORAGE_CONTAINER: $(AZURE_STORAGE_CONTAINER)
              AZURE_SAS_TOKEN: $(AZURE_SAS_TOKEN)
              APK_BLOB_NAME: $(APK_BLOB_NAME)
              APK_LOCAL_PATH: $(APK_LOCAL_PATH)

          - task: PublishPipelineArtifact@1
            displayName: 'Publish APK Artifact'
            inputs:
              targetPath: '$(APK_LOCAL_PATH)'
              artifact: 'AndroidAPK'
              publishLocation: 'pipeline'

  - stage: Build
    displayName: 'Build Test Project'
    dependsOn: DownloadAPK
    jobs:
      - job: MavenBuild
        displayName: 'Maven Compile'
        steps:
          - task: JavaToolInstaller@0
            displayName: 'Install Java 11'
            inputs:
              versionSpec: '11'
              jdkArchitectureOption: 'x64'
              jdkSourceOption: 'PreInstalled'

          - script: |
              mkdir -p $(MAVEN_CACHE_FOLDER)
            displayName: 'Create Maven Cache Directory'

          - task: Cache@2
            displayName: 'Cache Maven Dependencies'
            inputs:
              key: 'maven | "$(Agent.OS)" | **/pom.xml'
              restoreKeys: |
                maven | "$(Agent.OS)"
                maven
              path: $(MAVEN_CACHE_FOLDER)

          - task: Maven@3
            displayName: 'Maven Clean Compile'
            inputs:
              mavenPomFile: 'pom.xml'
              goals: 'clean compile'
              options: '-DskipTests $(MAVEN_OPTS)'
              publishJUnitResults: false
              javaHomeOption: 'JDKVersion'
              jdkVersionOption: '1.11'
              mavenVersionOption: 'Default'

  - stage: Test
    displayName: 'Run Automation Tests'
    dependsOn: Build
    jobs:
      - job: RunTests
        displayName: 'Execute TestNG Suite'
        timeoutInMinutes: 120
        steps:
          - task: JavaToolInstaller@0
            displayName: 'Install Java 11'
            inputs:
              versionSpec: '11'
              jdkArchitectureOption: 'x64'
              jdkSourceOption: 'PreInstalled'

          - task: DownloadPipelineArtifact@2
            displayName: 'Download APK Artifact'
            inputs:
              artifactName: 'AndroidAPK'
              targetPath: '$(Build.SourcesDirectory)'

          - script: |
              set -e
              echo "üì¶ Installing Android SDK..."
              mkdir -p $(ANDROID_HOME)
              cd $(ANDROID_HOME)
              wget -q https://dl.google.com/android/repository/commandlinetools-linux-9477386_latest.zip
              unzip -q commandlinetools-linux-9477386_latest.zip
              mkdir -p cmdline-tools/latest
              mv cmdline-tools/* cmdline-tools/latest/ 2>/dev/null || true
              export PATH=$(ANDROID_HOME)/cmdline-tools/latest/bin:$(ANDROID_HOME)/platform-tools:$(ANDROID_HOME)/emulator:$PATH
              yes | sdkmanager --licenses || true
              sdkmanager "platform-tools" "platforms;android-30" "emulator" "build-tools;30.0.3" "system-images;android-30;google_apis;x86_64"
              echo "‚úÖ Android SDK installed"
            displayName: 'Install Android SDK'

          - script: |
              set -e
              echo "üì± Creating Android Emulator..."
              export PATH=$(ANDROID_HOME)/cmdline-tools/latest/bin:$(ANDROID_HOME)/platform-tools:$(ANDROID_HOME)/emulator:$PATH
              export ANDROID_HOME=$(ANDROID_HOME)
              export ANDROID_SDK_ROOT=$(ANDROID_HOME)
              
              # Create AVD (Android Virtual Device)
              echo "no" | avdmanager create avd -n test_emulator -k "system-images;android-30;google_apis;x86_64" --force
              
              echo "‚úÖ Android Emulator created"
            displayName: 'Create Android Emulator'

          - script: |
              set -e
              echo "üöÄ Starting Android Emulator..."
              export PATH=$(ANDROID_HOME)/cmdline-tools/latest/bin:$(ANDROID_HOME)/platform-tools:$(ANDROID_HOME)/emulator:$PATH
              export ANDROID_HOME=$(ANDROID_HOME)
              export ANDROID_SDK_ROOT=$(ANDROID_HOME)
              
              # Enable KVM for hardware acceleration
              sudo apt-get update
              sudo apt-get install -y qemu-kvm libvirt-daemon-system libvirt-clients bridge-utils
              sudo adduser $USER kvm || true
              sudo chown $USER /dev/kvm || true
              
              # Start emulator in background with no window
              nohup $(ANDROID_HOME)/emulator/emulator -avd test_emulator -no-window -no-audio -no-boot-anim -gpu swiftshader_indirect -no-snapshot -wipe-data > emulator.log 2>&1 &
              
              # Wait for emulator to boot
              echo "‚è≥ Waiting for emulator to boot..."
              adb wait-for-device
              
              # Wait for boot completion
              boot_completed=""
              timeout=300
              counter=0
              while [ "$boot_completed" != "1" ] && [ $counter -lt $timeout ]; do
                boot_completed=$(adb shell getprop sys.boot_completed 2>/dev/null | tr -d '\r')
                counter=$((counter + 5))
                if [ "$boot_completed" != "1" ]; then
                  echo "Waiting for boot... ($counter seconds)"
                  sleep 5
                fi
              done
              
              if [ "$boot_completed" = "1" ]; then
                echo "‚úÖ Android Emulator started and booted successfully"
                adb devices
              else
                echo "‚ùå Emulator failed to boot within timeout"
                cat emulator.log
                exit 1
              fi
            displayName: 'Start Android Emulator'

          - script: |
              set -e
              echo "üîß Setting up Appium..."
              export PATH=$(ANDROID_HOME)/cmdline-tools/latest/bin:$(ANDROID_HOME)/platform-tools:$(ANDROID_HOME)/emulator:$PATH
              export ANDROID_HOME=$(ANDROID_HOME)
              export ANDROID_SDK_ROOT=$(ANDROID_HOME)
              
              # Install Appium
              sudo npm install -g appium@$(APPIUM_VERSION)
              appium driver install uiautomator2
              
              # Start Appium server
              echo "üöÄ Starting Appium server..."
              nohup appium --address 127.0.0.1 --port 4723 --session-override --relaxed-security > appium.log 2>&1 &
              sleep 10
              
              # Verify Appium is running
              if curl -s http://127.0.0.1:4723/status | grep -q "ready"; then
                echo "‚úÖ Appium server started successfully"
              else
                echo "‚ö†Ô∏è Appium server may not be ready, continuing..."
              fi
            displayName: 'Setup Appium'

          - script: |
              set -e
              echo "üì≤ Installing APK from Azure Blob Storage on emulator..."
              export PATH=$(ANDROID_HOME)/platform-tools:$PATH
              
              # Create screenshots directory for installation process
              SCREENSHOTS_DIR="$(Build.SourcesDirectory)/installation-screenshots"
              mkdir -p $SCREENSHOTS_DIR
              
              # Wait a bit more for emulator to be fully ready
              sleep 10
              
              # Capture screenshot before installation
              echo "üì∏ Capturing pre-installation screenshot..."
              adb shell screencap -p /sdcard/pre_install.png
              adb pull /sdcard/pre_install.png "$SCREENSHOTS_DIR/01_pre_installation_$(date +%Y%m%d_%H%M%S).png" || echo "Failed to capture pre-install screenshot"
              
              echo "üîç Searching for APK file downloaded from blob storage..."
              echo "Contents of Build.SourcesDirectory:"
              ls -la $(Build.SourcesDirectory)/
              
              # Try to find the APK file - it could be named EpturaEngage.apk or EpturaEngage.apk
              APK_FILE=""
              
              # Check for EpturaEngage.apk (the expected name from blob download)
              if [ -f "$(Build.SourcesDirectory)/EpturaEngage.apk" ]; then
                APK_FILE="$(Build.SourcesDirectory)/EpturaEngage.apk"
                echo "‚úÖ Found APK at: $APK_FILE"
              # Check for any .apk file in the source directory
              elif [ -n "$(find $(Build.SourcesDirectory) -maxdepth 1 -name '*.apk' -type f 2>/dev/null | head -1)" ]; then
                APK_FILE=$(find $(Build.SourcesDirectory) -maxdepth 1 -name '*.apk' -type f | head -1)
                echo "‚úÖ Found APK at: $APK_FILE"
              # Check recursively for any .apk file
              elif [ -n "$(find $(Build.SourcesDirectory) -name '*.apk' -type f 2>/dev/null | head -1)" ]; then
                APK_FILE=$(find $(Build.SourcesDirectory) -name '*.apk' -type f | head -1)
                echo "‚úÖ Found APK at: $APK_FILE"
              fi
              
              if [ -n "$APK_FILE" ] && [ -f "$APK_FILE" ]; then
                echo "üì± APK file details:"
                ls -la "$APK_FILE"
                echo "üì≤ Installing APK on emulator..."
                adb install -r "$APK_FILE"
                
                # Capture screenshot after installation
                echo "üì∏ Capturing post-installation screenshot..."
                sleep 3
                adb shell screencap -p /sdcard/post_install.png
                adb pull /sdcard/post_install.png "$SCREENSHOTS_DIR/02_post_installation_$(date +%Y%m%d_%H%M%S).png" || echo "Failed to capture post-install screenshot"
                
                # Verify the app is installed
                if adb shell pm list packages | grep -q "com.condecosoftware.condeco"; then
                  echo "‚úÖ APK from blob storage installed and verified successfully!"
                  
                  # Launch the app and capture screenshot
                  echo "üöÄ Launching app for verification..."
                  adb shell monkey -p com.condecosoftware.condeco -c android.intent.category.LAUNCHER 1
                  sleep 5
                  
                  # Capture screenshot of app launch
                  echo "üì∏ Capturing app launch screenshot..."
                  adb shell screencap -p /sdcard/app_launch.png
                  adb pull /sdcard/app_launch.png "$SCREENSHOTS_DIR/03_app_launch_$(date +%Y%m%d_%H%M%S).png" || echo "Failed to capture app launch screenshot"
                  
                  # Wait for app to fully load and capture another screenshot
                  sleep 5
                  adb shell screencap -p /sdcard/app_loaded.png
                  adb pull /sdcard/app_loaded.png "$SCREENSHOTS_DIR/04_app_loaded_$(date +%Y%m%d_%H%M%S).png" || echo "Failed to capture app loaded screenshot"
                else
                  echo "‚ö†Ô∏è APK installed but package verification failed. Continuing anyway..."
                  # Capture screenshot showing installed packages
                  adb shell screencap -p /sdcard/packages_list.png
                  adb pull /sdcard/packages_list.png "$SCREENSHOTS_DIR/05_package_verification_failed_$(date +%Y%m%d_%H%M%S).png" || echo "Failed to capture packages screenshot"
                fi
              else
                echo "‚ùå ERROR: No APK file found from blob storage!"
                echo "üìÅ Full directory listing:"
                find $(Build.SourcesDirectory) -type f -name "*.apk" 2>/dev/null || echo "No APK files found"
                echo "üìÅ All files in source directory:"
                find $(Build.SourcesDirectory) -type f | head -50
                
                # Capture screenshot of error state
                adb shell screencap -p /sdcard/error_state.png
                adb pull /sdcard/error_state.png "$SCREENSHOTS_DIR/00_error_no_apk_found_$(date +%Y%m%d_%H%M%S).png" || echo "Failed to capture error screenshot"
                exit 1
              fi
              
              echo "üì∏ Installation screenshots saved to: $SCREENSHOTS_DIR"
              ls -la "$SCREENSHOTS_DIR"
            displayName: 'Install APK on Emulator with Screenshots'

          - task: Maven@3
            displayName: 'Run Tests'
            inputs:
              mavenPomFile: 'pom.xml'
              goals: 'test'
              options: '-Dtestng.xml=testng.xml -DdeviceName=emulator-5554 $(MAVEN_OPTS)'
              publishJUnitResults: true
              testResultsFiles: '**/surefire-reports/TEST-*.xml'
              testRunTitle: 'Eptura Engage Android Tests'
              javaHomeOption: 'JDKVersion'
              jdkVersionOption: '1.11'
              mavenVersionOption: 'Default'
            env:
              ANDROID_HOME: $(ANDROID_HOME)
              ANDROID_SDK_ROOT: $(ANDROID_HOME)
            continueOnError: true

          - script: |
              set -e
              echo "üì∏ Capturing final emulator state screenshot..."
              export PATH=$(ANDROID_HOME)/platform-tools:$PATH
              
              SCREENSHOTS_DIR="$(Build.SourcesDirectory)/installation-screenshots"
              mkdir -p $SCREENSHOTS_DIR
              
              # Capture final state of emulator after tests
              adb shell screencap -p /sdcard/final_state.png
              adb pull /sdcard/final_state.png "$SCREENSHOTS_DIR/99_final_state_after_tests_$(date +%Y%m%d_%H%M%S).png" || echo "Failed to capture final state screenshot"
              
              echo "üì∏ Final screenshot captured"
            displayName: 'Capture Final Emulator State'
            condition: always()

          - script: |
              echo "üìä Collecting test execution reports..."
              
              # Create reports directory
              REPORTS_DIR="$(Build.SourcesDirectory)/test-reports"
              mkdir -p $REPORTS_DIR
              
              # Copy surefire reports
              if [ -d "$(Build.SourcesDirectory)/target/surefire-reports" ]; then
                cp -r $(Build.SourcesDirectory)/target/surefire-reports $REPORTS_DIR/
                echo "‚úÖ Surefire reports copied"
              fi
              
              # Copy TestNG output
              if [ -d "$(Build.SourcesDirectory)/test-output" ]; then
                cp -r $(Build.SourcesDirectory)/test-output $REPORTS_DIR/testng-output
                echo "‚úÖ TestNG output copied"
              fi
              
              # Copy Extent report if exists
              if [ -f "$(Build.SourcesDirectory)/target/Extent-report.html" ]; then
                cp $(Build.SourcesDirectory)/target/Extent-report.html $REPORTS_DIR/
                echo "‚úÖ Extent report copied"
              fi
              
              # Copy cucumber reports if exists
              if [ -d "$(Build.SourcesDirectory)/target/cucumber-report" ]; then
                cp -r $(Build.SourcesDirectory)/target/cucumber-report $REPORTS_DIR/
                echo "‚úÖ Cucumber reports copied"
              fi
              
              # Copy generated HTML report if exists
              if [ -d "$(Build.SourcesDirectory)/target/generated-report" ]; then
                cp -r $(Build.SourcesDirectory)/target/generated-report $REPORTS_DIR/
                echo "‚úÖ Generated HTML report copied"
              fi
              
              # Copy test screenshots from target
              if [ -d "$(Build.SourcesDirectory)/target/screenshots" ]; then
                cp -r $(Build.SourcesDirectory)/target/screenshots $REPORTS_DIR/test-screenshots
                echo "‚úÖ Test screenshots copied"
              fi
              
              # Copy Appium and Emulator logs
              if [ -f "$(Build.SourcesDirectory)/appium.log" ]; then
                cp $(Build.SourcesDirectory)/appium.log $REPORTS_DIR/
                echo "‚úÖ Appium log copied"
              fi
              
              if [ -f "$(Build.SourcesDirectory)/emulator.log" ]; then
                cp $(Build.SourcesDirectory)/emulator.log $REPORTS_DIR/
                echo "‚úÖ Emulator log copied"
              fi
              
              echo "üìÅ Reports directory contents:"
              find $REPORTS_DIR -type f | head -100
            displayName: 'Collect Test Reports'
            condition: always()

          - task: PublishPipelineArtifact@1
            displayName: 'Publish Installation Screenshots'
            inputs:
              targetPath: '$(Build.SourcesDirectory)/installation-screenshots'
              artifact: 'InstallationScreenshots'
              publishLocation: 'pipeline'
            condition: always()

          - task: PublishPipelineArtifact@1
            displayName: 'Publish Test Reports'
            inputs:
              targetPath: '$(Build.SourcesDirectory)/test-reports'
              artifact: 'TestExecutionReports'
              publishLocation: 'pipeline'
            condition: always()

          - task: PublishPipelineArtifact@1
            displayName: 'Publish Test Screenshots'
            inputs:
              targetPath: '$(Build.SourcesDirectory)/target/screenshots'
              artifact: 'TestScreenshots'
              publishLocation: 'pipeline'
            condition: succeededOrFailed()
            continueOnError: true

          - task: PublishTestResults@2
            displayName: 'Publish TestNG Results'
            inputs:
              testResultsFormat: 'JUnit'
              testResultsFiles: '**/surefire-reports/TEST-*.xml'
              testRunTitle: 'Eptura Engage Android Test Results'
              mergeTestResults: true
              failTaskOnFailedTests: false
            condition: always()
