# Azure Pipeline for Eptura Engage Android Automation
# This pipeline creates an emulator with Google Play Store and installs app from Play Store

trigger:
  branches:
    include:
      - main
      - master
      - develop
  paths:
    exclude:
      - README.md
      - docs/**

pr:
  branches:
    include:
      - main
      - master
      - develop

# Pipeline variables
variables:
  mavenPOMFile: 'pom.xml'
  jdkVersion: '17'
  appiumVersion: '3.0.0'
  androidSdkVersion: '30'
  testResultsFolder: '$(System.DefaultWorkingDirectory)/target/surefire-reports'
  screenshotsFolder: '$(System.DefaultWorkingDirectory)/target/screenshots'
  extentReportFolder: '$(System.DefaultWorkingDirectory)/target'
  emulatorName: 'test_emulator_playstore'

# Agent pool - Use Microsoft-hosted macOS agents
pool:
  vmImage: 'macOS-14'

stages:
  - stage: Build
    displayName: 'Build Stage'
    jobs:
      - job: MavenBuild
        displayName: 'Build Maven Project'
        steps:
          - task: JavaToolInstaller@0
            displayName: 'Install Java JDK 17'
            inputs:
              versionSpec: '17'
              jdkArchitectureOption: 'x64'
              jdkSourceOption: 'PreInstalled'

          - task: Maven@4
            displayName: 'Maven Clean Compile'
            inputs:
              mavenPomFile: '$(mavenPOMFile)'
              goals: 'clean compile'
              options: '-DskipTests'
              publishJUnitResults: false
              javaHomeOption: 'JDKVersion'
              jdkVersionOption: '$(jdkVersion)'
              mavenVersionOption: 'Default'
              mavenOptions: '-Xmx3072m'

          - task: PublishBuildArtifacts@1
            displayName: 'Publish Build Artifacts'
            inputs:
              PathtoPublish: '$(System.DefaultWorkingDirectory)/target'
              ArtifactName: 'build-output'
              publishLocation: 'Container'

  - stage: Test
    displayName: 'Test Stage'
    dependsOn: Build
    jobs:
      - job: AndroidTests
        displayName: 'Run Android Appium Tests'
        timeoutInMinutes: 120
        steps:
          - task: JavaToolInstaller@0
            displayName: 'Install Java JDK 17'
            inputs:
              versionSpec: '17'
              jdkArchitectureOption: 'x64'
              jdkSourceOption: 'PreInstalled'

          - task: NodeTool@0
            displayName: 'Install Node.js'
            inputs:
              versionSpec: '20.x'

          - bash: |
              echo "üêç Installing Python dependencies for Play Store installer..."
              python3 --version
              pip3 --version
              
              # Install Appium Python client and dependencies
              # Using --break-system-packages flag to bypass PEP 668 restrictions on macOS
              # Allow pip upgrade to fail as it's not critical
              pip3 install --upgrade pip --break-system-packages || echo "‚ö†Ô∏è  Pip upgrade skipped (not critical)"
              
              # Install required packages
              pip3 install Appium-Python-Client --break-system-packages || { echo "‚ùå Failed to install Appium-Python-Client"; exit 1; }
              pip3 install selenium --break-system-packages || { echo "‚ùå Failed to install selenium"; exit 1; }
              
              echo "‚úÖ Python dependencies installed"
              pip3 list | grep -i appium || echo "Appium package verification"
            displayName: 'Install Python Dependencies'

          - bash: |
              echo "üì± Configuring Android SDK with Google Play support..."
              
              # Set Android environment variables
              export ANDROID_HOME=$ANDROID_SDK_ROOT
              export PATH=$PATH:$ANDROID_HOME/platform-tools:$ANDROID_HOME/emulator:$ANDROID_HOME/cmdline-tools/latest/bin
              
              echo "ANDROID_HOME: $ANDROID_HOME"
              echo "ANDROID_SDK_ROOT: $ANDROID_SDK_ROOT"
              
              # Verify Android SDK exists
              if [ ! -d "$ANDROID_HOME" ]; then
                echo "‚ùå ANDROID_HOME directory not found: $ANDROID_HOME"
                exit 1
              fi
              
              echo "üìã Android SDK structure:"
              ls -la $ANDROID_HOME/ || true
              
              # Verify cmdline-tools exists
              if [ ! -d "$ANDROID_HOME/cmdline-tools/latest/bin" ]; then
                echo "‚ùå cmdline-tools not found. Checking for alternative locations..."
                find $ANDROID_HOME -name "sdkmanager" -type f 2>/dev/null || true
                exit 1
              fi
              
              # Accept all licenses first
              echo "üìù Accepting Android SDK licenses..."
              yes | $ANDROID_HOME/cmdline-tools/latest/bin/sdkmanager --licenses 2>&1 || true
              
              # Update SDK manager
              echo "üîÑ Updating SDK manager..."
              $ANDROID_HOME/cmdline-tools/latest/bin/sdkmanager --update || true
              
              # Install SDK components with Google Play Store support
              echo "üì¶ Installing SDK components with Google Play Store..."
              $ANDROID_HOME/cmdline-tools/latest/bin/sdkmanager \
                "platform-tools" \
                "platforms;android-30" \
                "build-tools;30.0.3" \
                "emulator" \
                "system-images;android-30;google_apis_playstore;x86_64" || {
                echo "‚ùå Failed to install SDK components"
                echo "Attempting to list available packages:"
                $ANDROID_HOME/cmdline-tools/latest/bin/sdkmanager --list || true
                exit 1
              }
              
              echo "‚úÖ SDK components installation completed"
              
              # Wait for installation to complete and verify
              sleep 5
              
              # Verify system image was installed
              echo "üîç Verifying system image installation..."
              echo "Checking path: $ANDROID_HOME/system-images/android-30/google_apis_playstore/x86_64"
              
              if [ -d "$ANDROID_HOME/system-images/android-30/google_apis_playstore/x86_64" ]; then
                echo "‚úÖ Google Play system image found!"
                ls -la "$ANDROID_HOME/system-images/android-30/google_apis_playstore/x86_64"
              else
                echo "‚ùå System image not found after installation!"
                echo ""
                echo "Contents of system-images directory:"
                if [ -d "$ANDROID_HOME/system-images" ]; then
                  find $ANDROID_HOME/system-images -type d -maxdepth 3
                else
                  echo "‚ö†Ô∏è  system-images directory does not exist at: $ANDROID_HOME/system-images"
                fi
                echo ""
                echo "üìã List of installed packages:"
                $ANDROID_HOME/cmdline-tools/latest/bin/sdkmanager --list_installed
                exit 1
              fi
              
              # Verify ADB
              echo "üîß Verifying ADB..."
              adb version
              
              # List all installed system images
              echo "üìã Installed system images:"
              $ANDROID_HOME/cmdline-tools/latest/bin/sdkmanager --list_installed | grep system-images || echo "No system images found in installed list"
              
              echo ""
              echo "üì± Creating Android Emulator with Google Play Store..."
              
              # Delete existing emulator if present
              $ANDROID_HOME/cmdline-tools/latest/bin/avdmanager delete avd -n $(emulatorName) 2>/dev/null || true
              
              # Create new emulator with Google Play
              echo "Creating emulator with Google Play Store support..."
              echo "no" | $ANDROID_HOME/cmdline-tools/latest/bin/avdmanager create avd \
                --force \
                --name "$(emulatorName)" \
                --package "system-images;android-30;google_apis_playstore;x86_64" \
                --device "pixel_4" \
                --abi x86_64 || {
                echo "‚ùå Failed to create emulator"
                echo "Available packages:"
                $ANDROID_HOME/cmdline-tools/latest/bin/avdmanager list target
                exit 1
              }
              
              # Verify emulator was created
              echo "üîç Verifying emulator creation..."
              $ANDROID_HOME/emulator/emulator -list-avds
              
              if $ANDROID_HOME/emulator/emulator -list-avds | grep -q "$(emulatorName)"; then
                echo "‚úÖ Emulator '$(emulatorName)' created successfully"
              else
                echo "‚ùå Failed to create emulator"
                echo "Available AVDs:"
                $ANDROID_HOME/emulator/emulator -list-avds
                exit 1
              fi
              
              # Start emulator with optimized settings
              echo "üöÄ Starting emulator with optimized settings..."
              nohup $ANDROID_HOME/emulator/emulator -avd $(emulatorName) \
                -no-snapshot-save \
                -no-window \
                -no-audio \
                -no-boot-anim \
                -gpu swiftshader_indirect \
                -memory 4096 \
                -cores 2 \
                -accel on \
                -wipe-data \
                > emulator.log 2>&1 &
              
              EMULATOR_PID=$!
              echo "Emulator PID: $EMULATOR_PID"
              echo "##vso[task.setvariable variable=EMULATOR_PID]$EMULATOR_PID"
              
              # Wait for device to be detected
              echo "‚è≥ Waiting for emulator device to be detected..."
              adb wait-for-device
              echo "‚úÖ Device detected"
              
              # Wait for boot completion with reasonable timeout
              echo "‚è≥ Waiting for boot_completed flag..."
              timeout=180
              elapsed=0
              until [[ "$(adb shell getprop sys.boot_completed 2>/dev/null | tr -d '\r')" == "1" ]]; do
                if [ $elapsed -ge $timeout ]; then
                  echo "‚ùå Boot timeout after $timeout seconds"
                  echo "=== Emulator Log (last 100 lines) ==="
                  tail -100 emulator.log
                  exit 1
                fi
                sleep 5
                elapsed=$((elapsed+5))
                if [ $((elapsed % 15)) -eq 0 ]; then
                  echo "  Still booting... ($elapsed/$timeout seconds)"
                fi
              done
              
              echo "‚úÖ Boot completed flag set!"
              
              # Optimized service readiness check with faster polling
              echo "‚è≥ Waiting for Android system services (max 90 seconds)..."
              
              service_ready=false
              max_wait=90
              elapsed=0
              
              while [ $elapsed -lt $max_wait ]; do
                # Check all services in one go
                pm_ready=false
                am_ready=false
                
                if adb shell pm list packages >/dev/null 2>&1; then
                  pm_ready=true
                fi
                
                if adb shell am get-config >/dev/null 2>&1; then
                  am_ready=true
                fi
                
                if [ "$pm_ready" = true ] && [ "$am_ready" = true ]; then
                  echo "‚úÖ All critical services are ready!"
                  service_ready=true
                  break
                fi
                
                sleep 3
                elapsed=$((elapsed+3))
                
                if [ $((elapsed % 15)) -eq 0 ]; then
                  echo "  Still initializing services... ($elapsed/$max_wait seconds)"
                  echo "    - Package Manager: $([ "$pm_ready" = true ] && echo "‚úÖ" || echo "‚è≥")"
                  echo "    - Activity Manager: $([ "$am_ready" = true ] && echo "‚úÖ" || echo "‚è≥")"
                fi
              done
              
              if [ "$service_ready" = false ]; then
                echo "‚ö†Ô∏è  Services not ready after $max_wait seconds, but continuing..."
                echo "Attempting to check emulator state:"
                adb shell getprop sys.boot_completed
                adb shell pm list packages | head -5
              fi
              
              # Brief stability wait (reduced from 60s)
              echo "‚è≥ Allowing system to stabilize (15 seconds)..."
              sleep 15
              
              # Final verification
              echo "üîç Final system verification..."
              
              # Verify ADB connection is stable
              if ! adb shell echo "test" > /dev/null 2>&1; then
                echo "‚ùå ADB shell connection failed"
                exit 1
              fi
              
              # Verify package manager with retry
              pm_verified=false
              for i in {1..3}; do
                if adb shell pm list packages > /dev/null 2>&1; then
                  pm_verified=true
                  break
                fi
                echo "  Retry $i/3 for package manager..."
                sleep 5
              done
              
              if [ "$pm_verified" = false ]; then
                echo "‚ö†Ô∏è  Package manager not responding reliably"
                echo "Checking system_server process:"
                adb shell ps | grep system_server || true
              else
                echo "‚úÖ Package manager verified"
              fi
              
              # Verify emulator is ready
              echo "üì± Emulator status:"
              adb devices -l
              echo "Android version: $(adb shell getprop ro.build.version.release)"
              echo "API Level: $(adb shell getprop ro.build.version.sdk)"
              
              # Check for Google Play Store
              echo "üîç Checking for Google Play Store..."
              if adb shell pm list packages | grep -q "com.android.vending"; then
                echo "‚úÖ Google Play Store is present!"
                PLAY_STORE_VERSION=$(adb shell dumpsys package com.android.vending | grep versionName | head -1 | awk '{print $1}' 2>/dev/null || echo "version unknown")
                echo "Play Store: $PLAY_STORE_VERSION"
              else
                echo "‚ö†Ô∏è Google Play Store not found"
                echo "üìã Checking Google services packages:"
                adb shell pm list packages | grep -i google | head -10 || echo "No Google packages found"
              fi
              
              # Get emulator serial
              EMULATOR_SERIAL=$(adb devices | grep "emulator" | head -1 | awk '{print $1}')
              echo "Emulator Serial: $EMULATOR_SERIAL"
              echo "##vso[task.setvariable variable=EMULATOR_SERIAL]$EMULATOR_SERIAL"
              
              echo ""
              echo "‚úÖ Android emulator setup complete! (Total time: ~3-4 minutes expected)"
            displayName: 'Setup Android SDK and Create Emulator with Google Play'

          - task: Npm@1
            displayName: 'Install Appium'
            inputs:
              command: 'custom'
              customCommand: 'install -g appium@$(appiumVersion)'

          - bash: |
              echo "üîå Installing Appium UiAutomator2 Driver..."
              appium driver install uiautomator2
              appium driver list --installed
              echo "‚úÖ Driver installed"
            displayName: 'Install Appium Driver'

          - bash: |
              echo "üöÄ Starting Appium Server..."
              mkdir -p logs
              
              # Clean up any existing Appium processes
              pkill -f appium || true
              sleep 2
              
              # Start Appium
              nohup appium --address 127.0.0.1 --port 4723 --session-override --log-level info > logs/appium.log 2>&1 &
              APPIUM_PID=$!
              echo "Appium PID: $APPIUM_PID"
              echo "##vso[task.setvariable variable=APPIUM_PID]$APPIUM_PID"
              
              # Wait for Appium to be ready
              for i in {1..30}; do
                if curl -s http://127.0.0.1:4723/status > /dev/null 2>&1; then
                  echo "‚úÖ Appium server is ready"
                  exit 0
                fi
                echo "Waiting... ($i/30)"
                sleep 2
              done
              
              echo "‚ùå Appium failed to start"
              cat logs/appium.log
              exit 1
            displayName: 'Start Appium Server'

          - bash: |
              echo "üì≤ Installing Eptura Engage from Google Play Store..."
              echo "======================================================="
              
              # Check if Google Play credentials are provided
              if [ -z "$GOOGLE_PLAY_EMAIL" ] || [ -z "$GOOGLE_PLAY_PASSWORD" ]; then
                echo "‚ö†Ô∏è  GOOGLE_PLAY_EMAIL or GOOGLE_PLAY_PASSWORD not set"
                echo ""
                echo "To enable automatic Play Store installation:"
                echo "1. Go to Azure Pipeline > Edit > Variables"
                echo "2. Add secret variables:"
                echo "   - GOOGLE_PLAY_EMAIL (your Google account email)"
                echo "   - GOOGLE_PLAY_PASSWORD (your Google account password)"
                echo ""
                echo "Attempting alternative installation method..."
                
                # Try opening Play Store directly
                adb shell am start -a android.intent.action.VIEW \
                  -d "market://details?id=com.condecosoftware.condeco"
                sleep 10
                
                echo "‚ö†Ô∏è  Manual installation may be needed"
                echo "If app is pre-installed on emulator, tests will continue"
                
              else
                echo "‚úÖ Google Play credentials found"
                echo "Running automated Play Store installer..."
                echo ""
                
                # Copy Python script to working directory
                cp src/main/resources/install_from_playstore.py .
                
                # Run the installer
                python3 install_from_playstore.py \
                  "$GOOGLE_PLAY_EMAIL" \
                  "$GOOGLE_PLAY_PASSWORD" \
                  "Eptura Engage" || {
                  echo "‚ö†Ô∏è  Automated installation encountered issues"
                  echo "Attempting direct Play Store link as fallback..."
                  adb shell am start -a android.intent.action.VIEW \
                    -d "market://details?id=com.condecosoftware.condeco"
                  sleep 10
                }
              fi
              
              # Wait for installation to complete
              echo ""
              echo "‚è≥ Waiting for app installation..."
              sleep 20
              
              # Verify installation
              if adb shell pm list packages | grep -q "com.condecosoftware.condeco"; then
                echo "‚úÖ Eptura Engage app is installed!"
                APP_INFO=$(adb shell dumpsys package com.condecosoftware.condeco | grep -E "versionName|versionCode" | head -2)
                echo "App info:"
                echo "$APP_INFO"
              else
                echo "‚ùå App installation failed!"
                echo "Available packages containing 'condeco':"
                adb shell pm list packages | grep -i condeco || echo "None found"
                exit 1
              fi
            displayName: 'Install App from Play Store'
            env:
              GOOGLE_PLAY_EMAIL: $(GOOGLE_PLAY_EMAIL)
              GOOGLE_PLAY_PASSWORD: $(GOOGLE_PLAY_PASSWORD)

          - task: DownloadBuildArtifacts@1
            displayName: 'Download Build Artifacts'
            inputs:
              buildType: 'current'
              downloadType: 'single'
              artifactName: 'build-output'
              downloadPath: '$(System.DefaultWorkingDirectory)'

          - task: Maven@4
            displayName: 'Run TestNG Tests'
            inputs:
              mavenPomFile: '$(mavenPOMFile)'
              goals: 'test'
              options: '-Dtestng.xml=testng.xml'
              publishJUnitResults: true
              testResultsFiles: '**/surefire-reports/TEST-*.xml'
              testRunTitle: 'Eptura Engage Android Tests'
              javaHomeOption: 'JDKVersion'
              jdkVersionOption: '$(jdkVersion)'
              mavenVersionOption: 'Default'
              mavenOptions: '-Xmx3072m'
            env:
              USE_EXTERNAL_APPIUM: 'true'
              APPIUM_SERVER_URL: 'http://127.0.0.1:4723'
            continueOnError: true

          - bash: |
              echo "üßπ Cleanup: Stopping Appium Server..."
              pkill -f appium || true
            displayName: 'Stop Appium Server'
            condition: always()

          - bash: |
              echo "üßπ Cleanup: Stopping Emulator..."
              adb emu kill || true
              pkill -f "emulator.*$(emulatorName)" || true
              sleep 5
            displayName: 'Stop Emulator'
            condition: always()

          - task: PublishTestResults@2
            displayName: 'Publish Test Results'
            inputs:
              testResultsFormat: 'JUnit'
              testResultsFiles: '**/surefire-reports/TEST-*.xml'
              mergeTestResults: true
              failTaskOnFailedTests: false
              testRunTitle: 'Eptura Android Tests'
            condition: always()

          - task: PublishBuildArtifacts@1
            displayName: 'Publish Screenshots'
            inputs:
              PathtoPublish: '$(screenshotsFolder)'
              ArtifactName: 'test-screenshots'
            condition: always()

          - task: PublishBuildArtifacts@1
            displayName: 'Publish Extent Report'
            inputs:
              PathtoPublish: '$(extentReportFolder)/Extent-report.html'
              ArtifactName: 'extent-report'
            condition: always()

          - task: PublishBuildArtifacts@1
            displayName: 'Publish Logs'
            inputs:
              PathtoPublish: '$(System.DefaultWorkingDirectory)/logs'
              ArtifactName: 'appium-logs'
            condition: always()

          - bash: |
              if [ -f emulator.log ]; then
                mkdir -p logs
                cp emulator.log logs/
              fi
            displayName: 'Collect Emulator Logs'
            condition: always()

          - task: PublishBuildArtifacts@1
            displayName: 'Publish Emulator Logs'
            inputs:
              PathtoPublish: '$(System.DefaultWorkingDirectory)/logs'
              ArtifactName: 'emulator-logs'
            condition: always()

  - stage: Report
    displayName: 'Test Reports'
    dependsOn: Test
    condition: always()
    jobs:
      - job: Summary
        displayName: 'Test Summary'
        steps:
          - task: DownloadBuildArtifacts@1
            inputs:
              buildType: 'current'
              downloadType: 'specific'
              itemPattern: '**'
              downloadPath: '$(System.DefaultWorkingDirectory)/artifacts'

          - bash: |
              echo "üìä Test Execution Summary"
              echo "=========================="
              if [ -d "artifacts/test-screenshots" ]; then
                SCREENSHOT_COUNT=$(find artifacts/test-screenshots -type f -name "*.png" | wc -l)
                echo "üì∏ Screenshots: $SCREENSHOT_COUNT"
              fi
              
              if [ -f "artifacts/extent-report/Extent-report.html" ]; then
                echo "‚úÖ Extent Report: Available"
              fi
              
              echo ""
              echo "View artifacts in the 'Summary' tab of this pipeline run"
            displayName: 'Display Summary'
