# Azure Pipeline for Eptura Engage Android Automation
# Consolidated version with proven emulator startup and comprehensive features

trigger:
  branches:
    include:
      - main
      - master
      - develop
  paths:
    exclude:
      - README.md
      - docs/**

pr:
  branches:
    include:
      - main
      - master
      - develop

# Pipeline variables
variables:
  mavenPOMFile: 'pom.xml'
  jdkVersion: '17'
  appiumVersion: '3.0.0'
  androidSdkVersion: '34'
  testResultsFolder: '$(System.DefaultWorkingDirectory)/target/surefire-reports'
  screenshotsFolder: '$(System.DefaultWorkingDirectory)/target/screenshots'
  extentReportFolder: '$(System.DefaultWorkingDirectory)/target'
  emulatorName: 'test_emulator_playstore'

# Agent pool - Use Microsoft-hosted macOS agents for better Android emulator performance
pool:
  vmImage: 'macOS-13'  # Better emulator stability

stages:
  - stage: Build
    displayName: 'Build Stage'
    jobs:
      - job: MavenBuild
        displayName: 'Build Maven Project'
        steps:
          - task: JavaToolInstaller@0
            displayName: 'Install Java JDK 17'
            inputs:
              versionSpec: '17'
              jdkArchitectureOption: 'x64'
              jdkSourceOption: 'PreInstalled'

          - task: Maven@4
            displayName: 'Maven Clean Compile'
            inputs:
              mavenPomFile: '$(mavenPOMFile)'
              goals: 'clean compile'
              options: '-DskipTests'
              publishJUnitResults: false
              javaHomeOption: 'JDKVersion'
              jdkVersionOption: '$(jdkVersion)'
              mavenVersionOption: 'Default'
              mavenOptions: '-Xmx3072m'

          - task: PublishBuildArtifacts@1
            displayName: 'Publish Build Artifacts'
            inputs:
              PathtoPublish: '$(System.DefaultWorkingDirectory)/target'
              ArtifactName: 'build-output'
              publishLocation: 'Container'

  - stage: Test
    displayName: 'Test Stage'
    dependsOn: Build
    jobs:
      - job: AndroidTests
        displayName: 'Run Android Appium Tests'
        timeoutInMinutes: 120
        steps:
          - task: JavaToolInstaller@0
            displayName: 'Install Java JDK 17'
            inputs:
              versionSpec: '17'
              jdkArchitectureOption: 'x64'
              jdkSourceOption: 'PreInstalled'

          - task: NodeTool@0
            displayName: 'Install Node.js'
            inputs:
              versionSpec: '20.x'

          - bash: |
              echo "üêç Installing Python dependencies..."
              pip3 install --break-system-packages Appium-Python-Client selenium || pip install Appium-Python-Client selenium
              echo "‚úÖ Python dependencies installed"
            displayName: 'Install Python Dependencies'

          - bash: |
              echo "üì± Setting up Android Emulator with PROVEN approach..."
              echo "============================================================================"
              
              # Set environment variables
              export ANDROID_HOME=$ANDROID_SDK_ROOT
              export PATH=$PATH:$ANDROID_HOME/platform-tools:$ANDROID_HOME/emulator
              
              echo "ANDROID_HOME: $ANDROID_HOME"
              
              # Kill any existing emulators or ADB
              $ANDROID_HOME/platform-tools/adb kill-server || true
              pkill -9 qemu-system || true
              pkill -9 emulator || true
              sleep 2
              
              # Accept licenses
              yes | $ANDROID_HOME/cmdline-tools/latest/bin/sdkmanager --licenses || true
              
              # Install required components using sdkmanager
              echo "üì¶ Installing SDK components..."
              $ANDROID_HOME/cmdline-tools/latest/bin/sdkmanager --install \
                "platform-tools" \
                "platforms;android-34" \
                "build-tools;34.0.0" \
                "emulator" \
                "system-images;android-34;google_apis_playstore;x86_64" || {
                echo "‚ö†Ô∏è sdkmanager install had issues, checking what's available..."
              }
              
              # Verify system image is installed
              echo "üîç Checking installed system images..."
              $ANDROID_HOME/cmdline-tools/latest/bin/sdkmanager --list_installed | grep system-images
              
              # Create AVD with minimal configuration
              echo "üì± Creating emulator AVD..."
              echo "no" | $ANDROID_HOME/cmdline-tools/latest/bin/avdmanager create avd \
                --force \
                --name "$(emulatorName)" \
                --package "system-images;android-34;google_apis_playstore;x86_64" \
                --device "pixel_5" \
                --tag "google_apis_playstore" || {
                echo "‚ùå Failed to create AVD"
                exit 1
              }
              
              echo "‚úÖ AVD created successfully"
              $ANDROID_HOME/emulator/emulator -list-avds
              
            displayName: 'Setup Android SDK and AVD'

          - bash: |
              echo "üöÄ Starting Android Emulator with OPTIMIZED settings..."
              echo "============================================================================"
              
              export ANDROID_HOME=$ANDROID_SDK_ROOT
              export PATH=$PATH:$ANDROID_HOME/platform-tools:$ANDROID_HOME/emulator
              
              # Start ADB server
              $ANDROID_HOME/platform-tools/adb start-server
              sleep 2
              
              # Configure emulator for Azure CI
              mkdir -p ~/.android
              cat > ~/.android/advancedFeatures.ini << EOF
              Vulkan = off
              GLDirectMem = on
              GLDMA = on
              EOF
              
              # Start emulator with Azure-optimized flags
              echo "Starting emulator in background..."
              $ANDROID_HOME/emulator/emulator \
                -avd "$(emulatorName)" \
                -no-window \
                -no-audio \
                -no-boot-anim \
                -gpu swiftshader_indirect \
                -no-snapshot \
                -memory 3584 \
                -partition-size 4096 \
                -cores 2 \
                -skin 1080x1920 \
                -camera-back none \
                -camera-front none \
                -qemu -m 3584 \
                > emulator.log 2>&1 &
              
              EMULATOR_PID=$!
              echo "Emulator PID: $EMULATOR_PID"
              
              # Smart boot wait with multiple checks
              echo "‚è≥ Waiting for emulator to boot (max 5 minutes)..."
              
              TIMEOUT=300
              ELAPSED=0
              BOOT_COMPLETE=false
              
              while [ $ELAPSED -lt $TIMEOUT ]; do
                # Check if emulator process is still running
                if ! ps -p $EMULATOR_PID > /dev/null 2>&1; then
                  echo "‚ùå Emulator process died!"
                  tail -50 emulator.log
                  exit 1
                fi
                
                # Check boot completed
                BOOT_STATUS=$($ANDROID_HOME/platform-tools/adb shell getprop sys.boot_completed 2>&1 | tr -d '\r\n')
                
                if [ "$BOOT_STATUS" = "1" ]; then
                  echo "‚úÖ Boot completed!"
                  BOOT_COMPLETE=true
                  break
                fi
                
                # Progress indicator
                if [ $((ELAPSED % 15)) -eq 0 ]; then
                  echo "  Still booting... (${ELAPSED}s / ${TIMEOUT}s)"
                  $ANDROID_HOME/platform-tools/adb devices
                fi
                
                sleep 5
                ELAPSED=$((ELAPSED + 5))
              done
              
              if [ "$BOOT_COMPLETE" = false ]; then
                echo "‚ùå Emulator boot timeout!"
                echo "=== Emulator Log ==="
                tail -100 emulator.log
                echo "=== ADB Devices ==="
                $ANDROID_HOME/platform-tools/adb devices -l
                exit 1
              fi
              
              # Additional stabilization
              echo "‚è≥ Waiting for package manager to be ready..."
              for i in {1..20}; do
                if $ANDROID_HOME/platform-tools/adb shell pm path android > /dev/null 2>&1; then
                  echo "‚úÖ Package manager ready!"
                  break
                fi
                echo "  Checking package manager... ($i/20)"
                sleep 3
              done
              
              # Disable animations for faster test execution
              echo "üé¨ Disabling animations..."
              $ANDROID_HOME/platform-tools/adb shell settings put global window_animation_scale 0
              $ANDROID_HOME/platform-tools/adb shell settings put global transition_animation_scale 0
              $ANDROID_HOME/platform-tools/adb shell settings put global animator_duration_scale 0
              
              # Unlock screen
              $ANDROID_HOME/platform-tools/adb shell input keyevent 82
              
              # Final verification
              echo ""
              echo "‚úÖ EMULATOR READY!"
              echo "============================================================================"
              $ANDROID_HOME/platform-tools/adb devices -l
              echo "Android Version: $($ANDROID_HOME/platform-tools/adb shell getprop ro.build.version.release | tr -d '\r\n')"
              echo "API Level: $($ANDROID_HOME/platform-tools/adb shell getprop ro.build.version.sdk | tr -d '\r\n')"
              
              # Check for Google Play
              if $ANDROID_HOME/platform-tools/adb shell pm list packages | grep -q "com.android.vending"; then
                echo "‚úÖ Google Play Store: AVAILABLE"
              else
                echo "‚ö†Ô∏è  Google Play Store: NOT FOUND"
              fi
              echo "============================================================================"
              
            displayName: 'Start Emulator and Wait for Boot'

          - task: Npm@1
            displayName: 'Install Appium'
            inputs:
              command: 'custom'
              customCommand: 'install -g appium@$(appiumVersion)'

          - bash: |
              appium driver install uiautomator2
              appium driver list --installed
            displayName: 'Install Appium UiAutomator2 Driver'

          - bash: |
              echo "üöÄ Starting Appium Server..."
              mkdir -p logs
              
              pkill -f appium || true
              sleep 2
              
              nohup appium --address 127.0.0.1 --port 4723 --session-override --log-level info > logs/appium.log 2>&1 &
              APPIUM_PID=$!
              echo "Appium PID: $APPIUM_PID"
              
              # Wait for Appium to be ready
              for i in {1..30}; do
                if curl -s http://127.0.0.1:4723/status > /dev/null 2>&1; then
                  echo "‚úÖ Appium server is ready"
                  exit 0
                fi
                echo "Waiting for Appium... ($i/30)"
                sleep 2
              done
              
              echo "‚ùå Appium failed to start"
              cat logs/appium.log
              exit 1
            displayName: 'Start Appium Server'

          - bash: |
              echo "üì≤ Installing Eptura Engage App..."
              export ANDROID_HOME=$ANDROID_SDK_ROOT
              ADB="$ANDROID_HOME/platform-tools/adb"
              PACKAGE_NAME="com.condecosoftware.condeco"
              
              # Check if already installed
              if "$ADB" shell pm list packages | grep -q "$PACKAGE_NAME"; then
                echo "‚úÖ App is already installed!"
                exit 0
              fi
              
              # Method 1: Check for APK in repo
              if [ -f "app/Eptura_Engage.apk" ] || [ -f "Eptura_Engage.apk" ]; then
                APK_PATH=$(find . -name "Eptura_Engage.apk" -o -name "condeco.apk" | head -1)
                echo "‚úÖ Found APK: $APK_PATH"
                "$ADB" install -r "$APK_PATH"
                if [ $? -eq 0 ]; then
                  echo "‚úÖ APK installed successfully!"
                  exit 0
                fi
              fi
              
              # Method 2: Use Python script for Play Store
              if [ -f "src/main/resources/install_from_playstore.py" ]; then
                echo "üì¶ Attempting Play Store installation..."
                
                # Set Python command
                if command -v python3 &> /dev/null; then
                  PYTHON_CMD=python3
                else
                  PYTHON_CMD=python
                fi
                
                $PYTHON_CMD src/main/resources/install_from_playstore.py || {
                  echo "‚ö†Ô∏è Play Store installation had issues but continuing..."
                }
                
                # Verify installation
                if "$ADB" shell pm list packages | grep -q "$PACKAGE_NAME"; then
                  echo "‚úÖ Play Store installation successful!"
                  exit 0
                fi
              fi
              
              echo "‚ùå Could not install app - please provide APK file or configure Play Store credentials"
              exit 1
            displayName: 'Install Eptura Engage App'
            continueOnError: true
            env:
              GOOGLE_EMAIL: $(GOOGLE_EMAIL)
              GOOGLE_PASSWORD: $(GOOGLE_PASSWORD)

          - task: PublishBuildArtifacts@1
            displayName: 'Publish Play Store Screenshots'
            inputs:
              PathtoPublish: '$(System.DefaultWorkingDirectory)/playstore_screenshots'
              ArtifactName: 'playstore-debug-screenshots'
            condition: always()

          - task: DownloadBuildArtifacts@1
            displayName: 'Download Build Artifacts'
            inputs:
              buildType: 'current'
              downloadType: 'single'
              artifactName: 'build-output'
              downloadPath: '$(System.DefaultWorkingDirectory)'

          - task: Maven@4
            displayName: 'Run TestNG Tests'
            inputs:
              mavenPomFile: '$(mavenPOMFile)'
              goals: 'test'
              options: '-Dtestng.xml=testng.xml'
              publishJUnitResults: true
              testResultsFiles: '**/surefire-reports/TEST-*.xml'
              testRunTitle: 'Eptura Engage Android Tests'
              javaHomeOption: 'JDKVersion'
              jdkVersionOption: '$(jdkVersion)'
              mavenVersionOption: 'Default'
              mavenOptions: '-Xmx3072m'
            env:
              USE_EXTERNAL_APPIUM: 'true'
              APPIUM_SERVER_URL: 'http://127.0.0.1:4723'
            continueOnError: true

          # Cleanup
          - bash: |
              pkill -f appium || true
              export ANDROID_HOME=$ANDROID_SDK_ROOT
              $ANDROID_HOME/platform-tools/adb emu kill || true
              pkill -9 qemu-system || true
              pkill -9 emulator || true
            displayName: 'Cleanup'
            condition: always()

          # Publish artifacts
          - task: PublishTestResults@2
            displayName: 'Publish Test Results'
            inputs:
              testResultsFormat: 'JUnit'
              testResultsFiles: '**/surefire-reports/TEST-*.xml'
              mergeTestResults: true
              failTaskOnFailedTests: false
              testRunTitle: 'Eptura Android Tests'
            condition: always()

          - task: PublishBuildArtifacts@1
            displayName: 'Publish Screenshots'
            inputs:
              PathtoPublish: '$(screenshotsFolder)'
              ArtifactName: 'test-screenshots'
            condition: always()

          - task: PublishBuildArtifacts@1
            displayName: 'Publish Extent Report'
            inputs:
              PathtoPublish: '$(extentReportFolder)/Extent-report.html'
              ArtifactName: 'extent-report'
            condition: always()

          - task: PublishBuildArtifacts@1
            displayName: 'Publish Logs'
            inputs:
              PathtoPublish: '$(System.DefaultWorkingDirectory)/logs'
              ArtifactName: 'appium-logs'
            condition: always()

          - bash: |
              if [ -f emulator.log ]; then
                mkdir -p logs
                cp emulator.log logs/
              fi
            displayName: 'Collect Emulator Logs'
            condition: always()

          - task: PublishBuildArtifacts@1
            displayName: 'Publish Emulator Logs'
            inputs:
              PathtoPublish: '$(System.DefaultWorkingDirectory)/logs'
              ArtifactName: 'emulator-logs'
            condition: always()

  - stage: Report
    displayName: 'Test Reports'
    dependsOn: Test
    condition: always()
    jobs:
      - job: Summary
        displayName: 'Test Summary'
        steps:
          - task: DownloadBuildArtifacts@1
            inputs:
              buildType: 'current'
              downloadType: 'specific'
              itemPattern: '**'
              downloadPath: '$(System.DefaultWorkingDirectory)/artifacts'

          - bash: |
              echo "üìä Test Execution Summary"
              echo "=========================="
              if [ -d "artifacts/test-screenshots" ]; then
                SCREENSHOT_COUNT=$(find artifacts/test-screenshots -type f -name "*.png" | wc -l)
                echo "üì∏ Screenshots: $SCREENSHOT_COUNT"
              fi
              
              if [ -f "artifacts/extent-report/Extent-report.html" ]; then
                echo "‚úÖ Extent Report: Available"
              fi
              
              echo ""
              echo "View artifacts in the 'Summary' tab of this pipeline run"
            displayName: 'Display Summary'
