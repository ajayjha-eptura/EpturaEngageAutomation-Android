# Azure DevOps Pipeline for Eptura Engage Android Automation
# This pipeline downloads APK from Azure Blob Storage and runs automated tests

trigger:
  branches:
    include:
      - main
      - master
      - develop
  paths:
    exclude:
      - README.md
      - docs/*

pr:
  branches:
    include:
      - main
      - master
      - develop

pool:
  vmImage: 'ubuntu-latest'

variables:
  MAVEN_CACHE_FOLDER: $(Pipeline.Workspace)/.m2/repository
  MAVEN_OPTS: '-Dmaven.repo.local=$(MAVEN_CACHE_FOLDER)'
  ANDROID_HOME: $(Agent.ToolsDirectory)/android-sdk
  APPIUM_VERSION: '3.0.0'
  # Azure Blob Storage variables
  AZURE_STORAGE_ACCOUNT: 'entstorage'
  AZURE_STORAGE_CONTAINER: 'mobilebuilds'
  # AZURE_SAS_TOKEN: Configure this as a SECRET variable in Azure DevOps Pipeline Variables
  APK_BLOB_NAME: 'Engage/Android/EpturaEngage.apk'
  APK_LOCAL_PATH: '$(Build.SourcesDirectory)/app.apk'

stages:
  - stage: Setup
    displayName: 'Setup Environment'
    jobs:
      - job: SetupAndroidSDK
        displayName: 'Setup Android SDK and Appium'
        steps:
          - task: JavaToolInstaller@0
            displayName: 'Install Java 11'
            inputs:
              versionSpec: '11'
              jdkArchitectureOption: 'x64'
              jdkSourceOption: 'PreInstalled'

          - script: |
              mkdir -p $(MAVEN_CACHE_FOLDER)
            displayName: 'Create Maven Cache Directory'

          - task: Cache@2
            displayName: 'Cache Maven Dependencies'
            inputs:
              key: 'maven | "$(Agent.OS)" | **/pom.xml'
              restoreKeys: |
                maven | "$(Agent.OS)"
                maven
              path: $(MAVEN_CACHE_FOLDER)

          - script: |
              set -e
              echo "ðŸ“¦ Installing Android SDK..."
              mkdir -p $(ANDROID_HOME)
              cd $(ANDROID_HOME)
              wget -q https://dl.google.com/android/repository/commandlinetools-linux-9477386_latest.zip
              unzip -q commandlinetools-linux-9477386_latest.zip
              mkdir -p cmdline-tools/latest
              mv cmdline-tools/* cmdline-tools/latest/ 2>/dev/null || true
              export PATH=$(ANDROID_HOME)/cmdline-tools/latest/bin:$PATH
              yes | sdkmanager --licenses || true
              sdkmanager "platform-tools" "platforms;android-30" "emulator" "build-tools;30.0.3"
              echo "âœ… Android SDK installed"
            displayName: 'Install Android SDK'

          - script: |
              set -e
              echo "ðŸ“± Installing Appium..."
              sudo npm install -g appium@$(APPIUM_VERSION)
              appium driver install uiautomator2
              appium -v
              echo "âœ… Appium installed successfully"
            displayName: 'Install Appium'

  - stage: DownloadAPK
    displayName: 'Download APK from Azure Blob'
    dependsOn: Setup
    jobs:
      - job: DownloadFromBlob
        displayName: 'Download APK'
        steps:
          - script: |
              echo "ðŸ“¥ Downloading APK from Azure Blob Storage using SAS Token..."
            displayName: 'Prepare Download'

          - task: PythonScript@0
            displayName: 'Download APK from Blob Storage'
            inputs:
              scriptSource: 'filePath'
              scriptPath: '$(Build.SourcesDirectory)/scripts/download_apk_from_blob.py'
            env:
              AZURE_STORAGE_ACCOUNT: $(AZURE_STORAGE_ACCOUNT)
              AZURE_STORAGE_CONTAINER: $(AZURE_STORAGE_CONTAINER)
              AZURE_SAS_TOKEN: $(AZURE_SAS_TOKEN)
              APK_BLOB_NAME: $(APK_BLOB_NAME)
              APK_LOCAL_PATH: $(APK_LOCAL_PATH)

          - task: PublishPipelineArtifact@1
            displayName: 'Publish APK Artifact'
            inputs:
              targetPath: '$(APK_LOCAL_PATH)'
              artifact: 'AndroidAPK'
              publishLocation: 'pipeline'

  - stage: Build
    displayName: 'Build Test Project'
    dependsOn: DownloadAPK
    jobs:
      - job: MavenBuild
        displayName: 'Maven Compile'
        steps:
          - task: JavaToolInstaller@0
            displayName: 'Install Java 11'
            inputs:
              versionSpec: '11'
              jdkArchitectureOption: 'x64'
              jdkSourceOption: 'PreInstalled'

          - script: |
              mkdir -p $(MAVEN_CACHE_FOLDER)
            displayName: 'Create Maven Cache Directory'

          - task: Cache@2
            displayName: 'Cache Maven Dependencies'
            inputs:
              key: 'maven | "$(Agent.OS)" | **/pom.xml'
              restoreKeys: |
                maven | "$(Agent.OS)"
                maven
              path: $(MAVEN_CACHE_FOLDER)

          - task: Maven@3
            displayName: 'Maven Clean Compile'
            inputs:
              mavenPomFile: 'pom.xml'
              goals: 'clean compile'
              options: '-DskipTests $(MAVEN_OPTS)'
              publishJUnitResults: false
              javaHomeOption: 'JDKVersion'
              jdkVersionOption: '1.11'
              mavenVersionOption: 'Default'

  - stage: Test
    displayName: 'Run Automation Tests'
    dependsOn: Build
    jobs:
      - job: RunTests
        displayName: 'Execute TestNG Suite'
        timeoutInMinutes: 120
        steps:
          - task: JavaToolInstaller@0
            displayName: 'Install Java 11'
            inputs:
              versionSpec: '11'
              jdkArchitectureOption: 'x64'
              jdkSourceOption: 'PreInstalled'

          - task: DownloadPipelineArtifact@2
            displayName: 'Download APK Artifact'
            inputs:
              artifactName: 'AndroidAPK'
              targetPath: '$(Build.SourcesDirectory)'

          - script: |
              set -e
              echo "ðŸ“¦ Installing Android SDK..."
              mkdir -p $(ANDROID_HOME)
              cd $(ANDROID_HOME)
              wget -q https://dl.google.com/android/repository/commandlinetools-linux-9477386_latest.zip
              unzip -q commandlinetools-linux-9477386_latest.zip
              mkdir -p cmdline-tools/latest
              mv cmdline-tools/* cmdline-tools/latest/ 2>/dev/null || true
              export PATH=$(ANDROID_HOME)/cmdline-tools/latest/bin:$(ANDROID_HOME)/platform-tools:$(ANDROID_HOME)/emulator:$PATH
              yes | sdkmanager --licenses || true
              sdkmanager "platform-tools" "platforms;android-30" "emulator" "build-tools;30.0.3"
              echo "âœ… Android SDK installed"
            displayName: 'Install Android SDK'

          - script: |
              set -e
              echo "ðŸ”§ Setting up environment..."
              export PATH=$(ANDROID_HOME)/cmdline-tools/latest/bin:$(ANDROID_HOME)/platform-tools:$(ANDROID_HOME)/emulator:$PATH
              export ANDROID_HOME=$(ANDROID_HOME)
              export ANDROID_SDK_ROOT=$(ANDROID_HOME)
              
              # Install Appium
              sudo npm install -g appium@$(APPIUM_VERSION)
              appium driver install uiautomator2
              
              # Start Appium server
              echo "ðŸš€ Starting Appium server..."
              appium --address 127.0.0.1 --port 4723 --session-override > appium.log 2>&1 &
              sleep 10
              
              echo "âœ… Appium server started"
            displayName: 'Setup Test Environment'

          - task: Maven@3
            displayName: 'Run Tests'
            inputs:
              mavenPomFile: 'pom.xml'
              goals: 'test'
              options: '-Dtestng.xml=testng.xml $(MAVEN_OPTS)'
              publishJUnitResults: true
              testResultsFiles: '**/surefire-reports/TEST-*.xml'
              testRunTitle: 'Eptura Engage Android Tests'
              javaHomeOption: 'JDKVersion'
              jdkVersionOption: '1.11'
              mavenVersionOption: 'Default'
            env:
              ANDROID_HOME: $(ANDROID_HOME)
              ANDROID_SDK_ROOT: $(ANDROID_HOME)
            continueOnError: true