# Azure DevOps Pipeline for Eptura Engage Android Automation
# This pipeline downloads APK from Azure Blob Storage and runs automated tests

trigger:
  branches:
    include:
      - main
      - master
      - develop
  paths:
    exclude:
      - README.md
      - docs/*

pr:
  branches:
    include:
      - main
      - master
      - develop

pool:
  vmImage: 'ubuntu-latest'

variables:
  MAVEN_CACHE_FOLDER: $(Pipeline.Workspace)/.m2/repository
  MAVEN_OPTS: '-Dmaven.repo.local=$(MAVEN_CACHE_FOLDER)'
  ANDROID_HOME: $(Agent.ToolsDirectory)/android-sdk
  APPIUM_VERSION: '3.0.0'
  # Azure Blob Storage variables
  AZURE_STORAGE_ACCOUNT: 'entstorage'
  AZURE_STORAGE_CONTAINER: 'mobilebuilds'
  # AZURE_SAS_TOKEN: Configure this as a SECRET variable in Azure DevOps Pipeline Variables
  APK_BLOB_NAME: 'Engage/Android/EpturaEngage.apk'
  APK_LOCAL_PATH: '$(Build.SourcesDirectory)/EpturaEngage.apk'
  # Emulator Configuration - API 36 with custom resolution
  EMULATOR_API_LEVEL: '36'
  EMULATOR_SYSTEM_IMAGE: 'system-images;android-36;google_apis_playstore;x86_64'
  EMULATOR_RESOLUTION_WIDTH: '1080'
  EMULATOR_RESOLUTION_HEIGHT: '2400'
  EMULATOR_DENSITY: '420'
  EMULATOR_RAM: '4096'
  EMULATOR_CORES: '4'

stages:
  - stage: Setup
    displayName: 'Setup Environment'
    jobs:
      - job: SetupAndroidSDK
        displayName: 'Setup Android SDK and Appium'
        steps:
          - task: JavaToolInstaller@0
            displayName: 'Install Java 11'
            inputs:
              versionSpec: '11'
              jdkArchitectureOption: 'x64'
              jdkSourceOption: 'PreInstalled'

          - script: |
              mkdir -p $(MAVEN_CACHE_FOLDER)
            displayName: 'Create Maven Cache Directory'

          - task: Cache@2
            displayName: 'Cache Maven Dependencies'
            inputs:
              key: 'maven | "$(Agent.OS)" | **/pom.xml'
              restoreKeys: |
                maven | "$(Agent.OS)"
                maven
              path: $(MAVEN_CACHE_FOLDER)

          - script: |
              set -e
              echo "üì¶ Installing Android SDK..."
              mkdir -p $(ANDROID_HOME)
              cd $(ANDROID_HOME)
              wget -q https://dl.google.com/android/repository/commandlinetools-linux-9477386_latest.zip
              unzip -q commandlinetools-linux-9477386_latest.zip
              mkdir -p cmdline-tools/latest
              mv cmdline-tools/* cmdline-tools/latest/ 2>/dev/null || true
              export PATH=$(ANDROID_HOME)/cmdline-tools/latest/bin:$(ANDROID_HOME)/platform-tools:$(ANDROID_HOME)/emulator:$PATH
              yes | sdkmanager --licenses || true
              # Install API 36 with Play Store image (non-rooted, x86_64)
              echo "üì¶ Installing Android API $(EMULATOR_API_LEVEL) system image..."
              sdkmanager "platform-tools" "platforms;android-$(EMULATOR_API_LEVEL)" "emulator" "build-tools;$(EMULATOR_API_LEVEL).0.0" "$(EMULATOR_SYSTEM_IMAGE)"
              echo "‚úÖ Android SDK installed with API $(EMULATOR_API_LEVEL)"
            displayName: 'Install Android SDK'

          - script: |
              set -e
              echo "üì± Installing Appium..."
              sudo npm install -g appium@$(APPIUM_VERSION)
              appium driver install uiautomator2
              appium -v
              echo "‚úÖ Appium installed successfully"
            displayName: 'Install Appium'

  - stage: DownloadAPK
    displayName: 'Download APK from Azure Blob'
    dependsOn: Setup
    jobs:
      - job: DownloadFromBlob
        displayName: 'Download APK'
        steps:
          - script: |
              echo "üì• Downloading APK from Azure Blob Storage using SAS Token..."
            displayName: 'Prepare Download'

          - task: PythonScript@0
            displayName: 'Download APK from Blob Storage'
            inputs:
              scriptSource: 'filePath'
              scriptPath: '$(Build.SourcesDirectory)/scripts/download_apk_from_blob.py'
            env:
              AZURE_STORAGE_ACCOUNT: $(AZURE_STORAGE_ACCOUNT)
              AZURE_STORAGE_CONTAINER: $(AZURE_STORAGE_CONTAINER)
              AZURE_SAS_TOKEN: $(AZURE_SAS_TOKEN)
              APK_BLOB_NAME: $(APK_BLOB_NAME)
              APK_LOCAL_PATH: $(APK_LOCAL_PATH)

          - task: PublishPipelineArtifact@1
            displayName: 'Publish APK Artifact'
            inputs:
              targetPath: '$(APK_LOCAL_PATH)'
              artifact: 'AndroidAPK'
              publishLocation: 'pipeline'

  - stage: Build
    displayName: 'Build Test Project'
    dependsOn: DownloadAPK
    jobs:
      - job: MavenBuild
        displayName: 'Maven Compile'
        steps:
          - task: JavaToolInstaller@0
            displayName: 'Install Java 11'
            inputs:
              versionSpec: '11'
              jdkArchitectureOption: 'x64'
              jdkSourceOption: 'PreInstalled'

          - script: |
              mkdir -p $(MAVEN_CACHE_FOLDER)
            displayName: 'Create Maven Cache Directory'

          - task: Cache@2
            displayName: 'Cache Maven Dependencies'
            inputs:
              key: 'maven | "$(Agent.OS)" | **/pom.xml'
              restoreKeys: |
                maven | "$(Agent.OS)"
                maven
              path: $(MAVEN_CACHE_FOLDER)

          - task: Maven@3
            displayName: 'Maven Clean Compile'
            inputs:
              mavenPomFile: 'pom.xml'
              goals: 'clean compile'
              options: '-DskipTests $(MAVEN_OPTS)'
              publishJUnitResults: false
              javaHomeOption: 'JDKVersion'
              jdkVersionOption: '1.11'
              mavenVersionOption: 'Default'

  - stage: Test
    displayName: 'Run Automation Tests'
    dependsOn: Build
    jobs:
      - job: RunTests
        displayName: 'Execute TestNG Suite'
        timeoutInMinutes: 120
        steps:
          - task: JavaToolInstaller@0
            displayName: 'Install Java 11'
            inputs:
              versionSpec: '11'
              jdkArchitectureOption: 'x64'
              jdkSourceOption: 'PreInstalled'

          - task: DownloadPipelineArtifact@2
            displayName: 'Download APK Artifact'
            inputs:
              artifactName: 'AndroidAPK'
              targetPath: '$(Build.SourcesDirectory)'

          - script: |
              set -e
              echo "üì¶ Installing Android SDK with API $(EMULATOR_API_LEVEL)..."
              mkdir -p $(ANDROID_HOME)
              cd $(ANDROID_HOME)
              wget -q https://dl.google.com/android/repository/commandlinetools-linux-9477386_latest.zip
              unzip -q commandlinetools-linux-9477386_latest.zip
              mkdir -p cmdline-tools/latest
              mv cmdline-tools/* cmdline-tools/latest/ 2>/dev/null || true
              export PATH=$(ANDROID_HOME)/cmdline-tools/latest/bin:$(ANDROID_HOME)/platform-tools:$(ANDROID_HOME)/emulator:$PATH
              yes | sdkmanager --licenses || true
              # Install API 36 with Play Store image (non-rooted, x86_64)
              echo "üì¶ Installing Android API $(EMULATOR_API_LEVEL) system image (x86_64)..."
              sdkmanager "platform-tools" "platforms;android-$(EMULATOR_API_LEVEL)" "emulator" "build-tools;$(EMULATOR_API_LEVEL).0.0" "$(EMULATOR_SYSTEM_IMAGE)"
              echo "‚úÖ Android SDK installed with API $(EMULATOR_API_LEVEL)"
            displayName: 'Install Android SDK'

          - script: |
              set -e
              echo "üì± Creating Android Emulator with API $(EMULATOR_API_LEVEL)..."
              echo "   Resolution: $(EMULATOR_RESOLUTION_WIDTH)x$(EMULATOR_RESOLUTION_HEIGHT)"
              echo "   Density: $(EMULATOR_DENSITY) dpi"
              echo "   RAM: $(EMULATOR_RAM) MB"
              echo "   CPU Cores: $(EMULATOR_CORES)"
              
              export PATH=$(ANDROID_HOME)/cmdline-tools/latest/bin:$(ANDROID_HOME)/platform-tools:$(ANDROID_HOME)/emulator:$PATH
              export ANDROID_HOME=$(ANDROID_HOME)
              export ANDROID_SDK_ROOT=$(ANDROID_HOME)
              
              # Create AVD using API 36 Play Store image (non-rooted, x86_64)
              echo "no" | avdmanager create avd -n test_emulator -k "$(EMULATOR_SYSTEM_IMAGE)" -d pixel_6 --force
              
              # Configure AVD with exact screen settings matching the requirements
              AVD_DIR="$HOME/.android/avd/test_emulator.avd"
              if [ -f "$AVD_DIR/config.ini" ]; then
                echo "üìù Configuring AVD with custom screen settings..."
                
                # Screen configuration - 1080x2400 @ 420dpi (412x915 dp)
                echo "hw.lcd.density=$(EMULATOR_DENSITY)" >> "$AVD_DIR/config.ini"
                echo "hw.lcd.width=$(EMULATOR_RESOLUTION_WIDTH)" >> "$AVD_DIR/config.ini"
                echo "hw.lcd.height=$(EMULATOR_RESOLUTION_HEIGHT)" >> "$AVD_DIR/config.ini"
                
                # Performance settings - Increased RAM and CPU
                echo "hw.ramSize=$(EMULATOR_RAM)" >> "$AVD_DIR/config.ini"
                echo "hw.cpu.ncore=$(EMULATOR_CORES)" >> "$AVD_DIR/config.ini"
                echo "vm.heapSize=576" >> "$AVD_DIR/config.ini"
                
                # Hardware acceleration and GPU
                echo "hw.gpu.enabled=yes" >> "$AVD_DIR/config.ini"
                echo "hw.gpu.mode=swiftshader_indirect" >> "$AVD_DIR/config.ini"
                
                # Keyboard and input
                echo "hw.keyboard=yes" >> "$AVD_DIR/config.ini"
                echo "hw.mainKeys=no" >> "$AVD_DIR/config.ini"
                
                # Additional optimizations for CI
                echo "disk.dataPartition.size=4096M" >> "$AVD_DIR/config.ini"
                echo "fastboot.forceColdBoot=no" >> "$AVD_DIR/config.ini"
                echo "fastboot.forceFastBoot=yes" >> "$AVD_DIR/config.ini"
                
                echo "‚úÖ AVD configuration updated"
                echo "üìã AVD Config contents:"
                cat "$AVD_DIR/config.ini"
              fi
              
              echo "‚úÖ Android Emulator created with API $(EMULATOR_API_LEVEL)"
              echo "   Resolution: $(EMULATOR_RESOLUTION_WIDTH)x$(EMULATOR_RESOLUTION_HEIGHT) (412x915 dp)"
              echo "   Density: $(EMULATOR_DENSITY) dpi"
              echo "   ABI: x86_64"
            displayName: 'Create Android Emulator (API 36)'

          - script: |
              set -e
              echo "üöÄ Starting Android Emulator (API $(EMULATOR_API_LEVEL))..."
              echo "   RAM: $(EMULATOR_RAM) MB | CPU Cores: $(EMULATOR_CORES)"
              
              export PATH=$(ANDROID_HOME)/cmdline-tools/latest/bin:$(ANDROID_HOME)/platform-tools:$(ANDROID_HOME)/emulator:$PATH
              export ANDROID_HOME=$(ANDROID_HOME)
              export ANDROID_SDK_ROOT=$(ANDROID_HOME)
              
              # Enable KVM for hardware acceleration (if available)
              sudo apt-get update -qq
              sudo apt-get install -y -qq cpu-checker qemu-kvm libvirt-daemon-system
              sudo adduser $USER kvm 2>/dev/null || true
              sudo chown $USER /dev/kvm 2>/dev/null || true
              
              # Check if KVM is available
              KVM_AVAILABLE=false
              if [ -e /dev/kvm ] && [ -r /dev/kvm ] && [ -w /dev/kvm ]; then
                echo "‚úÖ KVM is available - hardware acceleration enabled"
                KVM_AVAILABLE=true
                ACCEL_FLAG="-accel on"
              else
                echo "‚ö†Ô∏è KVM not available, using software rendering (slower)"
                ACCEL_FLAG="-accel off"
              fi
              
              # Kill any existing emulator or adb processes
              pkill -9 emulator || true
              pkill -9 qemu || true
              adb kill-server || true
              sleep 2
              adb start-server
              
              # Start emulator with optimized settings for CI
              # Using increased memory and cores as specified
              echo "üöÄ Launching emulator with enhanced resources..."
              nohup $(ANDROID_HOME)/emulator/emulator \
                -avd test_emulator \
                -no-window \
                -no-audio \
                -no-boot-anim \
                -gpu swiftshader_indirect \
                $ACCEL_FLAG \
                -memory $(EMULATOR_RAM) \
                -cores $(EMULATOR_CORES) \
                -netfast \
                -skip-adb-auth \
                -no-snapshot \
                -no-snapshot-load \
                -no-snapshot-save \
                -wipe-data \
                -skin $(EMULATOR_RESOLUTION_WIDTH)x$(EMULATOR_RESOLUTION_HEIGHT) \
                -verbose \
                > emulator.log 2>&1 &
              
              EMULATOR_PID=$!
              echo "Emulator PID: $EMULATOR_PID"
              echo "Emulator Config: API $(EMULATOR_API_LEVEL), $(EMULATOR_RESOLUTION_WIDTH)x$(EMULATOR_RESOLUTION_HEIGHT), $(EMULATOR_DENSITY)dpi, $(EMULATOR_RAM)MB RAM, $(EMULATOR_CORES) cores"
              
              # Wait for emulator to boot with proper timeout
              echo "‚è≥ Waiting for emulator device..."
              
              # Wait for device with timeout (90 seconds for API 36)
              DEVICE_TIMEOUT=90
              DEVICE_COUNTER=0
              while [ $DEVICE_COUNTER -lt $DEVICE_TIMEOUT ]; do
                if adb devices | grep -q "emulator"; then
                  echo "‚úÖ Emulator device detected"
                  break
                fi
                
                # Check if emulator process is still running
                if ! ps -p $EMULATOR_PID > /dev/null 2>&1; then
                  echo "‚ùå Emulator process died unexpectedly"
                  echo "=== Emulator Log ==="
                  cat emulator.log || true
                  exit 1
                fi
                
                DEVICE_COUNTER=$((DEVICE_COUNTER + 5))
                echo "Waiting for device... ($DEVICE_COUNTER/$DEVICE_TIMEOUT seconds)"
                sleep 5
              done
              
              if [ $DEVICE_COUNTER -ge $DEVICE_TIMEOUT ]; then
                echo "‚ùå Timeout waiting for emulator device"
                echo "=== Emulator Log ==="
                cat emulator.log || true
                exit 1
              fi
              
              # Wait for boot completion with timeout (240 seconds for API 36 - it's larger)
              echo "‚è≥ Waiting for boot completion (API 36 may take longer)..."
              BOOT_TIMEOUT=240
              BOOT_COUNTER=0
              while [ $BOOT_COUNTER -lt $BOOT_TIMEOUT ]; do
                BOOT_COMPLETED=$(adb -e shell getprop sys.boot_completed 2>/dev/null | tr -d '\r\n' || echo "")
                
                if [ "$BOOT_COMPLETED" = "1" ]; then
                  echo "‚úÖ Boot completed!"
                  break
                fi
                
                # Check if emulator process is still running
                if ! ps -p $EMULATOR_PID > /dev/null 2>&1; then
                  echo "‚ùå Emulator process died during boot"
                  echo "=== Emulator Log ==="
                  cat emulator.log || true
                  exit 1
                fi
                
                BOOT_COUNTER=$((BOOT_COUNTER + 10))
                echo "Waiting for boot... ($BOOT_COUNTER/$BOOT_TIMEOUT seconds) - boot_completed='$BOOT_COMPLETED'"
                sleep 10
              done
              
              if [ $BOOT_COUNTER -ge $BOOT_TIMEOUT ]; then
                echo "‚ùå Emulator failed to boot within timeout"
                echo "=== Last 100 lines of Emulator Log ==="
                tail -100 emulator.log || true
                echo "=== ADB Devices ==="
                adb devices -l || true
                exit 1
              fi
              
              # Additional wait for system UI to be ready (longer for API 36)
              echo "‚è≥ Waiting for system UI to be ready..."
              sleep 20
              
              # Disable animations for faster test execution
              adb -e shell settings put global window_animation_scale 0
              adb -e shell settings put global transition_animation_scale 0
              adb -e shell settings put global animator_duration_scale 0
              
              # Unlock screen
              adb -e shell input keyevent 82
              
              # Verify emulator properties
              echo "üì± Emulator Properties:"
              echo "   API Level: $(adb -e shell getprop ro.build.version.sdk)"
              echo "   Screen Density: $(adb -e shell wm density)"
              echo "   Screen Size: $(adb -e shell wm size)"
              
              echo "‚úÖ Android Emulator (API $(EMULATOR_API_LEVEL)) started and booted successfully"
              adb devices -l
            displayName: 'Start Android Emulator'
            timeoutInMinutes: 15

          - script: |
              set -e
              echo "üîß Setting up Appium..."
              export PATH=$(ANDROID_HOME)/cmdline-tools/latest/bin:$(ANDROID_HOME)/platform-tools:$(ANDROID_HOME)/emulator:$PATH
              export ANDROID_HOME=$(ANDROID_HOME)
              export ANDROID_SDK_ROOT=$(ANDROID_HOME)
              
              # Install Appium
              sudo npm install -g appium@$(APPIUM_VERSION)
              appium driver install uiautomator2
              
              # Start Appium server
              echo "üöÄ Starting Appium server..."
              nohup appium --address 127.0.0.1 --port 4723 --session-override --relaxed-security > appium.log 2>&1 &
              sleep 10
              
              # Verify Appium is running
              if curl -s http://127.0.0.1:4723/status | grep -q "ready"; then
                echo "‚úÖ Appium server started successfully"
              else
                echo "‚ö†Ô∏è Appium server may not be ready, continuing..."
              fi
            displayName: 'Setup Appium'

          - script: |
              set -e
              echo "üì≤ Installing APK from Azure Blob Storage on emulator..."
              export PATH=$(ANDROID_HOME)/platform-tools:$PATH
              
              # Create screenshots directory for installation process
              SCREENSHOTS_DIR="$(Build.SourcesDirectory)/installation-screenshots"
              mkdir -p $SCREENSHOTS_DIR
              
              # Wait a bit more for emulator to be fully ready
              sleep 10
              
              # Capture screenshot before installation
              echo "üì∏ Capturing pre-installation screenshot..."
              adb shell screencap -p /sdcard/pre_install.png
              adb pull /sdcard/pre_install.png "$SCREENSHOTS_DIR/01_pre_installation_$(date +%Y%m%d_%H%M%S).png" || echo "Failed to capture pre-install screenshot"
              
              echo "üîç Searching for APK file downloaded from blob storage..."
              echo "Contents of Build.SourcesDirectory:"
              ls -la $(Build.SourcesDirectory)/
              
              # Try to find the APK file - it could be named EpturaEngage.apk or EpturaEngage.apk
              APK_FILE=""
              
              # Check for EpturaEngage.apk (the expected name from blob download)
              if [ -f "$(Build.SourcesDirectory)/EpturaEngage.apk" ]; then
                APK_FILE="$(Build.SourcesDirectory)/EpturaEngage.apk"
                echo "‚úÖ Found APK at: $APK_FILE"
              # Check for any .apk file in the source directory
              elif [ -n "$(find $(Build.SourcesDirectory) -maxdepth 1 -name '*.apk' -type f 2>/dev/null | head -1)" ]; then
                APK_FILE=$(find $(Build.SourcesDirectory) -maxdepth 1 -name '*.apk' -type f | head -1)
                echo "‚úÖ Found APK at: $APK_FILE"
              # Check recursively for any .apk file
              elif [ -n "$(find $(Build.SourcesDirectory) -name '*.apk' -type f 2>/dev/null | head -1)" ]; then
                APK_FILE=$(find $(Build.SourcesDirectory) -name '*.apk' -type f | head -1)
                echo "‚úÖ Found APK at: $APK_FILE"
              fi
              
              if [ -n "$APK_FILE" ] && [ -f "$APK_FILE" ]; then
                echo "üì± APK file details:"
                ls -la "$APK_FILE"
                echo "üì≤ Installing APK on emulator..."
                adb install -r "$APK_FILE"
                
                # Capture screenshot after installation
                echo "üì∏ Capturing post-installation screenshot..."
                sleep 3
                adb shell screencap -p /sdcard/post_install.png
                adb pull /sdcard/post_install.png "$SCREENSHOTS_DIR/02_post_installation_$(date +%Y%m%d_%H%M%S).png" || echo "Failed to capture post-install screenshot"
                
                # Verify the app is installed
                if adb shell pm list packages | grep -q "com.condecosoftware.condeco"; then
                  echo "‚úÖ APK from blob storage installed and verified successfully!"
                  
                  # Launch the app and capture screenshot
                  echo "üöÄ Launching app for verification..."
                  adb shell monkey -p com.condecosoftware.condeco -c android.intent.category.LAUNCHER 1
                  sleep 5
                  
                  # Capture screenshot of app launch
                  echo "üì∏ Capturing app launch screenshot..."
                  adb shell screencap -p /sdcard/app_launch.png
                  adb pull /sdcard/app_launch.png "$SCREENSHOTS_DIR/03_app_launch_$(date +%Y%m%d_%H%M%S).png" || echo "Failed to capture app launch screenshot"
                  
                  # Wait for app to fully load and capture another screenshot
                  sleep 5
                  adb shell screencap -p /sdcard/app_loaded.png
                  adb pull /sdcard/app_loaded.png "$SCREENSHOTS_DIR/04_app_loaded_$(date +%Y%m%d_%H%M%S).png" || echo "Failed to capture app loaded screenshot"
                else
                  echo "‚ö†Ô∏è APK installed but package verification failed. Continuing anyway..."
                  # Capture screenshot showing installed packages
                  adb shell screencap -p /sdcard/packages_list.png
                  adb pull /sdcard/packages_list.png "$SCREENSHOTS_DIR/05_package_verification_failed_$(date +%Y%m%d_%H%M%S).png" || echo "Failed to capture packages screenshot"
                fi
              else
                echo "‚ùå ERROR: No APK file found from blob storage!"
                echo "üìÅ Full directory listing:"
                find $(Build.SourcesDirectory) -type f -name "*.apk" 2>/dev/null || echo "No APK files found"
                echo "üìÅ All files in source directory:"
                find $(Build.SourcesDirectory) -type f | head -50
                
                # Capture screenshot of error state
                adb shell screencap -p /sdcard/error_state.png
                adb pull /sdcard/error_state.png "$SCREENSHOTS_DIR/00_error_no_apk_found_$(date +%Y%m%d_%H%M%S).png" || echo "Failed to capture error screenshot"
                exit 1
              fi
              
              echo "üì∏ Installation screenshots saved to: $SCREENSHOTS_DIR"
              ls -la "$SCREENSHOTS_DIR"
            displayName: 'Install APK on Emulator with Screenshots'

          - task: Maven@3
            displayName: 'Run Tests'
            inputs:
              mavenPomFile: 'pom.xml'
              goals: 'test'
              options: '-Dtestng.xml=testng.xml -DdeviceName=emulator-5554 $(MAVEN_OPTS)'
              publishJUnitResults: true
              testResultsFiles: '**/surefire-reports/TEST-*.xml'
              testRunTitle: 'Eptura Engage Android Tests'
              javaHomeOption: 'JDKVersion'
              jdkVersionOption: '1.11'
              mavenVersionOption: 'Default'
            env:
              ANDROID_HOME: $(ANDROID_HOME)
              ANDROID_SDK_ROOT: $(ANDROID_HOME)
            continueOnError: true

          - script: |
              set -e
              echo "üì∏ Capturing final emulator state screenshot..."
              export PATH=$(ANDROID_HOME)/platform-tools:$PATH
              
              SCREENSHOTS_DIR="$(Build.SourcesDirectory)/installation-screenshots"
              mkdir -p $SCREENSHOTS_DIR
              
              # Capture final state of emulator after tests
              adb shell screencap -p /sdcard/final_state.png
              adb pull /sdcard/final_state.png "$SCREENSHOTS_DIR/99_final_state_after_tests_$(date +%Y%m%d_%H%M%S).png" || echo "Failed to capture final state screenshot"
              
              echo "üì∏ Final screenshot captured"
            displayName: 'Capture Final Emulator State'
            condition: always()

          - script: |
              echo "üìä Collecting test execution reports and screenshots..."
              
              # Create reports directory
              REPORTS_DIR="$(Build.SourcesDirectory)/test-reports"
              mkdir -p $REPORTS_DIR
              
              # Ensure screenshots directory exists for artifact publishing
              SCREENSHOTS_DIR="$(Build.SourcesDirectory)/target/screenshots"
              mkdir -p $SCREENSHOTS_DIR
              
              # If no screenshots exist, create a placeholder file to ensure artifact publishing doesn't fail
              if [ -z "$(ls -A $SCREENSHOTS_DIR 2>/dev/null)" ]; then
                echo "No test screenshots were captured during this run." > "$SCREENSHOTS_DIR/README.txt"
                echo "Screenshots are captured after each test case (passed or failed)." >> "$SCREENSHOTS_DIR/README.txt"
                echo "Timestamp: $(date)" >> "$SCREENSHOTS_DIR/README.txt"
              fi
              
              # Count and list screenshots
              SCREENSHOT_COUNT=$(find $SCREENSHOTS_DIR -name "*.png" 2>/dev/null | wc -l)
              echo "üì∏ Found $SCREENSHOT_COUNT test screenshots"
              
              if [ "$SCREENSHOT_COUNT" -gt 0 ]; then
                echo ""
                echo "üì∏ Test Screenshots Summary:"
                echo "================================"
                PASSED_COUNT=$(find $SCREENSHOTS_DIR -name "Passed_*.png" 2>/dev/null | wc -l)
                FAILED_COUNT=$(find $SCREENSHOTS_DIR -name "Failed_*.png" 2>/dev/null | wc -l)
                echo "‚úÖ PASSED Test Screenshots: $PASSED_COUNT"
                ls -la $SCREENSHOTS_DIR/Passed_*.png 2>/dev/null | head -20 || true
                echo ""
                echo "‚ùå FAILED Test Screenshots: $FAILED_COUNT"
                ls -la $SCREENSHOTS_DIR/Failed_*.png 2>/dev/null | head -20 || true
                echo "================================"
              fi
              
              # Copy surefire reports
              if [ -d "$(Build.SourcesDirectory)/target/surefire-reports" ]; then
                cp -r $(Build.SourcesDirectory)/target/surefire-reports $REPORTS_DIR/
                echo "‚úÖ Surefire reports copied"
              fi
              
              # Copy TestNG output
              if [ -d "$(Build.SourcesDirectory)/test-output" ]; then
                cp -r $(Build.SourcesDirectory)/test-output $REPORTS_DIR/testng-output
                echo "‚úÖ TestNG output copied"
              fi
              
              # Copy Extent report if exists
              if [ -f "$(Build.SourcesDirectory)/target/Extent-report.html" ]; then
                cp $(Build.SourcesDirectory)/target/Extent-report.html $REPORTS_DIR/
                echo "‚úÖ Extent report copied"
              fi
              
              # Copy cucumber reports if exists
              if [ -d "$(Build.SourcesDirectory)/target/cucumber-report" ]; then
                cp -r $(Build.SourcesDirectory)/target/cucumber-report $REPORTS_DIR/
                echo "‚úÖ Cucumber reports copied"
              fi
              
              # Copy generated HTML report if exists
              if [ -d "$(Build.SourcesDirectory)/target/generated-report" ]; then
                cp -r $(Build.SourcesDirectory)/target/generated-report $REPORTS_DIR/
                echo "‚úÖ Generated HTML report copied"
              fi
              
              # Copy test screenshots from target
              if [ -d "$(Build.SourcesDirectory)/target/screenshots" ]; then
                cp -r $(Build.SourcesDirectory)/target/screenshots $REPORTS_DIR/test-screenshots
                echo "‚úÖ Test screenshots copied"
              fi
              
              # Copy Appium and Emulator logs
              if [ -f "$(Build.SourcesDirectory)/appium.log" ]; then
                cp $(Build.SourcesDirectory)/appium.log $REPORTS_DIR/
                echo "‚úÖ Appium log copied"
              fi
              
              if [ -f "$(Build.SourcesDirectory)/emulator.log" ]; then
                cp $(Build.SourcesDirectory)/emulator.log $REPORTS_DIR/
                echo "‚úÖ Emulator log copied"
              fi
              
              echo "üìÅ Reports directory contents:"
              find $REPORTS_DIR -type f | head -100
            displayName: 'Collect Test Reports and Screenshots'
            condition: always()

          - task: PublishPipelineArtifact@1
            displayName: 'Publish Installation Screenshots'
            inputs:
              targetPath: '$(Build.SourcesDirectory)/installation-screenshots'
              artifact: 'InstallationScreenshots'
              publishLocation: 'pipeline'
            condition: always()

          - task: PublishPipelineArtifact@1
            displayName: 'Publish Test Reports'
            inputs:
              targetPath: '$(Build.SourcesDirectory)/test-reports'
              artifact: 'TestExecutionReports'
              publishLocation: 'pipeline'
            condition: always()

          - task: PublishPipelineArtifact@1
            displayName: 'Publish Test Screenshots'
            inputs:
              targetPath: '$(Build.SourcesDirectory)/target/screenshots'
              artifact: 'TestScreenshots'
              publishLocation: 'pipeline'
            condition: always()

          - task: PublishTestResults@2
            displayName: 'Publish TestNG Results'
            inputs:
              testResultsFormat: 'JUnit'
              testResultsFiles: '**/surefire-reports/TEST-*.xml'
              testRunTitle: 'Eptura Engage Android Test Results'
              mergeTestResults: true
              failTaskOnFailedTests: false
            condition: always()