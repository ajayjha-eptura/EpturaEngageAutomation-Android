# Azure Pipeline for Eptura Engage Android Automation
# This pipeline creates an emulator with Google Play Store and installs app from Play Store

trigger:
  branches:
    include:
      - main
      - master
      - develop
  paths:
    exclude:
      - README.md
      - docs/**

pr:
  branches:
    include:
      - main
      - master
      - develop

# Pipeline variables
variables:
  mavenPOMFile: 'pom.xml'
  jdkVersion: '17'
  appiumVersion: '3.0.0'
  androidSdkVersion: '35'
  testResultsFolder: '$(System.DefaultWorkingDirectory)/target/surefire-reports'
  screenshotsFolder: '$(System.DefaultWorkingDirectory)/target/screenshots'
  extentReportFolder: '$(System.DefaultWorkingDirectory)/target'
  emulatorName: 'test_emulator_playstore'

# Agent pool - Use Microsoft-hosted Windows agents for better Android emulator performance
pool:
  vmImage: 'windows-2022'

stages:
  - stage: Build
    displayName: 'Build Stage'
    jobs:
      - job: MavenBuild
        displayName: 'Build Maven Project'
        steps:
          - task: JavaToolInstaller@0
            displayName: 'Install Java JDK 17'
            inputs:
              versionSpec: '17'
              jdkArchitectureOption: 'x64'
              jdkSourceOption: 'PreInstalled'

          - task: Maven@4
            displayName: 'Maven Clean Compile'
            inputs:
              mavenPomFile: '$(mavenPOMFile)'
              goals: 'clean compile'
              options: '-DskipTests'
              publishJUnitResults: false
              javaHomeOption: 'JDKVersion'
              jdkVersionOption: '$(jdkVersion)'
              mavenVersionOption: 'Default'
              mavenOptions: '-Xmx3072m'

          - task: PublishBuildArtifacts@1
            displayName: 'Publish Build Artifacts'
            inputs:
              PathtoPublish: '$(System.DefaultWorkingDirectory)/target'
              ArtifactName: 'build-output'
              publishLocation: 'Container'

  - stage: Test
    displayName: 'Test Stage'
    dependsOn: Build
    jobs:
      - job: AndroidTests
        displayName: 'Run Android Appium Tests'
        timeoutInMinutes: 120
        steps:
          - task: JavaToolInstaller@0
            displayName: 'Install Java JDK 17'
            inputs:
              versionSpec: '17'
              jdkArchitectureOption: 'x64'
              jdkSourceOption: 'PreInstalled'

          - task: NodeTool@0
            displayName: 'Install Node.js'
            inputs:
              versionSpec: '20.x'

          - bash: |
              echo "ðŸ Installing Python dependencies for Play Store installer..."
              
              # Windows uses 'python' and 'pip', not 'python3' and 'pip3'
              if command -v python3 &> /dev/null; then
                PYTHON_CMD=python3
                PIP_CMD=pip3
              else
                PYTHON_CMD=python
                PIP_CMD=pip
              fi
              
              echo "Using Python command: $PYTHON_CMD"
              $PYTHON_CMD --version
              $PIP_CMD --version
              
              # Install Appium Python client and dependencies
              # Note: --break-system-packages is for macOS/Linux only, Windows doesn't need it
              echo "Installing Appium-Python-Client..."
              if [[ "$OSTYPE" == "msys" ]] || [[ "$OSTYPE" == "win32" ]] || [[ "$OS" == "Windows_NT" ]]; then
                # Windows installation
                $PIP_CMD install --upgrade pip || echo "âš ï¸  Pip upgrade skipped (not critical)"
                $PIP_CMD install Appium-Python-Client || { echo "âŒ Failed to install Appium-Python-Client"; exit 1; }
                $PIP_CMD install selenium || { echo "âŒ Failed to install selenium"; exit 1; }
              else
                # macOS/Linux installation
                $PIP_CMD install --upgrade pip --break-system-packages || echo "âš ï¸  Pip upgrade skipped (not critical)"
                $PIP_CMD install Appium-Python-Client --break-system-packages || { echo "âŒ Failed to install Appium-Python-Client"; exit 1; }
                $PIP_CMD install selenium --break-system-packages || { echo "âŒ Failed to install selenium"; exit 1; }
              fi
              
              echo "âœ… Python dependencies installed"
              $PIP_CMD list | grep -i appium || echo "Appium package verification"
            displayName: 'Install Python Dependencies'

          - bash: |
              echo "ðŸ“± Configuring Android SDK with Google Play support..."
              
              # Set Android environment variables
              export ANDROID_HOME=$ANDROID_SDK_ROOT
              export PATH=$PATH:$ANDROID_HOME/platform-tools:$ANDROID_HOME/emulator
              
              echo "ANDROID_HOME: $ANDROID_HOME"
              echo "ANDROID_SDK_ROOT: $ANDROID_SDK_ROOT"
              
              # Verify Android SDK exists
              if [ ! -d "$ANDROID_HOME" ]; then
                echo "âŒ ANDROID_HOME directory not found: $ANDROID_HOME"
                exit 1
              fi
              
              echo "ðŸ“‹ Android SDK structure:"
              ls -la $ANDROID_HOME/ || true
              
              # Find sdkmanager - Windows uses .bat extension
              echo "ðŸ” Searching for sdkmanager..."
              SDKMANAGER=""
              
              # Check common locations for Windows (.bat files) and Unix
              if [ -f "$ANDROID_HOME/cmdline-tools/latest/bin/sdkmanager.bat" ]; then
                SDKMANAGER="$ANDROID_HOME/cmdline-tools/latest/bin/sdkmanager.bat"
                export PATH=$PATH:$ANDROID_HOME/cmdline-tools/latest/bin
                echo "âœ… Found sdkmanager at: $SDKMANAGER"
              elif [ -f "$ANDROID_HOME/cmdline-tools/latest/bin/sdkmanager" ]; then
                SDKMANAGER="$ANDROID_HOME/cmdline-tools/latest/bin/sdkmanager"
                export PATH=$PATH:$ANDROID_HOME/cmdline-tools/latest/bin
                echo "âœ… Found sdkmanager at: $SDKMANAGER"
              elif [ -f "$ANDROID_HOME/cmdline-tools/bin/sdkmanager.bat" ]; then
                SDKMANAGER="$ANDROID_HOME/cmdline-tools/bin/sdkmanager.bat"
                export PATH=$PATH:$ANDROID_HOME/cmdline-tools/bin
                echo "âœ… Found sdkmanager at: $SDKMANAGER"
              elif [ -f "$ANDROID_HOME/cmdline-tools/bin/sdkmanager" ]; then
                SDKMANAGER="$ANDROID_HOME/cmdline-tools/bin/sdkmanager"
                export PATH=$PATH:$ANDROID_HOME/cmdline-tools/bin
                echo "âœ… Found sdkmanager at: $SDKMANAGER"
              else
                # Search for both .bat and regular versions
                echo "Searching in cmdline-tools directory..."
                find "$ANDROID_HOME/cmdline-tools" -name "sdkmanager.bat" -o -name "sdkmanager" -type f 2>/dev/null || true
                
                FOUND_SDKMANAGER=$(find "$ANDROID_HOME/cmdline-tools" \( -name "sdkmanager.bat" -o -name "sdkmanager" \) -type f 2>/dev/null | head -1)
                if [ -n "$FOUND_SDKMANAGER" ]; then
                  SDKMANAGER="$FOUND_SDKMANAGER"
                  SDKMANAGER_DIR=$(dirname "$FOUND_SDKMANAGER")
                  export PATH=$PATH:$SDKMANAGER_DIR
                  echo "âœ… Found sdkmanager at: $SDKMANAGER"
                else
                  echo "âŒ sdkmanager not found in cmdline-tools"
                  echo "Available cmdline-tools structure:"
                  ls -laR "$ANDROID_HOME/cmdline-tools" 2>/dev/null || echo "cmdline-tools directory not found"
                  exit 1
                fi
              fi
              
              # Test sdkmanager works
              echo "Testing sdkmanager..."
              "$SDKMANAGER" --version || {
                echo "âŒ sdkmanager test failed"
                exit 1
              }
              
              # Accept all licenses - use a more robust method
              echo "ðŸ“ Accepting Android SDK licenses..."
              # Create licenses directory if it doesn't exist
              mkdir -p "$ANDROID_HOME/licenses"
              
              # Accept all known Android SDK licenses by creating license files
              # These are the current license hashes as of 2024
              echo "24333f8a63b6825ea9c5514f83c2829b004d1fee" > "$ANDROID_HOME/licenses/android-sdk-license"
              echo "84831b9409646a918e30573bab4c9c91346d8abd" > "$ANDROID_HOME/licenses/android-sdk-preview-license"
              echo "d975f751698a77b662f1254ddbeed3901e976f5a" > "$ANDROID_HOME/licenses/intel-android-extra-license"
              echo "33b6a2b64607f11b759f320ef9dff4ae5c47d97a" > "$ANDROID_HOME/licenses/google-gdk-license"
              echo "e9acab5b5fbb560a72cfaecce8946896ff6aab9d" > "$ANDROID_HOME/licenses/mips-android-sysimage-license"
              echo "d56a98520377fecf01c9e79e689e9ba188a4558e" > "$ANDROID_HOME/licenses/android-googletv-license"
              echo "667f5ef1d0d6dbb3c1bb1dbe94f0c0c66f8c3ee5" > "$ANDROID_HOME/licenses/android-googlexr-license"
              
              # Accept the ARM DBT license with all known hashes
              echo "e6b7c2ab7fa2298c15165e9583d0acf0b04a2232" > "$ANDROID_HOME/licenses/android-sdk-arm-dbt-license"
              echo "d56a98520377fecf01c9e79e689e9ba188a4558e" >> "$ANDROID_HOME/licenses/android-sdk-arm-dbt-license"
              
              echo "âœ… License files created successfully"
              
              # Verify licenses directory
              echo "ðŸ“‹ Licenses directory contents:"
              ls -la "$ANDROID_HOME/licenses/" || echo "Licenses directory not found"
              cat "$ANDROID_HOME/licenses/android-sdk-arm-dbt-license" 2>/dev/null && echo "ARM DBT license hashes verified"
              
              # Update SDK manager
              echo "ðŸ”„ Updating SDK manager..."
              "$SDKMANAGER" --update --sdk_root=$ANDROID_HOME || true
              
              # Install SDK components with Google Play Store support
              # Use 'yes' to automatically accept any interactive prompts
              echo "ðŸ“¦ Installing SDK components with Google Play Store..."
              echo "This may take a few minutes..."
              
              yes | "$SDKMANAGER" \
                --sdk_root=$ANDROID_HOME \
                --verbose \
                "platform-tools" \
                "platforms;android-35" \
                "build-tools;35.0.3" \
                "emulator" \
                "system-images;android-35;google_apis_playstore;x86_64" 2>&1 | grep -v "^Info:" | grep -v "^Warning:" || {
                echo "âŒ Failed to install SDK components"
                echo ""
                echo "Checking what went wrong..."
                echo "Attempting to list available packages:"
                "$SDKMANAGER" --list --sdk_root=$ANDROID_HOME 2>&1 | head -50 || true
                echo ""
                echo "Checking licenses directory:"
                ls -la "$ANDROID_HOME/licenses/"
                exit 1
              }
              
              echo "âœ… SDK components installation completed"
              
              # Wait for installation to complete and verify
              sleep 5
              
              # Verify system image was installed
              echo "ðŸ” Verifying system image installation..."
              echo "Checking path: $ANDROID_HOME/system-images/android-35/google_apis_playstore/x86_64"
              
              if [ -d "$ANDROID_HOME/system-images/android-35/google_apis_playstore/x86_64" ]; then
                echo "âœ… Google Play system image found!"
                ls -la "$ANDROID_HOME/system-images/android-35/google_apis_playstore/x86_64"
              else
                echo "âŒ System image not found after installation!"
                echo ""
                echo "Contents of system-images directory:"
                if [ -d "$ANDROID_HOME/system-images" ]; then
                  find $ANDROID_HOME/system-images -type d -maxdepth 3
                else
                  echo "âš ï¸  system-images directory does not exist at: $ANDROID_HOME/system-images"
                fi
                echo ""
                echo "ðŸ“‹ List of installed packages:"
                "$SDKMANAGER" --list_installed --sdk_root=$ANDROID_HOME
                exit 1
              fi
              
              # Verify ADB
              echo "ðŸ”§ Verifying ADB..."
              adb version
              
              # Find avdmanager - Windows uses .bat extension
              echo "ðŸ” Searching for avdmanager..."
              AVDMANAGER=""
              if [ -f "$ANDROID_HOME/cmdline-tools/latest/bin/avdmanager.bat" ]; then
                AVDMANAGER="$ANDROID_HOME/cmdline-tools/latest/bin/avdmanager.bat"
              elif [ -f "$ANDROID_HOME/cmdline-tools/latest/bin/avdmanager" ]; then
                AVDMANAGER="$ANDROID_HOME/cmdline-tools/latest/bin/avdmanager"
              elif [ -f "$ANDROID_HOME/cmdline-tools/bin/avdmanager.bat" ]; then
                AVDMANAGER="$ANDROID_HOME/cmdline-tools/bin/avdmanager.bat"
              elif [ -f "$ANDROID_HOME/cmdline-tools/bin/avdmanager" ]; then
                AVDMANAGER="$ANDROID_HOME/cmdline-tools/bin/avdmanager"
              else
                FOUND_AVDMANAGER=$(find "$ANDROID_HOME/cmdline-tools" \( -name "avdmanager.bat" -o -name "avdmanager" \) -type f 2>/dev/null | head -1)
                if [ -n "$FOUND_AVDMANAGER" ]; then
                  AVDMANAGER="$FOUND_AVDMANAGER"
                else
                  echo "âŒ avdmanager not found"
                  exit 1
                fi
              fi
              echo "âœ… Found avdmanager at: $AVDMANAGER"
              
              # List all installed system images
              echo "ðŸ“‹ Installed system images:"
              "$SDKMANAGER" --list_installed --sdk_root=$ANDROID_HOME | grep system-images || echo "No system images found in installed list"
              
              echo ""
              echo "ðŸ“± Creating Android Emulator with Google Play Store..."
              
              # Delete existing emulator if present
              "$AVDMANAGER" delete avd -n $(emulatorName) 2>/dev/null || true
              
              # Create new emulator with Google Play
              echo "Creating emulator with Google Play Store support..."
              echo "no" | "$AVDMANAGER" create avd \
                --force \
                --name "$(emulatorName)" \
                --package "system-images;android-35;google_apis_playstore;x86_64" \
                --device "pixel_4" \
                --abi x86_64 || {
                echo "âŒ Failed to create emulator"
                echo "Available packages:"
                "$AVDMANAGER" list target
                exit 1
              }
              
              # Verify emulator was created
              echo "ðŸ” Verifying emulator creation..."
              $ANDROID_HOME/emulator/emulator -list-avds
              
              if $ANDROID_HOME/emulator/emulator -list-avds | grep -q "$(emulatorName)"; then
                echo "âœ… Emulator '$(emulatorName)' created successfully"
              else
                echo "âŒ Failed to create emulator"
                echo "Available AVDs:"
                $ANDROID_HOME/emulator/emulator -list-avds
                exit 1
              fi
              
              # Start emulator with optimized settings
              echo "ðŸš€ Starting emulator with optimized settings..."
              nohup $ANDROID_HOME/emulator/emulator -avd $(emulatorName) \
                -no-snapshot-save \
                -no-window \
                -no-audio \
                -no-boot-anim \
                -gpu swiftshader_indirect \
                -memory 4096 \
                -cores 2 \
                -accel on \
                -wipe-data \
                > emulator.log 2>&1 &
              
              EMULATOR_PID=$!
              echo "Emulator PID: $EMULATOR_PID"
              echo "##vso[task.setvariable variable=EMULATOR_PID]$EMULATOR_PID"
              
              # Wait for device to be detected
              echo "â³ Waiting for emulator device to be detected..."
              
              # Use timeout to prevent hanging indefinitely
              WAIT_COUNT=0
              MAX_WAIT=60
              until adb devices | grep -q "emulator.*device"; do
                if [ $WAIT_COUNT -ge $MAX_WAIT ]; then
                  echo "âŒ Emulator device not detected after $MAX_WAIT seconds"
                  echo "Checking emulator process:"
                  # Cross-platform process check
                  if [[ "$OSTYPE" == "msys" ]] || [[ "$OS" == "Windows_NT" ]]; then
                    tasklist | grep -i emulator || echo "Emulator process not found"
                  else
                    ps aux | grep emulator | grep -v grep || echo "Emulator process not found"
                  fi
                  exit 1
                fi
                sleep 1
                WAIT_COUNT=$((WAIT_COUNT + 1))
                if [ $((WAIT_COUNT % 10)) -eq 0 ]; then
                  echo "  Still waiting for device... ($WAIT_COUNT/$MAX_WAIT seconds)"
                fi
              done
              
              echo "âœ… Device detected"
              
              # Wait for boot completion with reasonable timeout
              echo "â³ Waiting for boot_completed flag..."
              timeout=180
              elapsed=0
              until [[ "$(adb shell getprop sys.boot_completed 2>/dev/null | tr -d '\r')" == "1" ]]; do
                if [ $elapsed -ge $timeout ]; then
                  echo "âŒ Boot timeout after $timeout seconds"
                  echo "=== Emulator Log (last 100 lines) ==="
                  tail -100 emulator.log
                  exit 1
                fi
                sleep 5
                elapsed=$((elapsed+5))
                if [ $((elapsed % 15)) -eq 0 ]; then
                  echo "  Still booting... ($elapsed/$timeout seconds)"
                fi
              done
              
              echo "âœ… Boot completed flag set!"
              
              # Optimized service readiness check with faster polling
              echo "â³ Waiting for Android system services (max 30 seconds)..."
              
              service_ready=false
              max_wait=30
              elapsed=0
              
              while [ $elapsed -lt $max_wait ]; do
                # Check all services in one go
                pm_ready=false
                am_ready=false
                
                if adb shell pm list packages >/dev/null 2>&1; then
                  pm_ready=true
                fi
                
                if adb shell am get-config >/dev/null 2>&1; then
                  am_ready=true
                fi
                
                if [ "$pm_ready" = true ] && [ "$am_ready" = true ]; then
                  echo "âœ… All critical services are ready!"
                  service_ready=true
                  break
                fi
                
                sleep 3
                elapsed=$((elapsed+3))
                
                if [ $((elapsed % 15)) -eq 0 ]; then
                  echo "  Still initializing services... ($elapsed/$max_wait seconds)"
                  echo "    - Package Manager: $([ "$pm_ready" = true ] && echo "âœ…" || echo "â³")"
                  echo "    - Activity Manager: $([ "$am_ready" = true ] && echo "âœ…" || echo "â³")"
                fi
              done
              
              if [ "$service_ready" = false ]; then
                echo "âš ï¸  Services not ready after $max_wait seconds, but continuing..."
                echo "Attempting to check emulator state:"
                adb shell getprop sys.boot_completed
                adb shell pm list packages | head -5
              fi
              
              # Reduced stability wait
              echo "â³ Allowing system to stabilize (30 seconds)..."
              sleep 30
              
              echo "âœ… Emulator should now be ready"
              
              # Final verification
              echo "ðŸ” Final system verification..."
              
              # Verify ADB connection is stable
              echo "â³ Verifying ADB shell connection..."
              adb_shell_ready=false
              for attempt in {1..5}; do
                echo "  Attempt $attempt/5: Testing ADB shell..."
                if timeout 5 adb shell echo "test" > /dev/null 2>&1; then
                  echo "âœ… ADB shell connection established (attempt $attempt)"
                  adb_shell_ready=true
                  break
                fi
                echo "  â³ ADB shell not ready, waiting 3 seconds..."
                sleep 3
              done
              
              if [ "$adb_shell_ready" = false ]; then
                echo "âš ï¸  ADB shell not responding after 15 seconds"
                echo "This may indicate emulator instability, but continuing..."
              fi
              
              # Verify package manager
              echo "ðŸ” Verifying package manager..."
              pm_verified=false
              for i in {1..3}; do
                echo "  Attempt $i/3: Checking package manager..."
                if adb shell pm list packages > /dev/null 2>&1; then
                  pm_verified=true
                  echo "âœ… Package manager verified"
                  break
                fi
                echo "  Retry $i/3 for package manager..."
                sleep 5
              done
              
              if [ "$pm_verified" = false ]; then
                echo "âš ï¸  Package manager not responding reliably"
                echo "âš ï¸  Continuing anyway - tests may fail if package manager is not ready"
              fi
              
              # Verify emulator is ready
              echo ""
              echo "ðŸ“± Emulator status:"
              adb devices -l
              
              # Try to get Android version with retry
              android_version="unknown"
              for i in {1..3}; do
                android_version=$(adb shell getprop ro.build.version.release 2>/dev/null | tr -d '\r\n')
                if [ -n "$android_version" ]; then
                  break
                fi
                sleep 3
              done
              echo "Android version: $android_version"
              
              # Try to get API level with retry
              api_level="unknown"
              for i in {1..3}; do
                api_level=$(adb shell getprop ro.build.version.sdk 2>/dev/null | tr -d '\r\n')
                if [ -n "$api_level" ]; then
                  break
                fi
                sleep 3
              done
              echo "API Level: $api_level"
              
              # Check for Google Play Store
              echo ""
              echo "ðŸ” Checking for Google Play Store..."
              play_store_found=false
              for i in {1..3}; do
                if adb shell pm list packages 2>/dev/null | grep -q "com.android.vending"; then
                  play_store_found=true
                  echo "âœ… Google Play Store is present!"
                  PLAY_STORE_VERSION=$(adb shell dumpsys package com.android.vending 2>/dev/null | grep versionName | head -1 | awk '{print $1}' || echo "version unknown")
                  echo "Play Store: $PLAY_STORE_VERSION"
                  break
                fi
                echo "  Attempt $i/3: Play Store not detected yet, waiting..."
                sleep 10
              done
              
              if [ "$play_store_found" = false ]; then
                echo "âš ï¸  Google Play Store not found after multiple checks"
                echo "ðŸ“‹ Checking Google services packages:"
                adb shell pm list packages 2>/dev/null | grep -i google | head -10 || echo "Could not list packages"
              fi
              
              # Get emulator serial
              EMULATOR_SERIAL=$(adb devices | grep "emulator" | head -1 | awk '{print $1}')
              echo ""
              echo "Emulator Serial: $EMULATOR_SERIAL"
              echo "##vso[task.setvariable variable=EMULATOR_SERIAL]$EMULATOR_SERIAL"
              
              echo ""
              echo "âœ… Android emulator setup complete!"
              echo "Note: If emulator is not fully responsive, tests may fail. Check emulator logs for details."
            displayName: 'Setup Android SDK and Create Emulator with Google Play'

          - task: Npm@1
            displayName: 'Install Appium'
            inputs:
              command: 'custom'
              customCommand: 'install -g appium@$(appiumVersion)'

          - bash: |
              echo "ðŸ”Œ Installing Appium UiAutomator2 Driver..."
              appium driver install uiautomator2
              appium driver list --installed
              echo "âœ… Driver installed"
            displayName: 'Install Appium Driver'

          - bash: |
              echo "ðŸš€ Starting Appium Server..."
              mkdir -p logs
              
              # Clean up any existing Appium processes - cross-platform
              echo "Checking for existing Appium processes..."
              if [[ "$OSTYPE" == "msys" ]] || [[ "$OS" == "Windows_NT" ]]; then
                # Windows: kill node.exe processes on port 4723
                echo "Windows detected - cleaning up processes on port 4723..."
                netstat -ano | findstr :4723 | awk '{print $5}' | xargs -r taskkill //F //PID 2>/dev/null || true
              else
                # Unix: use pkill
                pkill -f appium || true
              fi
              sleep 2
              
              # Start Appium
              nohup appium --address 127.0.0.1 --port 4723 --session-override --log-level info > logs/appium.log 2>&1 &
              APPIUM_PID=$!
              echo "Appium PID: $APPIUM_PID"
              echo "##vso[task.setvariable variable=APPIUM_PID]$APPIUM_PID"
              
              # Wait for Appium to be ready
              for i in {1..30}; do
                if curl -s http://127.0.0.1:4723/status > /dev/null 2>&1; then
                  echo "âœ… Appium server is ready"
                  exit 0
                fi
                echo "Waiting... ($i/30)"
                sleep 2
              done
              
              echo "âŒ Appium failed to start"
              cat logs/appium.log
              exit 1
            displayName: 'Start Appium Server'

          - bash: |
              echo "ðŸ“² Installing Eptura Engage App using Python automation script..."
              echo "======================================================="
              
              # Define package name
              PACKAGE_NAME="com.condecosoftware.condeco"
              
              # Check if app is already installed
              if adb shell pm list packages | grep -q "$PACKAGE_NAME"; then
                echo "âœ… App is already installed!"
                APP_INFO=$(adb shell dumpsys package $PACKAGE_NAME | grep -E "versionName|versionCode" | head -2)
                echo "App info:"
                echo "$APP_INFO"
                exit 0
              fi
              
              echo "ðŸ“¦ Method 1: Attempting direct APK installation..."
              echo ""
              
              # Check if APK file is provided in the repo
              if [ -f "app/Eptura_Engage.apk" ] || [ -f "Eptura_Engage.apk" ]; then
                APK_PATH=$(find . -name "Eptura_Engage.apk" -o -name "condeco.apk" | head -1)
                echo "âœ… Found APK file: $APK_PATH"
                echo "ðŸ“¥ Installing APK..."
                
                adb install -r "$APK_PATH"
                
                if [ $? -eq 0 ]; then
                  echo "âœ… APK installed successfully!"
                  exit 0
                else
                  echo "âš ï¸  APK installation failed, trying alternative methods..."
                fi
              else
                echo "â„¹ï¸  No APK file found in repository"
              fi
              
              echo ""
              echo "ðŸ“¦ Method 2: Using Python automation script for Play Store installation..."
              echo ""
              
              # Set Python command based on OS
              if command -v python3 &> /dev/null; then
                PYTHON_CMD=python3
              else
                PYTHON_CMD=python
              fi
              
              echo "Using Python: $PYTHON_CMD"
              $PYTHON_CMD --version
              
              # Check if Python script exists
              SCRIPT_PATH="src/main/resources/install_from_playstore.py"
              if [ ! -f "$SCRIPT_PATH" ]; then
                echo "âŒ Python script not found at: $SCRIPT_PATH"
                echo "âš ï¸  Please ensure install_from_playstore.py exists in the repository"
                exit 1
              fi
              
              echo "âœ… Found Python script: $SCRIPT_PATH"
              echo ""
              
              # Get Google credentials from environment variables or Azure Key Vault
              # NOTE: These should be stored as secure pipeline variables
              GOOGLE_EMAIL="${GOOGLE_EMAIL:-}"
              GOOGLE_PASSWORD="${GOOGLE_PASSWORD:-}"
              
              if [ -z "$GOOGLE_EMAIL" ] || [ -z "$GOOGLE_PASSWORD" ]; then
                echo "âš ï¸  WARNING: Google credentials not provided"
                echo "â„¹ï¸  The Python script will attempt deep-link installation (no login required)"
                echo "â„¹ï¸  To enable full automation, set GOOGLE_EMAIL and GOOGLE_PASSWORD as pipeline variables"
                echo ""
              else
                echo "âœ… Google credentials found (masked for security)"
                echo "ðŸ“§ Email: ${GOOGLE_EMAIL:0:2}***@***"
              fi
              
              # Run the Python automation script
              echo "ðŸš€ Starting automated Play Store installation..."
              echo "=================================================="
              
              if [ -n "$GOOGLE_EMAIL" ] && [ -n "$GOOGLE_PASSWORD" ]; then
                # Run with credentials for full automation
                $PYTHON_CMD "$SCRIPT_PATH" "$GOOGLE_EMAIL" "$GOOGLE_PASSWORD" "Eptura Engage"
                INSTALL_RESULT=$?
              else
                # Run without credentials - will use deep link method only
                export GOOGLE_EMAIL=""
                export GOOGLE_PASSWORD=""
                $PYTHON_CMD "$SCRIPT_PATH"
                INSTALL_RESULT=$?
              fi
              
              echo ""
              echo "=================================================="
              
              if [ $INSTALL_RESULT -eq 0 ]; then
                echo "âœ… Play Store installation completed successfully!"
                
                # Verify installation
                if adb shell pm list packages | grep -q "$PACKAGE_NAME"; then
                  echo "âœ… App package verified: $PACKAGE_NAME"
                  APP_INFO=$(adb shell dumpsys package $PACKAGE_NAME | grep -E "versionName|versionCode" | head -2)
                  echo "App details:"
                  echo "$APP_INFO"
                  exit 0
                else
                  echo "âš ï¸  App package not found after installation"
                  exit 1
                fi
              else
                echo "âŒ Play Store installation failed"
                echo ""
                echo "ðŸ’¡ TROUBLESHOOTING:"
                echo "   1. Ensure Google Play Store is working on the emulator"
                echo "   2. Check if Appium server is running properly"
                echo "   3. Verify emulator has internet connectivity"
                echo "   4. Consider adding the APK file directly to the repository"
                echo ""
                exit 1
              fi
            displayName: 'Install Eptura Engage App'
            env:
              GOOGLE_EMAIL: $(GOOGLE_EMAIL)
              GOOGLE_PASSWORD: $(GOOGLE_PASSWORD)

          - task: PublishBuildArtifacts@1
            displayName: 'Publish Play Store Screenshots'
            inputs:
              PathtoPublish: '$(System.DefaultWorkingDirectory)/playstore_screenshots'
              ArtifactName: 'playstore-debug-screenshots'
            condition: always()

          - task: DownloadBuildArtifacts@1
            displayName: 'Download Build Artifacts'
            inputs:
              buildType: 'current'
              downloadType: 'single'
              artifactName: 'build-output'
              downloadPath: '$(System.DefaultWorkingDirectory)'

          - task: Maven@4
            displayName: 'Run TestNG Tests'
            inputs:
              mavenPomFile: '$(mavenPOMFile)'
              goals: 'test'
              options: '-Dtestng.xml=testng.xml'
              publishJUnitResults: true
              testResultsFiles: '**/surefire-reports/TEST-*.xml'
              testRunTitle: 'Eptura Engage Android Tests'
              javaHomeOption: 'JDKVersion'
              jdkVersionOption: '$(jdkVersion)'
              mavenVersionOption: 'Default'
              mavenOptions: '-Xmx3072m'
            env:
              USE_EXTERNAL_APPIUM: 'true'
              APPIUM_SERVER_URL: 'http://127.0.0.1:4723'
            continueOnError: true

          - bash: |
              echo "ðŸ§¹ Cleanup: Stopping Appium Server..."
              # Cross-platform cleanup
              if [[ "$OSTYPE" == "msys" ]] || [[ "$OS" == "Windows_NT" ]]; then
                # Windows: kill processes on port 4723
                netstat -ano | findstr :4723 | awk '{print $5}' | xargs -r taskkill //F //PID 2>/dev/null || true
              else
                # Unix: use pkill
                pkill -f appium || true
              fi
            displayName: 'Stop Appium Server'
            condition: always()

          - bash: |
              echo "ðŸ§¹ Cleanup: Stopping Emulator..."
              adb emu kill || true
              
              # Cross-platform emulator cleanup
              if [[ "$OSTYPE" == "msys" ]] || [[ "$OS" == "Windows_NT" ]]; then
                # Windows: kill emulator processes
                tasklist | grep -i "qemu-system\|emulator" | awk '{print $2}' | xargs -r taskkill //F //PID 2>/dev/null || true
              else
                # Unix: use pkill
                pkill -f "emulator.*$(emulatorName)" || true
              fi
              sleep 5
            displayName: 'Stop Emulator'
            condition: always()

          - task: PublishTestResults@2
            displayName: 'Publish Test Results'
            inputs:
              testResultsFormat: 'JUnit'
              testResultsFiles: '**/surefire-reports/TEST-*.xml'
              mergeTestResults: true
              failTaskOnFailedTests: false
              testRunTitle: 'Eptura Android Tests'
            condition: always()

          - task: PublishBuildArtifacts@1
            displayName: 'Publish Screenshots'
            inputs:
              PathtoPublish: '$(screenshotsFolder)'
              ArtifactName: 'test-screenshots'
            condition: always()

          - task: PublishBuildArtifacts@1
            displayName: 'Publish Extent Report'
            inputs:
              PathtoPublish: '$(extentReportFolder)/Extent-report.html'
              ArtifactName: 'extent-report'
            condition: always()

          - task: PublishBuildArtifacts@1
            displayName: 'Publish Logs'
            inputs:
              PathtoPublish: '$(System.DefaultWorkingDirectory)/logs'
              ArtifactName: 'appium-logs'
            condition: always()

          - bash: |
              if [ -f emulator.log ]; then
                mkdir -p logs
                cp emulator.log logs/
              fi
            displayName: 'Collect Emulator Logs'
            condition: always()

          - task: PublishBuildArtifacts@1
            displayName: 'Publish Emulator Logs'
            inputs:
              PathtoPublish: '$(System.DefaultWorkingDirectory)/logs'
              ArtifactName: 'emulator-logs'
            condition: always()

  - stage: Report
    displayName: 'Test Reports'
    dependsOn: Test
    condition: always()
    jobs:
      - job: Summary
        displayName: 'Test Summary'
        steps:
          - task: DownloadBuildArtifacts@1
            inputs:
              buildType: 'current'
              downloadType: 'specific'
              itemPattern: '**'
              downloadPath: '$(System.DefaultWorkingDirectory)/artifacts'

          - bash: |
              echo "ðŸ“Š Test Execution Summary"
              echo "=========================="
              if [ -d "artifacts/test-screenshots" ]; then
                SCREENSHOT_COUNT=$(find artifacts/test-screenshots -type f -name "*.png" | wc -l)
                echo "ðŸ“¸ Screenshots: $SCREENSHOT_COUNT"
              fi
              
              if [ -f "artifacts/extent-report/Extent-report.html" ]; then
                echo "âœ… Extent Report: Available"
              fi
              
              echo ""
              echo "View artifacts in the 'Summary' tab of this pipeline run"
            displayName: 'Display Summary'
