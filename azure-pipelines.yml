# Azure Pipeline for Eptura Engage Android Automation
# Consolidated version with proven emulator startup and comprehensive features

trigger:
  branches:
    include:
      - main
      - master
      - develop
  paths:
    exclude:
      - README.md
      - docs/**

pr:
  branches:
    include:
      - main
      - master
      - develop

# Pipeline variables
variables:
  mavenPOMFile: 'pom.xml'
  jdkVersion: '17'
  appiumVersion: '3.0.0'
  androidSdkVersion: '34'
  testResultsFolder: '$(System.DefaultWorkingDirectory)/target/surefire-reports'
  screenshotsFolder: '$(System.DefaultWorkingDirectory)/target/screenshots'
  extentReportFolder: '$(System.DefaultWorkingDirectory)/target'
  emulatorName: 'test_emulator'

# Agent pool - Use Microsoft-hosted macOS agents for better Android emulator performance
pool:
  vmImage: 'macOS-14'  # Latest stable macOS with better emulator support

stages:
  - stage: Build
    displayName: 'Build Stage'
    jobs:
      - job: MavenBuild
        displayName: 'Build Maven Project'
        steps:
          - task: JavaToolInstaller@0
            displayName: 'Install Java JDK 17'
            inputs:
              versionSpec: '17'
              jdkArchitectureOption: 'x64'
              jdkSourceOption: 'PreInstalled'

          - task: Maven@4
            displayName: 'Maven Clean Compile'
            inputs:
              mavenPomFile: '$(mavenPOMFile)'
              goals: 'clean compile'
              options: '-DskipTests'
              publishJUnitResults: false
              javaHomeOption: 'JDKVersion'
              jdkVersionOption: '$(jdkVersion)'
              mavenVersionOption: 'Default'
              mavenOptions: '-Xmx3072m'

          - task: PublishBuildArtifacts@1
            displayName: 'Publish Build Artifacts'
            inputs:
              PathtoPublish: '$(System.DefaultWorkingDirectory)/target'
              ArtifactName: 'build-output'
              publishLocation: 'Container'

  - stage: Test
    displayName: 'Test Stage'
    dependsOn: Build
    jobs:
      - job: AndroidTests
        displayName: 'Run Android Appium Tests'
        timeoutInMinutes: 120
        steps:
          - task: JavaToolInstaller@0
            displayName: 'Install Java JDK 17'
            inputs:
              versionSpec: '17'
              jdkArchitectureOption: 'x64'
              jdkSourceOption: 'PreInstalled'

          - task: NodeTool@0
            displayName: 'Install Node.js'
            inputs:
              versionSpec: '20.x'

          - bash: |
              echo "ğŸ Installing Python dependencies..."
              pip3 install --break-system-packages Appium-Python-Client selenium || pip install Appium-Python-Client selenium
              echo "âœ… Python dependencies installed"
            displayName: 'Install Python Dependencies'

          - bash: |
              echo "ğŸ“± Setting up Android Emulator with ENHANCED approach..."
              echo "============================================================================"
              
              # Set environment variables
              export ANDROID_HOME=$ANDROID_SDK_ROOT
              export PATH=$PATH:$ANDROID_HOME/platform-tools:$ANDROID_HOME/emulator:$ANDROID_HOME/cmdline-tools/latest/bin
              
              echo "ANDROID_HOME: $ANDROID_HOME"
              echo "System Info:"
              sysctl -n hw.ncpu
              sysctl -n hw.memsize | awk '{print $0/1024/1024/1024 " GB"}'
              
              # Kill any existing processes
              $ANDROID_HOME/platform-tools/adb kill-server || true
              pkill -9 qemu-system || true
              pkill -9 emulator || true
              sleep 3
              
              # Accept licenses
              yes | sdkmanager --licenses || true
              
              # Update SDK tools first
              echo "ğŸ“¦ Updating SDK tools..."
              sdkmanager --update
              
              # Use google_apis instead of playstore - more stable in CI
              echo "ğŸ“¦ Installing SDK components (API 30 google_apis for CI stability)..."
              sdkmanager --install \
                "platform-tools" \
                "platforms;android-30" \
                "build-tools;30.0.3" \
                "emulator" \
                "system-images;android-30;google_apis;x86_64"
              
              # Verify installation
              echo "ğŸ” Verifying system images..."
              sdkmanager --list_installed | grep system-images
              
              # Create AVD with optimal settings for CI
              echo "ğŸ“± Creating emulator AVD (API 30 google_apis)..."
              echo "no" | avdmanager create avd \
                --force \
                --name "ci_emulator" \
                --package "system-images;android-30;google_apis;x86_64" \
                --device "pixel_4" \
                --tag "google_apis"
              
              # Configure AVD for better performance
              AVD_PATH="$HOME/.android/avd/ci_emulator.avd"
              
              # Optimize config.ini
              cat >> "$AVD_PATH/config.ini" << EOF
              hw.cpu.ncore=2
              hw.ramSize=4096
              hw.keyboard=yes
              hw.gpu.enabled=yes
              hw.gpu.mode=swiftshader_indirect
              disk.dataPartition.size=6G
              fastboot.forceColdBoot=yes
              hw.camera.back=none
              hw.camera.front=none
              EOF
              
              echo "âœ… AVD created and configured"
              $ANDROID_HOME/emulator/emulator -list-avds
              
            displayName: 'Setup Android SDK and AVD'

          - bash: |
              echo "ğŸš€ Starting Android Emulator with ROBUST OFFLINE RECOVERY..."
              echo "============================================================================"
              
              export ANDROID_HOME=$ANDROID_SDK_ROOT
              export PATH=$PATH:$ANDROID_HOME/platform-tools:$ANDROID_HOME/emulator
              
              # Clean ADB completely
              echo "ğŸ§¹ Cleaning ADB state..."
              $ANDROID_HOME/platform-tools/adb kill-server || true
              rm -rf ~/.android/adb* 2>/dev/null || true
              sleep 2
              
              # Start ADB server fresh
              echo "ğŸ”§ Starting ADB server..."
              $ANDROID_HOME/platform-tools/adb start-server
              sleep 3
              
              # Configure advanced features for hardware acceleration
              mkdir -p ~/.android
              cat > ~/.android/advancedFeatures.ini << EOF
              Vulkan = off
              GLDirectMem = on
              GLDMA = on
              HostComposition = off
              HVF = on
              KVM = off
              EOF
              
              # Start emulator - REMOVED -wipe-data to prevent offline state
              echo "Starting emulator in background..."
              $ANDROID_HOME/emulator/emulator \
                -avd ci_emulator \
                -no-window \
                -no-audio \
                -no-boot-anim \
                -gpu swiftshader_indirect \
                -no-snapshot-save \
                -memory 4096 \
                -cores 2 \
                -camera-back none \
                -camera-front none \
                -accel on \
                -netdelay none \
                -netspeed full \
                -qemu -m 4096 \
                > emulator.log 2>&1 &
              
              EMULATOR_PID=$!
              echo "Emulator PID: $EMULATOR_PID"
              
              # Wait for emulator to appear in ADB
              echo "â³ Waiting for emulator to appear in ADB..."
              sleep 15
              
              # Enhanced boot wait with aggressive offline recovery
              echo "â³ Waiting for emulator to boot (max 10 minutes)..."
              
              TIMEOUT=600
              ELAPSED=0
              BOOT_COMPLETE=false
              OFFLINE_RECOVERY_ATTEMPTS=0
              MAX_OFFLINE_RECOVERIES=5
              
              while [ $ELAPSED -lt $TIMEOUT ]; do
                # Check emulator process health
                if ! ps -p $EMULATOR_PID > /dev/null 2>&1; then
                  echo "âŒ Emulator process died unexpectedly!"
                  echo "=== Last 100 lines of emulator log ==="
                  tail -100 emulator.log
                  exit 1
                fi
                
                # Get device state
                DEVICE_STATE=$($ANDROID_HOME/platform-tools/adb devices | grep emulator | awk '{print $2}')
                
                if [ "$DEVICE_STATE" = "device" ]; then
                  # Check boot completion
                  BOOT_STATUS=$($ANDROID_HOME/platform-tools/adb -s emulator-5554 shell getprop sys.boot_completed 2>&1 | tr -d '\r\n')
                  
                  if [ "$BOOT_STATUS" = "1" ]; then
                    echo "âœ… Boot completed successfully in ${ELAPSED}s!"
                    BOOT_COMPLETE=true
                    break
                  fi
                  
                  # Progress for online device
                  if [ $((ELAPSED % 20)) -eq 0 ]; then
                    echo "  Status: device (booting...) | Time: ${ELAPSED}s / ${TIMEOUT}s"
                  fi
                  
                elif [ "$DEVICE_STATE" = "offline" ]; then
                  # AGGRESSIVE OFFLINE RECOVERY
                  if [ $OFFLINE_RECOVERY_ATTEMPTS -lt $MAX_OFFLINE_RECOVERIES ]; then
                    echo "âš ï¸  Device OFFLINE - Applying recovery #$((OFFLINE_RECOVERY_ATTEMPTS + 1))..."
                    
                    # Method 1: Kill and restart ADB
                    $ANDROID_HOME/platform-tools/adb kill-server
                    sleep 2
                    $ANDROID_HOME/platform-tools/adb start-server
                    sleep 3
                    
                    # Method 2: Try to reconnect the device
                    $ANDROID_HOME/platform-tools/adb reconnect emulator-5554 2>/dev/null || true
                    sleep 2
                    
                    # Method 3: Force device online with adb wait-for-device
                    timeout 10 $ANDROID_HOME/platform-tools/adb -s emulator-5554 wait-for-device 2>/dev/null || true
                    
                    OFFLINE_RECOVERY_ATTEMPTS=$((OFFLINE_RECOVERY_ATTEMPTS + 1))
                    
                    # Check if recovery worked
                    sleep 5
                    NEW_STATE=$($ANDROID_HOME/platform-tools/adb devices | grep emulator | awk '{print $2}')
                    if [ "$NEW_STATE" = "device" ]; then
                      echo "âœ… Recovery successful! Device is now online."
                    else
                      echo "  Still offline, will retry... ($OFFLINE_RECOVERY_ATTEMPTS/$MAX_OFFLINE_RECOVERIES)"
                    fi
                  else
                    # All recovery attempts exhausted
                    if [ $((ELAPSED % 20)) -eq 0 ]; then
                      echo "  Status: offline (max recoveries reached) | Time: ${ELAPSED}s / ${TIMEOUT}s"
                    fi
                  fi
                else
                  # Device not found
                  if [ $((ELAPSED % 20)) -eq 0 ]; then
                    echo "  Status: not detected | Time: ${ELAPSED}s / ${TIMEOUT}s"
                  fi
                fi
                
                sleep 10
                ELAPSED=$((ELAPSED + 10))
              done
              
              if [ "$BOOT_COMPLETE" = false ]; then
                echo "âŒ Emulator failed to boot within timeout!"
                echo ""
                echo "=== Final Device Status ==="
                $ANDROID_HOME/platform-tools/adb devices -l
                echo ""
                echo "=== ADB Server Status ==="
                ps aux | grep adb | grep -v grep || echo "No ADB process found"
                echo ""
                echo "=== Emulator Process Status ==="
                ps aux | grep emulator | grep -v grep || echo "No emulator process found"
                echo ""
                echo "=== Emulator Log (last 300 lines) ==="
                tail -300 emulator.log
                exit 1
              fi
              
              # Post-boot stabilization
              echo "â³ Waiting for system stability (10s)..."
              sleep 10
              
              # Verify package manager
              echo "â³ Verifying package manager..."
              for i in {1..20}; do
                if $ANDROID_HOME/platform-tools/adb -s emulator-5554 shell pm path android > /dev/null 2>&1; then
                  echo "âœ… Package manager ready!"
                  break
                fi
                sleep 2
              done
              
              # Performance optimizations
              echo "ğŸ¬ Applying optimizations..."
              $ANDROID_HOME/platform-tools/adb -s emulator-5554 shell settings put global window_animation_scale 0 2>/dev/null || true
              $ANDROID_HOME/platform-tools/adb -s emulator-5554 shell settings put global transition_animation_scale 0 2>/dev/null || true
              $ANDROID_HOME/platform-tools/adb -s emulator-5554 shell settings put global animator_duration_scale 0 2>/dev/null || true
              $ANDROID_HOME/platform-tools/adb -s emulator-5554 shell input keyevent 82 2>/dev/null || true
              
              # Final verification
              echo ""
              echo "âœ… EMULATOR FULLY READY!"
              echo "============================================================================"
              $ANDROID_HOME/platform-tools/adb devices -l
              echo "Android Version: $($ANDROID_HOME/platform-tools/adb -s emulator-5554 shell getprop ro.build.version.release | tr -d '\r\n')"
              echo "API Level: $($ANDROID_HOME/platform-tools/adb -s emulator-5554 shell getprop ro.build.version.sdk | tr -d '\r\n')"
              echo "Device Model: $($ANDROID_HOME/platform-tools/adb -s emulator-5554 shell getprop ro.product.model | tr -d '\r\n')"
              echo "============================================================================"
              echo "ğŸ‰ Ready for test execution!"
              
            displayName: 'Start Emulator and Wait for Boot'

          - task: Npm@1
            displayName: 'Install Appium'
            inputs:
              command: 'custom'
              customCommand: 'install -g appium@$(appiumVersion)'

          - bash: |
              appium driver install uiautomator2
              appium driver list --installed
            displayName: 'Install Appium UiAutomator2 Driver'

          - bash: |
              echo "ğŸš€ Starting Appium Server..."
              mkdir -p logs
              
              pkill -f appium || true
              sleep 2
              
              nohup appium --address 127.0.0.1 --port 4723 --session-override --log-level info > logs/appium.log 2>&1 &
              APPIUM_PID=$!
              echo "Appium PID: $APPIUM_PID"
              
              # Wait for Appium to be ready
              for i in {1..30}; do
                if curl -s http://127.0.0.1:4723/status > /dev/null 2>&1; then
                  echo "âœ… Appium server is ready"
                  exit 0
                fi
                echo "Waiting for Appium... ($i/30)"
                sleep 2
              done
              
              echo "âŒ Appium failed to start"
              cat logs/appium.log
              exit 1
            displayName: 'Start Appium Server'

          - bash: |
              chmod +x scripts/emulator_warmup.sh
              ./scripts/emulator_warmup.sh
            displayName: 'Warm Up Emulator & Pre-install Appium APKs'
            continueOnError: false

          - bash: |
              echo "ğŸ“² Installing Eptura Engage App..."
              export ANDROID_HOME=$ANDROID_SDK_ROOT
              ADB="$ANDROID_HOME/platform-tools/adb"
              PACKAGE_NAME="com.condecosoftware.condeco"
              
              # CRITICAL: Verify device is online and ready before proceeding
              echo "ğŸ” Verifying device readiness..."
              MAX_WAIT=60
              WAITED=0
              DEVICE_READY=false
              
              while [ $WAITED -lt $MAX_WAIT ]; do
                DEVICE_STATE=$("$ADB" devices | grep emulator | awk '{print $2}')
                
                if [ "$DEVICE_STATE" = "device" ]; then
                  # Double-check with a simple ADB command
                  if "$ADB" shell getprop sys.boot_completed 2>/dev/null | grep -q "1"; then
                    echo "âœ… Device is online and ready!"
                    DEVICE_READY=true
                    break
                  fi
                fi
                
                if [ "$DEVICE_STATE" = "offline" ]; then
                  echo "âš ï¸  Device offline at ${WAITED}s, waiting... (State: $DEVICE_STATE)"
                elif [ -z "$DEVICE_STATE" ]; then
                  echo "âš ï¸  No device found at ${WAITED}s, waiting..."
                fi
                
                sleep 3
                WAITED=$((WAITED + 3))
              done
              
              if [ "$DEVICE_READY" = false ]; then
                echo "âŒ Device not ready after ${MAX_WAIT}s!"
                echo "Current device state:"
                "$ADB" devices -l
                exit 1
              fi
              
              # Additional stability wait
              echo "â³ Waiting 5s for stability..."
              sleep 5
              
              # Check if already installed
              echo "ğŸ” Checking if app is already installed..."
              if "$ADB" shell pm list packages 2>/dev/null | grep -q "$PACKAGE_NAME"; then
                echo "âœ… App is already installed!"
                exit 0
              fi
              
              # ========================================================================
              # GOOGLE PLAY STORE INSTALLATION
              # ========================================================================
              echo ""
              echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
              echo "ğŸª STARTING GOOGLE PLAY STORE INSTALLATION PROCESS"
              echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
              echo ""
              
              # Verify Python script exists
              if [ ! -f "src/main/resources/install_from_playstore.py" ]; then
                echo "âŒ ERROR: Play Store installation script not found!"
                echo "   Expected location: src/main/resources/install_from_playstore.py"
                exit 1
              fi
              
              # Verify credentials are available
              if [ -z "$GOOGLE_EMAIL" ] || [ -z "$GOOGLE_PASSWORD" ]; then
                echo "âŒ ERROR: Google Play Store credentials not configured!"
                echo "   Please configure GOOGLE_PLAY_EMAIL and GOOGLE_PLAY_PASSWORD variables"
                exit 1
              fi
              
              echo "âœ… Play Store installation script found"
              echo "âœ… Google credentials configured"
              echo "ğŸ“§ Using account: ${GOOGLE_EMAIL:0:3}***@***"
              echo ""
              
              # Verify device is still ready
              if ! "$ADB" shell getprop sys.boot_completed 2>/dev/null | grep -q "1"; then
                echo "âš ï¸  Device offline, waiting 10s for recovery..."
                sleep 10
              fi
              
              # Create directories for debugging artifacts
              mkdir -p playstore_screenshots
              mkdir -p playstore-recordings
              
              # Set Python command
              if command -v python3 &> /dev/null; then
                PYTHON_CMD=python3
              else
                PYTHON_CMD=python
              fi
              
              echo "ğŸ Python command: $PYTHON_CMD"
              echo ""
              echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
              echo "ğŸ“± The script will perform the following steps:"
              echo "   1. Open Google Play Store"
              echo "   2. Login with provided Google account credentials"
              echo "   3. Search for 'Eptura Engage' app"
              echo "   4. Click Install button"
              echo "   5. Wait for installation to complete"
              echo "   6. Verify app is installed"
              echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
              echo ""
              
              # Run Play Store installation with full output
              echo "ğŸš€ Starting automated Play Store installation..."
              echo ""
              
              $PYTHON_CMD src/main/resources/install_from_playstore.py "$GOOGLE_EMAIL" "$GOOGLE_PASSWORD" "Eptura Engage"
              INSTALL_RESULT=$?
              
              echo ""
              echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
              
              # Verify installation
              echo "ğŸ” Verifying installation in package manager..."
              if "$ADB" shell pm list packages 2>/dev/null | grep -q "$PACKAGE_NAME"; then
                echo "âœ…âœ…âœ… PLAY STORE INSTALLATION SUCCESSFUL! âœ…âœ…âœ…"
                echo "   Package: $PACKAGE_NAME"
                echo "   Method: Google Play Store"
                echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
                exit 0
              else
                echo "âŒ INSTALLATION FAILED"
                echo "   App package not found in device package manager"
                echo "   Package searched: $PACKAGE_NAME"
                echo ""
                echo "ğŸ“¸ Debug screenshots saved to: playstore_screenshots/"
                echo "ğŸ¥ Video recordings saved to: playstore-recordings/"
                echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
                exit 1
              fi
            displayName: 'Install Eptura Engage App'
            continueOnError: true
            env:
              GOOGLE_EMAIL: $(GOOGLE_PLAY_EMAIL)
              GOOGLE_PASSWORD: $(GOOGLE_PLAY_PASSWORD)

          - task: PublishBuildArtifacts@1
            displayName: 'Publish Play Store Screenshots'
            inputs:
              PathtoPublish: '$(System.DefaultWorkingDirectory)/playstore_screenshots'
              ArtifactName: 'playstore-debug-screenshots'
            condition: and(always(), eq(variables['Agent.JobStatus'], 'Succeeded'))
            continueOnError: true

          - task: PublishBuildArtifacts@1
            displayName: 'Publish Play Store Video Recordings'
            inputs:
              PathtoPublish: '$(System.DefaultWorkingDirectory)/playstore-recordings'
              ArtifactName: 'playstore-video-recordings'
            condition: always()

          - task: DownloadBuildArtifacts@1
            displayName: 'Download Build Artifacts'
            inputs:
              buildType: 'current'
              downloadType: 'single'
              artifactName: 'build-output'
              downloadPath: '$(System.DefaultWorkingDirectory)'

          - task: Maven@4
            displayName: 'Run TestNG Tests'
            inputs:
              mavenPomFile: '$(mavenPOMFile)'
              goals: 'test'
              options: '-Dtestng.xml=testng.xml'
              publishJUnitResults: true
              testResultsFiles: '**/surefire-reports/TEST-*.xml'
              testRunTitle: 'Eptura Engage Android Tests'
              javaHomeOption: 'JDKVersion'
              jdkVersionOption: '$(jdkVersion)'
              mavenVersionOption: 'Default'
              mavenOptions: '-Xmx3072m'
            env:
              USE_EXTERNAL_APPIUM: 'true'
              APPIUM_SERVER_URL: 'http://127.0.0.1:4723'
            continueOnError: true

          # Cleanup
          - bash: |
              pkill -f appium || true
              export ANDROID_HOME=$ANDROID_SDK_ROOT
              $ANDROID_HOME/platform-tools/adb emu kill || true
              pkill -9 qemu-system || true
              pkill -9 emulator || true
            displayName: 'Cleanup'
            condition: always()

          # Publish artifacts
          - task: PublishTestResults@2
            displayName: 'Publish Test Results'
            inputs:
              testResultsFormat: 'JUnit'
              testResultsFiles: '**/surefire-reports/TEST-*.xml'
              mergeTestResults: true
              failTaskOnFailedTests: false
              testRunTitle: 'Eptura Android Tests'
            condition: always()

          - task: PublishBuildArtifacts@1
            displayName: 'Publish Screenshots'
            inputs:
              PathtoPublish: '$(screenshotsFolder)'
              ArtifactName: 'test-screenshots'
            condition: always()

          - task: PublishBuildArtifacts@1
            displayName: 'Publish Extent Report'
            inputs:
              PathtoPublish: '$(extentReportFolder)/Extent-report.html'
              ArtifactName: 'extent-report'
            condition: always()

          - task: PublishBuildArtifacts@1
            displayName: 'Publish Logs'
            inputs:
              PathtoPublish: '$(System.DefaultWorkingDirectory)/logs'
              ArtifactName: 'appium-logs'
            condition: always()

          - bash: |
              if [ -f emulator.log ]; then
                mkdir -p logs
                cp emulator.log logs/
              fi
            displayName: 'Collect Emulator Logs'
            condition: always()

          - task: PublishBuildArtifacts@1
            displayName: 'Publish Emulator Logs'
            inputs:
              PathtoPublish: '$(System.DefaultWorkingDirectory)/logs'
              ArtifactName: 'emulator-logs'
            condition: always()

  - stage: Report
    displayName: 'Test Reports'
    dependsOn: Test
    condition: always()
    jobs:
      - job: Summary
        displayName: 'Test Summary'
        steps:
          - task: DownloadBuildArtifacts@1
            inputs:
              buildType: 'current'
              downloadType: 'specific'
              itemPattern: '**'
              downloadPath: '$(System.DefaultWorkingDirectory)/artifacts'

          - bash: |
              echo "ğŸ“Š Test Execution Summary"
              echo "=========================="
              if [ -d "artifacts/test-screenshots" ]; then
                SCREENSHOT_COUNT=$(find artifacts/test-screenshots -type f -name "*.png" | wc -l)
                echo "ğŸ“¸ Screenshots: $SCREENSHOT_COUNT"
              fi
              
              if [ -f "artifacts/extent-report/Extent-report.html" ]; then
                echo "âœ… Extent Report: Available"
              fi
              
              echo ""
              echo "View artifacts in the 'Summary' tab of this pipeline run"
            displayName: 'Display Summary'