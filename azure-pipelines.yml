# Azure Pipeline for Eptura Engage Android Automation
# This pipeline creates an emulator with Google Play Store and installs app from Play Store

trigger:
  branches:
    include:
      - main
      - master
      - develop
  paths:
    exclude:
      - README.md
      - docs/**

pr:
  branches:
    include:
      - main
      - master
      - develop

# Pipeline variables
variables:
  mavenPOMFile: 'pom.xml'
  jdkVersion: '17'
  appiumVersion: '3.0.0'
  androidSdkVersion: '30'
  testResultsFolder: '$(System.DefaultWorkingDirectory)/target/surefire-reports'
  screenshotsFolder: '$(System.DefaultWorkingDirectory)/target/screenshots'
  extentReportFolder: '$(System.DefaultWorkingDirectory)/target'
  emulatorName: 'test_emulator_playstore'

# Agent pool - Use Microsoft-hosted macOS agents
pool:
  vmImage: 'macOS-14'

stages:
  - stage: Build
    displayName: 'Build Stage'
    jobs:
      - job: MavenBuild
        displayName: 'Build Maven Project'
        steps:
          - task: JavaToolInstaller@0
            displayName: 'Install Java JDK 17'
            inputs:
              versionSpec: '17'
              jdkArchitectureOption: 'x64'
              jdkSourceOption: 'PreInstalled'

          - task: Maven@4
            displayName: 'Maven Clean Compile'
            inputs:
              mavenPomFile: '$(mavenPOMFile)'
              goals: 'clean compile'
              options: '-DskipTests'
              publishJUnitResults: false
              javaHomeOption: 'JDKVersion'
              jdkVersionOption: '$(jdkVersion)'
              mavenVersionOption: 'Default'
              mavenOptions: '-Xmx3072m'

          - task: PublishBuildArtifacts@1
            displayName: 'Publish Build Artifacts'
            inputs:
              PathtoPublish: '$(System.DefaultWorkingDirectory)/target'
              ArtifactName: 'build-output'
              publishLocation: 'Container'

  - stage: Test
    displayName: 'Test Stage'
    dependsOn: Build
    jobs:
      - job: AndroidTests
        displayName: 'Run Android Appium Tests'
        timeoutInMinutes: 120
        steps:
          - task: JavaToolInstaller@0
            displayName: 'Install Java JDK 17'
            inputs:
              versionSpec: '17'
              jdkArchitectureOption: 'x64'
              jdkSourceOption: 'PreInstalled'

          - task: NodeTool@0
            displayName: 'Install Node.js'
            inputs:
              versionSpec: '20.x'

          - bash: |
              echo "üêç Installing Python dependencies for Play Store installer..."
              python3 --version
              pip3 --version
              
              # Install Appium Python client and dependencies
              # Using --break-system-packages flag to bypass PEP 668 restrictions on macOS
              # Allow pip upgrade to fail as it's not critical
              pip3 install --upgrade pip --break-system-packages || echo "‚ö†Ô∏è  Pip upgrade skipped (not critical)"
              
              # Install required packages
              pip3 install Appium-Python-Client --break-system-packages || { echo "‚ùå Failed to install Appium-Python-Client"; exit 1; }
              pip3 install selenium --break-system-packages || { echo "‚ùå Failed to install selenium"; exit 1; }
              
              echo "‚úÖ Python dependencies installed"
              pip3 list | grep -i appium || echo "Appium package verification"
            displayName: 'Install Python Dependencies'

          - bash: |
              echo "üì± Configuring Android SDK with Google Play support..."
              
              # Set Android environment variables
              export ANDROID_HOME=$ANDROID_SDK_ROOT
              export PATH=$PATH:$ANDROID_HOME/platform-tools:$ANDROID_HOME/emulator:$ANDROID_HOME/cmdline-tools/latest/bin
              
              echo "ANDROID_HOME: $ANDROID_HOME"
              echo "ANDROID_SDK_ROOT: $ANDROID_SDK_ROOT"
              
              # Verify Android SDK exists
              if [ ! -d "$ANDROID_HOME" ]; then
                echo "‚ùå ANDROID_HOME directory not found: $ANDROID_HOME"
                exit 1
              fi
              
              echo "üìã Android SDK structure:"
              ls -la $ANDROID_HOME/ || true
              
              # Verify cmdline-tools exists
              if [ ! -d "$ANDROID_HOME/cmdline-tools/latest/bin" ]; then
                echo "‚ùå cmdline-tools not found. Checking for alternative locations..."
                find $ANDROID_HOME -name "sdkmanager" -type f 2>/dev/null || true
                exit 1
              fi
              
              # Accept all licenses - use a more robust method
              echo "üìù Accepting Android SDK licenses..."
              # Create licenses directory if it doesn't exist
              mkdir -p "$ANDROID_HOME/licenses"
              
              # Accept all known Android SDK licenses by creating license files
              # These are the current license hashes as of 2024
              echo "24333f8a63b6825ea9c5514f83c2829b004d1fee" > "$ANDROID_HOME/licenses/android-sdk-license"
              echo "84831b9409646a918e30573bab4c9c91346d8abd" > "$ANDROID_HOME/licenses/android-sdk-preview-license"
              echo "d975f751698a77b662f1254ddbeed3901e976f5a" > "$ANDROID_HOME/licenses/intel-android-extra-license"
              echo "33b6a2b64607f11b759f320ef9dff4ae5c47d97a" > "$ANDROID_HOME/licenses/google-gdk-license"
              echo "e9acab5b5fbb560a72cfaecce8946896ff6aab9d" > "$ANDROID_HOME/licenses/mips-android-sysimage-license"
              echo "d56a98520377fecf01c9e79e689e9ba188a4558e" > "$ANDROID_HOME/licenses/android-googletv-license"
              echo "667f5ef1d0d6dbb3c1bb1dbe94f0c0c66f8c3ee5" > "$ANDROID_HOME/licenses/android-googlexr-license"
              
              # Accept the ARM DBT license with all known hashes
              echo "e6b7c2ab7fa2298c15165e9583d0acf0b04a2232" > "$ANDROID_HOME/licenses/android-sdk-arm-dbt-license"
              echo "d56a98520377fecf01c9e79e689e9ba188a4558e" >> "$ANDROID_HOME/licenses/android-sdk-arm-dbt-license"
              
              echo "‚úÖ License files created successfully"
              
              # Verify licenses directory
              echo "üìã Licenses directory contents:"
              ls -la "$ANDROID_HOME/licenses/" || echo "Licenses directory not found"
              cat "$ANDROID_HOME/licenses/android-sdk-arm-dbt-license" 2>/dev/null && echo "ARM DBT license hashes verified"
              
              # Update SDK manager
              echo "üîÑ Updating SDK manager..."
              $ANDROID_HOME/cmdline-tools/latest/bin/sdkmanager --update --sdk_root=$ANDROID_HOME || true
              
              # Install SDK components with Google Play Store support
              # Use 'yes' to automatically accept any interactive prompts
              echo "üì¶ Installing SDK components with Google Play Store..."
              echo "This may take a few minutes..."
              
              yes | $ANDROID_HOME/cmdline-tools/latest/bin/sdkmanager \
                --sdk_root=$ANDROID_HOME \
                --verbose \
                "platform-tools" \
                "platforms;android-30" \
                "build-tools;30.0.3" \
                "emulator" \
                "system-images;android-30;google_apis_playstore;x86_64" 2>&1 | grep -v "^Info:" | grep -v "^Warning:" || {
                echo "‚ùå Failed to install SDK components"
                echo ""
                echo "Checking what went wrong..."
                echo "Attempting to list available packages:"
                $ANDROID_HOME/cmdline-tools/latest/bin/sdkmanager --list --sdk_root=$ANDROID_HOME 2>&1 | head -50 || true
                echo ""
                echo "Checking licenses directory:"
                ls -la "$ANDROID_HOME/licenses/"
                exit 1
              }
              
              echo "‚úÖ SDK components installation completed"
              
              # Wait for installation to complete and verify
              sleep 5
              
              # Verify system image was installed
              echo "üîç Verifying system image installation..."
              echo "Checking path: $ANDROID_HOME/system-images/android-30/google_apis_playstore/x86_64"
              
              if [ -d "$ANDROID_HOME/system-images/android-30/google_apis_playstore/x86_64" ]; then
                echo "‚úÖ Google Play system image found!"
                ls -la "$ANDROID_HOME/system-images/android-30/google_apis_playstore/x86_64"
              else
                echo "‚ùå System image not found after installation!"
                echo ""
                echo "Contents of system-images directory:"
                if [ -d "$ANDROID_HOME/system-images" ]; then
                  find $ANDROID_HOME/system-images -type d -maxdepth 3
                else
                  echo "‚ö†Ô∏è  system-images directory does not exist at: $ANDROID_HOME/system-images"
                fi
                echo ""
                echo "üìã List of installed packages:"
                $ANDROID_HOME/cmdline-tools/latest/bin/sdkmanager --list_installed --sdk_root=$ANDROID_HOME
                exit 1
              fi
              
              # Verify ADB
              echo "üîß Verifying ADB..."
              adb version
              
              # List all installed system images
              echo "üìã Installed system images:"
              $ANDROID_HOME/cmdline-tools/latest/bin/sdkmanager --list_installed --sdk_root=$ANDROID_HOME | grep system-images || echo "No system images found in installed list"
              
              echo ""
              echo "üì± Creating Android Emulator with Google Play Store..."
              
              # Delete existing emulator if present
              $ANDROID_HOME/cmdline-tools/latest/bin/avdmanager delete avd -n $(emulatorName) 2>/dev/null || true
              
              # Create new emulator with Google Play
              echo "Creating emulator with Google Play Store support..."
              echo "no" | $ANDROID_HOME/cmdline-tools/latest/bin/avdmanager create avd \
                --force \
                --name "$(emulatorName)" \
                --package "system-images;android-30;google_apis_playstore;x86_64" \
                --device "pixel_4" \
                --abi x86_64 || {
                echo "‚ùå Failed to create emulator"
                echo "Available packages:"
                $ANDROID_HOME/cmdline-tools/latest/bin/avdmanager list target
                exit 1
              }
              
              # Verify emulator was created
              echo "üîç Verifying emulator creation..."
              $ANDROID_HOME/emulator/emulator -list-avds
              
              if $ANDROID_HOME/emulator/emulator -list-avds | grep -q "$(emulatorName)"; then
                echo "‚úÖ Emulator '$(emulatorName)' created successfully"
              else
                echo "‚ùå Failed to create emulator"
                echo "Available AVDs:"
                $ANDROID_HOME/emulator/emulator -list-avds
                exit 1
              fi
              
              # Start emulator with optimized settings
              echo "üöÄ Starting emulator with optimized settings..."
              nohup $ANDROID_HOME/emulator/emulator -avd $(emulatorName) \
                -no-snapshot-save \
                -no-window \
                -no-audio \
                -no-boot-anim \
                -gpu swiftshader_indirect \
                -memory 4096 \
                -cores 2 \
                -accel on \
                -wipe-data \
                > emulator.log 2>&1 &
              
              EMULATOR_PID=$!
              echo "Emulator PID: $EMULATOR_PID"
              echo "##vso[task.setvariable variable=EMULATOR_PID]$EMULATOR_PID"
              
              # Wait for device to be detected
              echo "‚è≥ Waiting for emulator device to be detected..."
              adb wait-for-device
              echo "‚úÖ Device detected"
              
              # Wait for boot completion with reasonable timeout
              echo "‚è≥ Waiting for boot_completed flag..."
              timeout=180
              elapsed=0
              until [[ "$(adb shell getprop sys.boot_completed 2>/dev/null | tr -d '\r')" == "1" ]]; do
                if [ $elapsed -ge $timeout ]; then
                  echo "‚ùå Boot timeout after $timeout seconds"
                  echo "=== Emulator Log (last 100 lines) ==="
                  tail -100 emulator.log
                  exit 1
                fi
                sleep 5
                elapsed=$((elapsed+5))
                if [ $((elapsed % 15)) -eq 0 ]; then
                  echo "  Still booting... ($elapsed/$timeout seconds)"
                fi
              done
              
              echo "‚úÖ Boot completed flag set!"
              
              # Optimized service readiness check with faster polling
              echo "‚è≥ Waiting for Android system services (max 90 seconds)..."
              
              service_ready=false
              max_wait=90
              elapsed=0
              
              while [ $elapsed -lt $max_wait ]; do
                # Check all services in one go
                pm_ready=false
                am_ready=false
                
                if adb shell pm list packages >/dev/null 2>&1; then
                  pm_ready=true
                fi
                
                if adb shell am get-config >/dev/null 2>&1; then
                  am_ready=true
                fi
                
                if [ "$pm_ready" = true ] && [ "$am_ready" = true ]; then
                  echo "‚úÖ All critical services are ready!"
                  service_ready=true
                  break
                fi
                
                sleep 3
                elapsed=$((elapsed+3))
                
                if [ $((elapsed % 15)) -eq 0 ]; then
                  echo "  Still initializing services... ($elapsed/$max_wait seconds)"
                  echo "    - Package Manager: $([ "$pm_ready" = true ] && echo "‚úÖ" || echo "‚è≥")"
                  echo "    - Activity Manager: $([ "$am_ready" = true ] && echo "‚úÖ" || echo "‚è≥")"
                fi
              done
              
              if [ "$service_ready" = false ]; then
                echo "‚ö†Ô∏è  Services not ready after $max_wait seconds, but continuing..."
                echo "Attempting to check emulator state:"
                adb shell getprop sys.boot_completed
                adb shell pm list packages | head -5
              fi
              
              # Extended stability wait for emulator to fully initialize
              echo "‚è≥ Allowing system to stabilize (30 seconds)..."
              sleep 30
              
              # Final verification
              echo "üîç Final system verification..."
              
              # Verify ADB connection is stable with extended retries
              echo "‚è≥ Verifying ADB shell connection..."
              adb_shell_ready=false
              for attempt in {1..10}; do
                echo "  Attempt $attempt/10: Testing ADB shell..."
                if adb shell echo "test" > /dev/null 2>&1; then
                  echo "‚úÖ ADB shell connection established (attempt $attempt)"
                  adb_shell_ready=true
                  break
                fi
                echo "  ‚è≥ ADB shell not ready, waiting 15 seconds..."
                sleep 15
              done
              
              if [ "$adb_shell_ready" = false ]; then
                echo "‚ö†Ô∏è  ADB shell not responding after 150 seconds"
                echo "Checking emulator status:"
                adb devices -l
                echo ""
                echo "Checking emulator process:"
                ps aux | grep emulator | grep -v grep || echo "Emulator process not found"
                echo ""
                echo "Attempting to restart ADB..."
                adb kill-server
                sleep 3
                adb start-server
                sleep 5
                adb wait-for-device
                sleep 10
                
                # Extended retry after ADB restart
                echo "Retrying ADB shell connection (5 more attempts)..."
                for attempt in {1..5}; do
                  echo "  Post-restart attempt $attempt/5..."
                  if adb shell echo "test" > /dev/null 2>&1; then
                    echo "‚úÖ ADB shell connection recovered after restart (attempt $attempt)"
                    adb_shell_ready=true
                    break
                  fi
                  sleep 15
                done
                
                if [ "$adb_shell_ready" = false ]; then
                  echo "‚ùå ADB shell connection failed after all retries"
                  echo ""
                  echo "=== Emulator Log (last 100 lines) ==="
                  tail -100 emulator.log || echo "Could not read emulator log"
                  echo ""
                  echo "=== ADB Devices ==="
                  adb devices -l
                  echo ""
                  "‚ö†Ô∏è  Continuing anyway - tests may fail if emulator is not responsive"
                  # Don't exit - allow the pipeline to continue and let the test phase handle failures
                fi
              fi
              
              # Additional wait for stability after ADB connection verified
              if [ "$adb_shell_ready" = true ]; then
                echo "‚è≥ Additional stabilization wait (10 seconds)..."
                sleep 10
              fi
              
              # Verify package manager with retry
              echo "üîç Verifying package manager..."
              pm_verified=false
              for i in {1..5}; do
                echo "  Attempt $i/5: Checking package manager..."
                if adb shell pm list packages > /dev/null 2>&1; then
                  pm_verified=true
                  echo "‚úÖ Package manager verified"
                  break
                fi
                echo "  Retry $i/5 for package manager..."
                sleep 10
              done
              
              if [ "$pm_verified" = false ]; then
                echo "‚ö†Ô∏è  Package manager not responding reliably"
                echo "Checking system_server process:"
                adb shell ps | grep system_server || echo "Could not check system_server"
                echo "‚ö†Ô∏è  Continuing anyway - tests may fail if package manager is not ready"
              fi
              
              # Verify emulator is ready
              echo ""
              echo "üì± Emulator status:"
              adb devices -l
              
              # Try to get Android version with retry
              android_version="unknown"
              for i in {1..3}; do
                android_version=$(adb shell getprop ro.build.version.release 2>/dev/null | tr -d '\r\n')
                if [ -n "$android_version" ]; then
                  break
                fi
                sleep 3
              done
              echo "Android version: $android_version"
              
              # Try to get API level with retry
              api_level="unknown"
              for i in {1..3}; do
                api_level=$(adb shell getprop ro.build.version.sdk 2>/dev/null | tr -d '\r\n')
                if [ -n "$api_level" ]; then
                  break
                fi
                sleep 3
              done
              echo "API Level: $api_level"
              
              # Check for Google Play Store
              echo ""
              echo "üîç Checking for Google Play Store..."
              play_store_found=false
              for i in {1..3}; do
                if adb shell pm list packages 2>/dev/null | grep -q "com.android.vending"; then
                  play_store_found=true
                  echo "‚úÖ Google Play Store is present!"
                  PLAY_STORE_VERSION=$(adb shell dumpsys package com.android.vending 2>/dev/null | grep versionName | head -1 | awk '{print $1}' || echo "version unknown")
                  echo "Play Store: $PLAY_STORE_VERSION"
                  break
                fi
                echo "  Attempt $i/3: Play Store not detected yet, waiting..."
                sleep 10
              done
              
              if [ "$play_store_found" = false ]; then
                echo "‚ö†Ô∏è  Google Play Store not found after multiple checks"
                echo "üìã Checking Google services packages:"
                adb shell pm list packages 2>/dev/null | grep -i google | head -10 || echo "Could not list packages"
              fi
              
              # Get emulator serial
              EMULATOR_SERIAL=$(adb devices | grep "emulator" | head -1 | awk '{print $1}')
              echo ""
              echo "Emulator Serial: $EMULATOR_SERIAL"
              echo "##vso[task.setvariable variable=EMULATOR_SERIAL]$EMULATOR_SERIAL"
              
              echo ""
              echo "‚úÖ Android emulator setup complete!"
              echo "Note: If emulator is not fully responsive, tests may fail. Check emulator logs for details."
            displayName: 'Setup Android SDK and Create Emulator with Google Play'

          - task: Npm@1
            displayName: 'Install Appium'
            inputs:
              command: 'custom'
              customCommand: 'install -g appium@$(appiumVersion)'

          - bash: |
              echo "üîå Installing Appium UiAutomator2 Driver..."
              appium driver install uiautomator2
              appium driver list --installed
              echo "‚úÖ Driver installed"
            displayName: 'Install Appium Driver'

          - bash: |
              echo "üöÄ Starting Appium Server..."
              mkdir -p logs
              
              # Clean up any existing Appium processes
              pkill -f appium || true
              sleep 2
              
              # Start Appium
              nohup appium --address 127.0.0.1 --port 4723 --session-override --log-level info > logs/appium.log 2>&1 &
              APPIUM_PID=$!
              echo "Appium PID: $APPIUM_PID"
              echo "##vso[task.setvariable variable=APPIUM_PID]$APPIUM_PID"
              
              # Wait for Appium to be ready
              for i in {1..30}; do
                if curl -s http://127.0.0.1:4723/status > /dev/null 2>&1; then
                  echo "‚úÖ Appium server is ready"
                  exit 0
                fi
                echo "Waiting... ($i/30)"
                sleep 2
              done
              
              echo "‚ùå Appium failed to start"
              cat logs/appium.log
              exit 1
            displayName: 'Start Appium Server'

          - bash: |
              echo "üì≤ Installing Eptura Engage App..."
              echo "======================================================="
              
              # Define package name
              PACKAGE_NAME="com.condecosoftware.condeco"
              
              # Function to dismiss error dialogs
              dismiss_error_dialogs() {
                # Check for common error dialogs and dismiss them
                adb shell uiautomator dump /sdcard/window_dump_check.xml 2>/dev/null
                if adb pull /sdcard/window_dump_check.xml /tmp/error_check.xml 2>/dev/null; then
                  # Check for "isn't responding" dialogs
                  if grep -q "isn't responding\|not responding\|has stopped" /tmp/error_check.xml; then
                    echo "  ‚ö†Ô∏è  Detected error dialog, attempting to dismiss..."
                    
                    # Try to click "Wait" or "Close app" button
                    for BUTTON_TEXT in "Wait" "Close app" "OK"; do
                      if grep -q "text=\"$BUTTON_TEXT\"" /tmp/error_check.xml; then
                        BUTTON_LINE=$(grep "text=\"$BUTTON_TEXT\"" /tmp/error_check.xml | grep "clickable=\"true\"" | head -1)
                        if [ -n "$BUTTON_LINE" ]; then
                          BOUNDS=$(echo "$BUTTON_LINE" | sed 's/.*bounds="\[\([0-9]*\),\([0-9]*\)\]\[\([0-9]*\),\([0-9]*\)\]".*/\1 \2 \3 \4/')
                          if [ "$BOUNDS" != "$BUTTON_LINE" ]; then
                            X1=$(echo $BOUNDS | awk '{print $1}')
                            Y1=$(echo $BOUNDS | awk '{print $2}')
                            X2=$(echo $BOUNDS | awk '{print $3}')
                            Y2=$(echo $BOUNDS | awk '{print $4}')
                            TAP_X=$(( (X1 + X2) / 2 ))
                            TAP_Y=$(( (Y1 + Y2) / 2 ))
                            echo "  üñ±Ô∏è  Clicking '$BUTTON_TEXT' button..."
                            adb shell input tap $TAP_X $TAP_Y
                            sleep 2
                            return 0
                          fi
                        fi
                      fi
                    done
                    
                    # If buttons not found, try back button
                    echo "  ‚¨ÖÔ∏è  Trying back button..."
                    adb shell input keyevent KEYCODE_BACK
                    sleep 1
                    return 0
                  fi
                fi
                return 1
              }
              
              # Check if app is already installed
              if adb shell pm list packages | grep -q "$PACKAGE_NAME"; then
                echo "‚úÖ App is already installed!"
                APP_INFO=$(adb shell dumpsys package $PACKAGE_NAME | grep -E "versionName|versionCode" | head -2)
                echo "App info:"
                echo "$APP_INFO"
                exit 0
              fi
              
              echo "üì¶ Method 1: Attempting direct APK installation..."
              echo ""
              
              # Check if APK file is provided in the repo
              if [ -f "app/Eptura_Engage.apk" ] || [ -f "Eptura_Engage.apk" ]; then
                APK_PATH=$(find . -name "Eptura_Engage.apk" -o -name "condeco.apk" | head -1)
                echo "‚úÖ Found APK file: $APK_PATH"
                echo "üì• Installing APK..."
                
                adb install -r "$APK_PATH"
                
                if [ $? -eq 0 ]; then
                  echo "‚úÖ APK installed successfully!"
                  exit 0
                else
                  echo "‚ö†Ô∏è  APK installation failed, trying alternative methods..."
                fi
              else
                echo "‚ÑπÔ∏è  No APK file found in repository"
              fi
              
              echo ""
              echo "üì¶ Method 2: Using ADB to trigger Play Store installation..."
              echo ""
              
              # Dismiss any existing error dialogs before starting
              echo "üßπ Checking for and dismissing any error dialogs..."
              dismiss_error_dialogs
              
              # Close any running apps first
              echo "üßπ Closing any running apps..."
              adb shell am force-stop com.android.vending 2>/dev/null || true
              sleep 2
              
              # Clear Play Store cache to avoid issues
              echo "üßπ Clearing Play Store cache..."
              adb shell pm clear com.android.vending 2>/dev/null || true
              sleep 3
              
              echo "üîß Attempting to install via Play Store programmatically..."
              echo "Opening Play Store and triggering installation intent..."
              adb shell am start -a android.intent.action.VIEW \
                -d "market://details?id=$PACKAGE_NAME" \
                -f 0x10000000
              
              echo "‚è≥ Waiting for Play Store to open (15 seconds)..."
              sleep 15
              
              # Dismiss any error dialogs that appeared
              dismiss_error_dialogs
              
              # Take a screenshot for debugging
              echo "üì∏ Capturing screen for debugging..."
              adb shell screencap -p /sdcard/playstore_screen.png 2>/dev/null || true
              
              # Dump UI and save to file for inspection
              echo "üìã Dumping UI hierarchy for analysis..."
              adb shell uiautomator dump /sdcard/window_dump.xml 2>/dev/null
              sleep 2
              
              # Check if we're actually on the Play Store page
              PLAY_STORE_OPEN=false
              if adb pull /sdcard/window_dump.xml /tmp/ui_dump.xml 2>/dev/null; then
                if grep -q "com.android.vending" /tmp/ui_dump.xml; then
                  PLAY_STORE_OPEN=true
                  echo "‚úÖ Play Store page is open"
                else
                  echo "‚ö†Ô∏è  Play Store may not have opened correctly"
                fi
                
                echo ""
                echo "=== UI Dump Analysis ==="
                echo "Looking for Install/Open/Update buttons..."
                
                # Check what buttons are actually present
                if grep -iq "install" /tmp/ui_dump.xml; then
                  echo "‚úÖ Found 'Install' text in UI"
                  grep -i "install" /tmp/ui_dump.xml | grep "text=" | head -3
                elif grep -iq "open" /tmp/ui_dump.xml; then
                  echo "‚ö†Ô∏è  Found 'Open' button - app might already be installed"
                  grep -i "open" /tmp/ui_dump.xml | grep "text=" | head -3
                elif grep -iq "update" /tmp/ui_dump.xml; then
                  echo "‚ö†Ô∏è  Found 'Update' button - an older version might be installed"
                elif grep -iq "isn't responding\|not responding\|has stopped" /tmp/ui_dump.xml; then
                  echo "‚ùå ERROR: System error dialog detected!"
                  grep -i "isn't responding\|not responding\|has stopped" /tmp/ui_dump.xml | head -3
                  echo ""
                  echo "The emulator has stability issues. Showing full UI dump:"
                  cat /tmp/ui_dump.xml
                  echo ""
                  echo "‚ùå CRITICAL: Cannot proceed with Play Store installation due to system errors"
                  echo ""
                  echo "üí° RECOMMENDED SOLUTIONS:"
                  echo ""
                  echo "   Option 1 (BEST): Add APK file to repository"
                  echo "   - Download the Eptura Engage APK"
                  echo "   - Place it at: app/Eptura_Engage.apk"
                  echo "   - Commit and push to your repository"
                  echo "   - This method is reliable and doesn't depend on Play Store"
                  echo ""
                  echo "   Option 2: Use Azure Storage or secure download"
                  echo "   - Upload APK to Azure Storage or similar"
                  echo "   - Add download step before this installation step"
                  echo ""
                  echo "‚ö†Ô∏è  Play Store automation is NOT reliable in CI/CD environments!"
                  echo ""
                  exit 1
                else
                  echo "‚ö†Ô∏è  No Install/Open/Update button found"
                  echo "Showing clickable elements with text:"
                  grep -i "clickable=\"true\"" /tmp/ui_dump.xml | grep "text=" | grep -v 'text=""' | head -10
                fi
                echo "========================"
                echo ""
              fi
              
              # If system error detected, stop immediately
              if grep -q "isn't responding\|not responding\|has stopped" /tmp/ui_dump.xml 2>/dev/null; then
                echo "‚ùå Cannot continue - system errors present"
                exit 1
              fi
              
              echo ""
              echo "üì¶ Method 3: Advanced UI automation to click Install button..."
              echo ""
              
              # Try to find and click Install button
              INSTALL_FOUND=false
              
              if [ -f /tmp/ui_dump.xml ]; then
                # Look for Install button (case insensitive, multiple patterns)
                for PATTERN in "Install" "INSTALL" "install" "GET" "Get"; do
                  echo "  üîç Searching for button with text: $PATTERN"
                  
                  BUTTON_LINE=$(grep "text=\"$PATTERN\"" /tmp/ui_dump.xml | grep "clickable=\"true\"" | head -1)
                  
                  if [ -n "$BUTTON_LINE" ]; then
                    echo "  ‚úÖ Found clickable element with text '$PATTERN'"
                    
                    # Extract bounds using sed
                    BOUNDS=$(echo "$BUTTON_LINE" | sed 's/.*bounds="\[\([0-9]*\),\([0-9]*\)\]\[\([0-9]*\),\([0-9]*\)\]".*/\1 \2 \3 \4/')
                    
                    if [ "$BOUNDS" != "$BUTTON_LINE" ]; then
                      X1=$(echo $BOUNDS | awk '{print $1}')
                      Y1=$(echo $BOUNDS | awk '{print $2}')
                      X2=$(echo $BOUNDS | awk '{print $3}')
                      Y2=$(echo $BOUNDS | awk '{print $4}')
                      
                      TAP_X=$(( (X1 + X2) / 2 ))
                      TAP_Y=$(( (Y1 + Y2) / 2 ))
                      
                      echo "  üìç Button bounds: [$X1,$Y1][$X2,$Y2]"
                      echo "  üéØ Tapping at center: ($TAP_X, $TAP_Y)"
                      
                      adb shell input tap $TAP_X $TAP_Y
                      INSTALL_FOUND=true
                      
                      echo "  ‚úÖ Tapped! Waiting 5 seconds..."
                      sleep 5
                      
                      # Check if installation started
                      adb shell uiautomator dump /sdcard/window_dump2.xml 2>/dev/null
                      if adb pull /sdcard/window_dump2.xml /tmp/ui_dump2.xml 2>/dev/null; then
                        if grep -qi "downloading\|installing\|pending\|cancel" /tmp/ui_dump2.xml; then
                          echo "  ‚úÖ Installation appears to have started!"
                          break
                        else
                          echo "  ‚ö†Ô∏è  No installation progress detected"
                          INSTALL_FOUND=false
                        fi
                      fi
                    fi
                  fi
                done
              fi
              
              # If Install button not found or clicked, try alternative methods
              if [ "$INSTALL_FOUND" = false ]; then
                echo ""
                echo "  ‚ö†Ô∏è  Could not automatically click Install button"
                echo "  üì± Trying keyboard navigation..."
                
                # Try tab navigation and enter
                for i in {1..3}; do
                  adb shell input keyevent KEYCODE_TAB
                  sleep 0.5
                done
                adb shell input keyevent KEYCODE_ENTER
                sleep 3
              fi
              
              # Check for and handle account selection or permission dialogs
              echo ""
              echo "üîç Checking for account selection or permission dialogs..."
              adb shell uiautomator dump /sdcard/window_dump3.xml 2>/dev/null
              if adb pull /sdcard/window_dump3.xml /tmp/ui_dump3.xml 2>/dev/null; then
                for BUTTON_TEXT in "Continue" "CONTINUE" "Accept" "ACCEPT" "OK"; do
                  if grep -q "text=\"$BUTTON_TEXT\"" /tmp/ui_dump3.xml; then
                    BUTTON_LINE=$(grep "text=\"$BUTTON_TEXT\"" /tmp/ui_dump3.xml | grep "clickable=\"true\"" | head -1)
                    
                    if [ -n "$BUTTON_LINE" ]; then
                      echo "  ‚úÖ Found '$BUTTON_TEXT' button, clicking it..."
                      BOUNDS=$(echo "$BUTTON_LINE" | sed 's/.*bounds="\[\([0-9]*\),\([0-9]*\)\]\[\([0-9]*\),\([0-9]*\)\]".*/\1 \2 \3 \4/')
                      
                      if [ "$BOUNDS" != "$BUTTON_LINE" ]; then
                        X1=$(echo $BOUNDS | awk '{print $1}')
                        Y1=$(echo $BOUNDS | awk '{print $2}')
                        X2=$(echo $BOUNDS | awk '{print $3}')
                        Y2=$(echo $BOUNDS | awk '{print $4}')
                        
                        TAP_X=$(( (X1 + X2) / 2 ))
                        TAP_Y=$(( (Y1 + Y2) / 2 ))
                        
                        adb shell input tap $TAP_X $TAP_Y
                        sleep 3
                        break
                      fi
                    fi
                  fi
                done
              fi
              
              echo ""
              echo "‚è≥ Monitoring for app installation (max 3 minutes)..."
              echo "   Will check every 10 seconds for package installation"
              echo ""
              
              # Reduced monitoring loop - 3 minutes max instead of 10
              MAX_WAIT=180
              ELAPSED=0
              CHECK_INTERVAL=10
              ERROR_DIALOG_COUNT=0
              
              while [ $ELAPSED -lt $MAX_WAIT ]; do
                # Dismiss error dialogs
                if dismiss_error_dialogs; then
                  ERROR_DIALOG_COUNT=$((ERROR_DIALOG_COUNT + 1))
                  echo "  ‚ö†Ô∏è  Dismissed error dialog (count: $ERROR_DIALOG_COUNT)"
                  
                  # If too many errors, give up
                  if [ $ERROR_DIALOG_COUNT -ge 3 ]; then
                    echo ""
                    echo "‚ùå Too many system errors detected ($ERROR_DIALOG_COUNT)"
                    echo "The emulator is unstable and cannot complete Play Store installation"
                    echo ""
                    break
                  fi
                  
                  # Try reopening Play Store after error
                  echo "  üîÑ Reopening Play Store..."
                  adb shell am start -a android.intent.action.VIEW \
                    -d "market://details?id=$PACKAGE_NAME" \
                    -f 0x10000000
                  sleep 5
                fi
                
                # Check if package is installed
                if adb shell pm list packages 2>/dev/null | grep -q "$PACKAGE_NAME"; then
                  echo ""
                  echo "‚úÖ App package detected in system!"
                  sleep 5
                  
                  # Verify it's actually installed
                  if adb shell pm list packages | grep -q "$PACKAGE_NAME"; then
                    echo "‚úÖ Installation confirmed!"
                    
                    APP_INFO=$(adb shell dumpsys package $PACKAGE_NAME | grep -E "versionName|versionCode" | head -2 2>/dev/null || echo "version info unavailable")
                    echo ""
                    echo "üì± Installed app info:"
                    echo "$APP_INFO"
                    echo ""
                    exit 0
                  fi
                fi
                
                # Check UI state every 30 seconds
                if [ $((ELAPSED % 30)) -eq 0 ] && [ $ELAPSED -gt 0 ]; then
                  echo "  ‚è≥ Still waiting... ($ELAPSED seconds elapsed)"
                  
                  # Check UI for progress or errors
                  adb shell uiautomator dump /sdcard/window_dump_progress.xml 2>/dev/null
                  if adb pull /sdcard/window_dump_progress.xml /tmp/ui_progress.xml 2>/dev/null; then
                    if grep -q 'text="Open"' /tmp/ui_progress.xml || grep -q 'text="OPEN"' /tmp/ui_progress.xml; then
                      echo "     ‚úÖ 'Open' button detected - checking package manager..."
                    elif grep -qi "download\|install\|pending" /tmp/ui_progress.xml; then
                      echo "     üì• Installation in progress..."
                    elif grep -qi "error\|failed\|unable\|unavailable\|can't install" /tmp/ui_progress.xml; then
                      echo "     ‚ùå Error detected in UI!"
                      grep -i "error\|failed\|unable" /tmp/ui_progress.xml | grep "text=" | head -3
                      echo "     Installation appears to have failed"
                      break
                    else
                      echo "     ‚è≥ Play Store active (state unknown)"
                    fi
                  fi
                fi
                
                sleep $CHECK_INTERVAL
                ELAPSED=$((ELAPSED + CHECK_INTERVAL))
              done
              
              # Final check
              if adb shell pm list packages 2>/dev/null | grep -q "$PACKAGE_NAME"; then
                echo "‚úÖ App installed successfully!"
                exit 0
              fi
              
              echo ""
              echo "‚ùå Installation failed or timed out after $ELAPSED seconds"
              echo ""
              
              # Show final state
              if [ -f /tmp/ui_progress.xml ]; then
                echo "üìã Final UI state:"
                echo "=================="
                grep -i "install\|open\|download\|error\|unavailable\|failed" /tmp/ui_progress.xml | grep "text=" | grep -v 'text=""' | head -15 || echo "No relevant UI elements found"
                echo "=================="
              fi
              
              echo ""
              echo "‚ùå PLAY STORE AUTOMATION FAILED"
              echo ""
              echo "üí° SOLUTION: Play Store automation is unreliable in CI/CD environments."
              echo ""
              echo "   üì± RECOMMENDED: Add APK file to your repository"
              echo "   ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ"
              echo "   1. Download the Eptura Engage APK file"
              echo "   2. Create folder: mkdir -p app"
              echo "   3. Place APK: app/Eptura_Engage.apk"
              echo "   4. Commit and push to repository"
              echo "   5. This pipeline will automatically install it"
              echo ""
              echo "   Alternative options:"
              echo "   ‚Ä¢ Use Azure Storage with SAS token to download APK"
              echo "   ‚Ä¢ Build APK from source in pipeline"
              echo ""
              exit 1
            displayName: 'Install App from Play Store'
            continueOnError: false

          - task: DownloadBuildArtifacts@1
            displayName: 'Download Build Artifacts'
            inputs:
              buildType: 'current'
              downloadType: 'single'
              artifactName: 'build-output'
              downloadPath: '$(System.DefaultWorkingDirectory)'

          - task: Maven@4
            displayName: 'Run TestNG Tests'
            inputs:
              mavenPomFile: '$(mavenPOMFile)'
              goals: 'test'
              options: '-Dtestng.xml=testng.xml'
              publishJUnitResults: true
              testResultsFiles: '**/surefire-reports/TEST-*.xml'
              testRunTitle: 'Eptura Engage Android Tests'
              javaHomeOption: 'JDKVersion'
              jdkVersionOption: '$(jdkVersion)'
              mavenVersionOption: 'Default'
              mavenOptions: '-Xmx3072m'
            env:
              USE_EXTERNAL_APPIUM: 'true'
              APPIUM_SERVER_URL: 'http://127.0.0.1:4723'
            continueOnError: true

          - bash: |
              echo "üßπ Cleanup: Stopping Appium Server..."
              pkill -f appium || true
            displayName: 'Stop Appium Server'
            condition: always()

          - bash: |
              echo "üßπ Cleanup: Stopping Emulator..."
              adb emu kill || true
              pkill -f "emulator.*$(emulatorName)" || true
              sleep 5
            displayName: 'Stop Emulator'
            condition: always()

          - task: PublishTestResults@2
            displayName: 'Publish Test Results'
            inputs:
              testResultsFormat: 'JUnit'
              testResultsFiles: '**/surefire-reports/TEST-*.xml'
              mergeTestResults: true
              failTaskOnFailedTests: false
              testRunTitle: 'Eptura Android Tests'
            condition: always()

          - task: PublishBuildArtifacts@1
            displayName: 'Publish Screenshots'
            inputs:
              PathtoPublish: '$(screenshotsFolder)'
              ArtifactName: 'test-screenshots'
            condition: always()

          - task: PublishBuildArtifacts@1
            displayName: 'Publish Extent Report'
            inputs:
              PathtoPublish: '$(extentReportFolder)/Extent-report.html'
              ArtifactName: 'extent-report'
            condition: always()

          - task: PublishBuildArtifacts@1
            displayName: 'Publish Logs'
            inputs:
              PathtoPublish: '$(System.DefaultWorkingDirectory)/logs'
              ArtifactName: 'appium-logs'
            condition: always()

          - bash: |
              if [ -f emulator.log ]; then
                mkdir -p logs
                cp emulator.log logs/
              fi
            displayName: 'Collect Emulator Logs'
            condition: always()

          - task: PublishBuildArtifacts@1
            displayName: 'Publish Emulator Logs'
            inputs:
              PathtoPublish: '$(System.DefaultWorkingDirectory)/logs'
              ArtifactName: 'emulator-logs'
            condition: always()

  - stage: Report
    displayName: 'Test Reports'
    dependsOn: Test
    condition: always()
    jobs:
      - job: Summary
        displayName: 'Test Summary'
        steps:
          - task: DownloadBuildArtifacts@1
            inputs:
              buildType: 'current'
              downloadType: 'specific'
              itemPattern: '**'
              downloadPath: '$(System.DefaultWorkingDirectory)/artifacts'

          - bash: |
              echo "üìä Test Execution Summary"
              echo "=========================="
              if [ -d "artifacts/test-screenshots" ]; then
                SCREENSHOT_COUNT=$(find artifacts/test-screenshots -type f -name "*.png" | wc -l)
                echo "üì∏ Screenshots: $SCREENSHOT_COUNT"
              fi
              
              if [ -f "artifacts/extent-report/Extent-report.html" ]; then
                echo "‚úÖ Extent Report: Available"
              fi
              
              echo ""
              echo "View artifacts in the 'Summary' tab of this pipeline run"
            displayName: 'Display Summary'
