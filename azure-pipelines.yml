# Azure Pipeline for Eptura Engage Android Automation
# Consolidated version with proven emulator startup and comprehensive features

trigger:
  branches:
    include:
      - main
      - master
      - develop
  paths:
    exclude:
      - README.md
      - docs/**

pr:
  branches:
    include:
      - main
      - master
      - develop

# Pipeline variables
variables:
  mavenPOMFile: 'pom.xml'
  jdkVersion: '17'
  appiumVersion: '3.0.0'
  androidSdkVersion: '34'
  testResultsFolder: '$(System.DefaultWorkingDirectory)/target/surefire-reports'
  screenshotsFolder: '$(System.DefaultWorkingDirectory)/target/screenshots'
  extentReportFolder: '$(System.DefaultWorkingDirectory)/target'
  emulatorName: 'test_emulator'

# Agent pool - Use Microsoft-hosted macOS agents for better Android emulator performance
pool:
  vmImage: 'macOS-14'  # Latest stable macOS with better emulator support

stages:
  - stage: Build
    displayName: 'Build Stage'
    jobs:
      - job: MavenBuild
        displayName: 'Build Maven Project'
        steps:
          - task: JavaToolInstaller@0
            displayName: 'Install Java JDK 17'
            inputs:
              versionSpec: '17'
              jdkArchitectureOption: 'x64'
              jdkSourceOption: 'PreInstalled'

          - task: Maven@4
            displayName: 'Maven Clean Compile'
            inputs:
              mavenPomFile: '$(mavenPOMFile)'
              goals: 'clean compile'
              options: '-DskipTests'
              publishJUnitResults: false
              javaHomeOption: 'JDKVersion'
              jdkVersionOption: '$(jdkVersion)'
              mavenVersionOption: 'Default'
              mavenOptions: '-Xmx3072m'

          - task: PublishBuildArtifacts@1
            displayName: 'Publish Build Artifacts'
            inputs:
              PathtoPublish: '$(System.DefaultWorkingDirectory)/target'
              ArtifactName: 'build-output'
              publishLocation: 'Container'

  - stage: Test
    displayName: 'Test Stage'
    dependsOn: Build
    jobs:
      - job: AndroidTests
        displayName: 'Run Android Appium Tests'
        timeoutInMinutes: 120
        steps:
          - task: JavaToolInstaller@0
            displayName: 'Install Java JDK 17'
            inputs:
              versionSpec: '17'
              jdkArchitectureOption: 'x64'
              jdkSourceOption: 'PreInstalled'

          - task: NodeTool@0
            displayName: 'Install Node.js'
            inputs:
              versionSpec: '20.x'

          - bash: |
              echo "üêç Installing Python dependencies..."
              pip3 install --break-system-packages Appium-Python-Client selenium || pip install Appium-Python-Client selenium
              echo "‚úÖ Python dependencies installed"
            displayName: 'Install Python Dependencies'

          - bash: |
              echo "üì± Setting up Android Emulator with ENHANCED approach..."
              echo "============================================================================"
              
              # Set environment variables
              export ANDROID_HOME=$ANDROID_SDK_ROOT
              export PATH=$PATH:$ANDROID_HOME/platform-tools:$ANDROID_HOME/emulator:$ANDROID_HOME/cmdline-tools/latest/bin
              
              echo "ANDROID_HOME: $ANDROID_HOME"
              echo "System Info:"
              sysctl -n hw.ncpu
              sysctl -n hw.memsize | awk '{print $0/1024/1024/1024 " GB"}'
              
              # Kill any existing processes
              $ANDROID_HOME/platform-tools/adb kill-server || true
              pkill -9 qemu-system || true
              pkill -9 emulator || true
              sleep 3
              
              # Accept licenses
              yes | sdkmanager --licenses || true
              
              # Update SDK tools first
              echo "üì¶ Updating SDK tools..."
              sdkmanager --update
              
              # Install required components - try API 30 as fallback (more stable on CI)
              echo "üì¶ Installing SDK components (trying API 30 for better stability)..."
              sdkmanager --install \
                "platform-tools" \
                "platforms;android-30" \
                "build-tools;30.0.3" \
                "emulator" \
                "system-images;android-30;google_apis_playstore;x86_64"
              
              # Verify installation
              echo "üîç Verifying system images..."
              sdkmanager --list_installed | grep system-images
              
              # Create AVD with optimal settings for CI
              echo "üì± Creating emulator AVD (API 30 for stability)..."
              echo "no" | avdmanager create avd \
                --force \
                --name "ci_emulator" \
                --package "system-images;android-30;google_apis_playstore;x86_64" \
                --device "pixel_4" \
                --tag "google_apis_playstore"
              
              # Configure AVD for better performance
              AVD_PATH="$HOME/.android/avd/ci_emulator.avd"
              
              # Optimize config.ini
              cat >> "$AVD_PATH/config.ini" << EOF
              hw.cpu.ncore=2
              hw.ramSize=4096
              hw.keyboard=yes
              hw.gpu.enabled=yes
              hw.gpu.mode=swiftshader_indirect
              disk.dataPartition.size=6G
              fastboot.forceColdBoot=no
              hw.camera.back=none
              hw.camera.front=none
              EOF
              
              echo "‚úÖ AVD created and configured"
              $ANDROID_HOME/emulator/emulator -list-avds
              
            displayName: 'Setup Android SDK and AVD'

          - bash: |
              echo "üöÄ Starting Android Emulator with OPTIMIZED BOOT..."
              echo "============================================================================"
              
              export ANDROID_HOME=$ANDROID_SDK_ROOT
              export PATH=$PATH:$ANDROID_HOME/platform-tools:$ANDROID_HOME/emulator
              
              # Start ADB server FIRST (before emulator) to avoid offline state issues
              echo "Starting ADB server early..."
              $ANDROID_HOME/platform-tools/adb start-server
              sleep 3
              
              # Configure advanced features for hardware acceleration
              mkdir -p ~/.android
              cat > ~/.android/advancedFeatures.ini << EOF
              Vulkan = off
              GLDirectMem = on
              GLDMA = on
              HostComposition = off
              HVF = on
              KVM = off
              EOF
              
              # Start emulator with optimized flags - use -wipe-data for faster clean boot
              echo "Starting emulator in background..."
              $ANDROID_HOME/emulator/emulator \
                -avd ci_emulator \
                -no-window \
                -no-audio \
                -no-boot-anim \
                -gpu swiftshader_indirect \
                -no-snapshot \
                -wipe-data \
                -memory 4096 \
                -cores 2 \
                -camera-back none \
                -camera-front none \
                -accel on \
                -netdelay none \
                -netspeed full \
                -qemu -m 4096 \
                > emulator.log 2>&1 &
              
              EMULATOR_PID=$!
              echo "Emulator PID: $EMULATOR_PID"
              
              # Wait for emulator to appear in ADB
              echo "‚è≥ Waiting for emulator to appear in ADB..."
              sleep 10
              
              # Optimized boot wait logic - less aggressive polling
              echo "‚è≥ Waiting for emulator to boot (max 8 minutes)..."
              
              TIMEOUT=480
              ELAPSED=0
              BOOT_COMPLETE=false
              DEVICE_ONLINE=false
              ADB_RESTART_COUNT=0
              MAX_ADB_RESTARTS=2
              
              while [ $ELAPSED -lt $TIMEOUT ]; do
                # Check emulator process health
                if ! ps -p $EMULATOR_PID > /dev/null 2>&1; then
                  echo "‚ùå Emulator process died unexpectedly!"
                  echo "=== Last 100 lines of emulator log ==="
                  tail -100 emulator.log
                  exit 1
                fi
                
                # Get device state
                DEVICE_STATE=$($ANDROID_HOME/platform-tools/adb devices | grep emulator | awk '{print $2}')
                
                # Only restart ADB if really needed and not too many times
                if [ -z "$DEVICE_STATE" ] && [ $ELAPSED -gt 120 ] && [ $ADB_RESTART_COUNT -lt $MAX_ADB_RESTARTS ]; then
                  if [ $((ELAPSED % 120)) -eq 0 ]; then
                    echo "‚ö†Ô∏è  No device found after 2+ minutes, restarting ADB (attempt $((ADB_RESTART_COUNT + 1))/$MAX_ADB_RESTARTS)..."
                    $ANDROID_HOME/platform-tools/adb kill-server
                    sleep 2
                    $ANDROID_HOME/platform-tools/adb start-server
                    sleep 3
                    ADB_RESTART_COUNT=$((ADB_RESTART_COUNT + 1))
                    $ANDROID_HOME/platform-tools/adb devices
                  fi
                fi
                
                if [ "$DEVICE_STATE" = "device" ]; then
                  if [ "$DEVICE_ONLINE" = false ]; then
                    echo "‚úÖ Device is online at ${ELAPSED}s!"
                    DEVICE_ONLINE=true
                  fi
                  
                  # Check boot completion
                  BOOT_STATUS=$($ANDROID_HOME/platform-tools/adb -s emulator-5554 shell getprop sys.boot_completed 2>&1 | tr -d '\r\n')
                  
                  if [ "$BOOT_STATUS" = "1" ]; then
                    echo "‚úÖ Boot completed successfully in ${ELAPSED}s!"
                    BOOT_COMPLETE=true
                    break
                  fi
                elif [ "$DEVICE_STATE" = "offline" ]; then
                  # Device offline - wait longer before trying recovery (only once)
                  if [ $ELAPSED -gt 120 ] && [ $ADB_RESTART_COUNT -lt $MAX_ADB_RESTARTS ]; then
                    if [ $((ELAPSED % 120)) -eq 0 ]; then
                      echo "‚ö†Ô∏è  Device stuck offline, attempting recovery (attempt $((ADB_RESTART_COUNT + 1))/$MAX_ADB_RESTARTS)..."
                      $ANDROID_HOME/platform-tools/adb kill-server
                      sleep 2
                      $ANDROID_HOME/platform-tools/adb start-server
                      sleep 3
                      ADB_RESTART_COUNT=$((ADB_RESTART_COUNT + 1))
                    fi
                  fi
                fi
                
                # Progress updates every 20 seconds (less verbose)
                if [ $((ELAPSED % 20)) -eq 0 ]; then
                  echo "  Status: ${DEVICE_STATE:-none} | Time: ${ELAPSED}s / ${TIMEOUT}s"
                fi
                
                # Poll every 10 seconds instead of 5 (reduce overhead)
                sleep 10
                ELAPSED=$((ELAPSED + 10))
              done
              
              if [ "$BOOT_COMPLETE" = false ]; then
                echo "‚ùå Emulator failed to boot within timeout!"
                echo ""
                echo "=== Final Device Status ==="
                $ANDROID_HOME/platform-tools/adb devices -l
                echo ""
                echo "=== Emulator Log (last 200 lines) ==="
                tail -200 emulator.log
                exit 1
              fi
              
              # Minimal post-boot stabilization
              echo "‚è≥ Waiting for system stability (5s)..."
              sleep 5
              
              # Quick package manager check
              echo "‚è≥ Verifying package manager..."
              for i in {1..15}; do
                if $ANDROID_HOME/platform-tools/adb -s emulator-5554 shell pm path android > /dev/null 2>&1; then
                  echo "‚úÖ Package manager ready!"
                  break
                fi
                sleep 1
              done
              
              # Performance optimizations
              echo "üé¨ Applying optimizations..."
              $ANDROID_HOME/platform-tools/adb -s emulator-5554 shell settings put global window_animation_scale 0 2>/dev/null || true
              $ANDROID_HOME/platform-tools/adb -s emulator-5554 shell settings put global transition_animation_scale 0 2>/dev/null || true
              $ANDROID_HOME/platform-tools/adb -s emulator-5554 shell settings put global animator_duration_scale 0 2>/dev/null || true
              $ANDROID_HOME/platform-tools/adb -s emulator-5554 shell input keyevent 82 2>/dev/null || true
              
              # Final verification
              echo ""
              echo "‚úÖ EMULATOR FULLY READY!"
              echo "============================================================================"
              $ANDROID_HOME/platform-tools/adb devices -l
              echo "Android Version: $($ANDROID_HOME/platform-tools/adb -s emulator-5554 shell getprop ro.build.version.release | tr -d '\r\n')"
              echo "API Level: $($ANDROID_HOME/platform-tools/adb -s emulator-5554 shell getprop ro.build.version.sdk | tr -d '\r\n')"
              echo "Device Model: $($ANDROID_HOME/platform-tools/adb -s emulator-5554 shell getprop ro.product.model | tr -d '\r\n')"
              
              # Check Google Play availability
              if $ANDROID_HOME/platform-tools/adb -s emulator-5554 shell pm list packages 2>/dev/null | grep -q "com.android.vending"; then
                echo "‚úÖ Google Play Store: AVAILABLE"
              else
                echo "‚ö†Ô∏è  Google Play Store: NOT FOUND (will need APK file for app installation)"
              fi
              
              echo "============================================================================"
              echo "üéâ Ready for test execution!"
              
            displayName: 'Start Emulator and Wait for Boot'

          - task: Npm@1
            displayName: 'Install Appium'
            inputs:
              command: 'custom'
              customCommand: 'install -g appium@$(appiumVersion)'

          - bash: |
              appium driver install uiautomator2
              appium driver list --installed
            displayName: 'Install Appium UiAutomator2 Driver'

          - bash: |
              echo "üöÄ Starting Appium Server..."
              mkdir -p logs
              
              pkill -f appium || true
              sleep 2
              
              nohup appium --address 127.0.0.1 --port 4723 --session-override --log-level info > logs/appium.log 2>&1 &
              APPIUM_PID=$!
              echo "Appium PID: $APPIUM_PID"
              
              # Wait for Appium to be ready
              for i in {1..30}; do
                if curl -s http://127.0.0.1:4723/status > /dev/null 2>&1; then
                  echo "‚úÖ Appium server is ready"
                  exit 0
                fi
                echo "Waiting for Appium... ($i/30)"
                sleep 2
              done
              
              echo "‚ùå Appium failed to start"
              cat logs/appium.log
              exit 1
            displayName: 'Start Appium Server'

          - bash: |
              echo "üì≤ Installing Eptura Engage App..."
              export ANDROID_HOME=$ANDROID_SDK_ROOT
              ADB="$ANDROID_HOME/platform-tools/adb"
              PACKAGE_NAME="com.condecosoftware.condeco"
              
              # CRITICAL: Verify device is online and ready before proceeding
              echo "üîç Verifying device readiness..."
              MAX_WAIT=60
              WAITED=0
              DEVICE_READY=false
              
              while [ $WAITED -lt $MAX_WAIT ]; do
                DEVICE_STATE=$("$ADB" devices | grep emulator | awk '{print $2}')
                
                if [ "$DEVICE_STATE" = "device" ]; then
                  # Double-check with a simple ADB command
                  if "$ADB" shell getprop sys.boot_completed 2>/dev/null | grep -q "1"; then
                    echo "‚úÖ Device is online and ready!"
                    DEVICE_READY=true
                    break
                  fi
                fi
                
                if [ "$DEVICE_STATE" = "offline" ]; then
                  echo "‚ö†Ô∏è  Device offline at ${WAITED}s, waiting... (State: $DEVICE_STATE)"
                elif [ -z "$DEVICE_STATE" ]; then
                  echo "‚ö†Ô∏è  No device found at ${WAITED}s, waiting..."
                fi
                
                sleep 3
                WAITED=$((WAITED + 3))
              done
              
              if [ "$DEVICE_READY" = false ]; then
                echo "‚ùå Device not ready after ${MAX_WAIT}s!"
                echo "Current device state:"
                "$ADB" devices -l
                exit 1
              fi
              
              # Additional stability wait
              echo "‚è≥ Waiting 5s for stability..."
              sleep 5
              
              # Check if already installed
              echo "üîç Checking if app is already installed..."
              if "$ADB" shell pm list packages 2>/dev/null | grep -q "$PACKAGE_NAME"; then
                echo "‚úÖ App is already installed!"
                exit 0
              fi
              
              # Method 1: Check for APK in repo
              echo "üîç Looking for APK file in repository..."
              if [ -f "app/Eptura_Engage.apk" ] || [ -f "Eptura_Engage.apk" ]; then
                APK_PATH=$(find . -name "Eptura_Engage.apk" -o -name "condeco.apk" | head -1)
                echo "‚úÖ Found APK: $APK_PATH"
                
                # Verify device is still ready before install
                if "$ADB" shell getprop sys.boot_completed 2>/dev/null | grep -q "1"; then
                  echo "üì¶ Installing APK..."
                  "$ADB" install -r "$APK_PATH"
                  if [ $? -eq 0 ]; then
                    echo "‚úÖ APK installed successfully!"
                    exit 0
                  else
                    echo "‚ö†Ô∏è  APK installation failed, trying Play Store method..."
                  fi
                else
                  echo "‚ö†Ô∏è  Device went offline before APK install!"
                fi
              else
                echo "‚ö†Ô∏è  No APK file found in repository"
              fi
              
              # Method 2: Use Python script for Play Store
              if [ -f "src/main/resources/install_from_playstore.py" ]; then
                echo "üì¶ Attempting Play Store installation..."
                
                # Verify device is still ready
                if ! "$ADB" shell getprop sys.boot_completed 2>/dev/null | grep -q "1"; then
                  echo "‚ö†Ô∏è  Device offline, waiting 10s for recovery..."
                  sleep 10
                fi
                
                # Create screenshot directory for debugging
                mkdir -p playstore_screenshots
                
                # Set Python command
                if command -v python3 &> /dev/null; then
                  PYTHON_CMD=python3
                else
                  PYTHON_CMD=python
                fi
                
                $PYTHON_CMD src/main/resources/install_from_playstore.py || {
                  echo "‚ö†Ô∏è Play Store installation had issues but continuing..."
                }
                
                # Verify installation
                if "$ADB" shell pm list packages 2>/dev/null | grep -q "$PACKAGE_NAME"; then
                  echo "‚úÖ Play Store installation successful!"
                  exit 0
                fi
              fi
              
              echo "‚ùå Could not install app - please provide APK file or configure Play Store credentials"
              echo ""
              echo "=== Final Device Status ==="
              "$ADB" devices -l
              exit 1
            displayName: 'Install Eptura Engage App'
            continueOnError: true
            env:
              GOOGLE_EMAIL: $(GOOGLE_PLAY_EMAIL)
              GOOGLE_PASSWORD: $(GOOGLE_PLAY_PASSWORD)

          - task: PublishBuildArtifacts@1
            displayName: 'Publish Play Store Screenshots'
            inputs:
              PathtoPublish: '$(System.DefaultWorkingDirectory)/playstore_screenshots'
              ArtifactName: 'playstore-debug-screenshots'
            condition: and(always(), eq(variables['Agent.JobStatus'], 'Succeeded'))
            continueOnError: true

          - task: PublishBuildArtifacts@1
            displayName: 'Publish Play Store Video Recordings'
            inputs:
              PathtoPublish: '$(System.DefaultWorkingDirectory)/playstore-recordings'
              ArtifactName: 'playstore-video-recordings'
            condition: always()

          - task: DownloadBuildArtifacts@1
            displayName: 'Download Build Artifacts'
            inputs:
              buildType: 'current'
              downloadType: 'single'
              artifactName: 'build-output'
              downloadPath: '$(System.DefaultWorkingDirectory)'

          - task: Maven@4
            displayName: 'Run TestNG Tests'
            inputs:
              mavenPomFile: '$(mavenPOMFile)'
              goals: 'test'
              options: '-Dtestng.xml=testng.xml'
              publishJUnitResults: true
              testResultsFiles: '**/surefire-reports/TEST-*.xml'
              testRunTitle: 'Eptura Engage Android Tests'
              javaHomeOption: 'JDKVersion'
              jdkVersionOption: '$(jdkVersion)'
              mavenVersionOption: 'Default'
              mavenOptions: '-Xmx3072m'
            env:
              USE_EXTERNAL_APPIUM: 'true'
              APPIUM_SERVER_URL: 'http://127.0.0.1:4723'
            continueOnError: true

          # Cleanup
          - bash: |
              pkill -f appium || true
              export ANDROID_HOME=$ANDROID_SDK_ROOT
              $ANDROID_HOME/platform-tools/adb emu kill || true
              pkill -9 qemu-system || true
              pkill -9 emulator || true
            displayName: 'Cleanup'
            condition: always()

          # Publish artifacts
          - task: PublishTestResults@2
            displayName: 'Publish Test Results'
            inputs:
              testResultsFormat: 'JUnit'
              testResultsFiles: '**/surefire-reports/TEST-*.xml'
              mergeTestResults: true
              failTaskOnFailedTests: false
              testRunTitle: 'Eptura Android Tests'
            condition: always()

          - task: PublishBuildArtifacts@1
            displayName: 'Publish Screenshots'
            inputs:
              PathtoPublish: '$(screenshotsFolder)'
              ArtifactName: 'test-screenshots'
            condition: always()

          - task: PublishBuildArtifacts@1
            displayName: 'Publish Extent Report'
            inputs:
              PathtoPublish: '$(extentReportFolder)/Extent-report.html'
              ArtifactName: 'extent-report'
            condition: always()

          - task: PublishBuildArtifacts@1
            displayName: 'Publish Logs'
            inputs:
              PathtoPublish: '$(System.DefaultWorkingDirectory)/logs'
              ArtifactName: 'appium-logs'
            condition: always()

          - bash: |
              if [ -f emulator.log ]; then
                mkdir -p logs
                cp emulator.log logs/
              fi
            displayName: 'Collect Emulator Logs'
            condition: always()

          - task: PublishBuildArtifacts@1
            displayName: 'Publish Emulator Logs'
            inputs:
              PathtoPublish: '$(System.DefaultWorkingDirectory)/logs'
              ArtifactName: 'emulator-logs'
            condition: always()

  - stage: Report
    displayName: 'Test Reports'
    dependsOn: Test
    condition: always()
    jobs:
      - job: Summary
        displayName: 'Test Summary'
        steps:
          - task: DownloadBuildArtifacts@1
            inputs:
              buildType: 'current'
              downloadType: 'specific'
              itemPattern: '**'
              downloadPath: '$(System.DefaultWorkingDirectory)/artifacts'

          - bash: |
              echo "üìä Test Execution Summary"
              echo "=========================="
              if [ -d "artifacts/test-screenshots" ]; then
                SCREENSHOT_COUNT=$(find artifacts/test-screenshots -type f -name "*.png" | wc -l)
                echo "üì∏ Screenshots: $SCREENSHOT_COUNT"
              fi
              
              if [ -f "artifacts/extent-report/Extent-report.html" ]; then
                echo "‚úÖ Extent Report: Available"
              fi
              
              echo ""
              echo "View artifacts in the 'Summary' tab of this pipeline run"
            displayName: 'Display Summary'
