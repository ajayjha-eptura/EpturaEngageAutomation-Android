# Azure Pipeline for Eptura Engage Android Automation
# This pipeline builds and runs Android Appium tests

trigger:
  branches:
    include:
      - main
      - master
      - develop
  paths:
    exclude:
      - README.md
      - docs/**

pr:
  branches:
    include:
      - main
      - master
      - develop

# Pipeline variables
variables:
  mavenPOMFile: 'pom.xml'
  jdkVersion: '11'  # Fixed: Changed from '1.11' to '11'
  appiumVersion: '3.0.0'  # Updated to Appium 3.x for compatibility with latest drivers
  androidSdkVersion: '30'
  testResultsFolder: '$(System.DefaultWorkingDirectory)/target/surefire-reports'
  screenshotsFolder: '$(System.DefaultWorkingDirectory)/target/screenshots'
  extentReportFolder: '$(System.DefaultWorkingDirectory)/target'

# Agent pool - Use Microsoft-hosted agents or self-hosted agents with Android SDK
pool:
  vmImage: 'macOS-latest'  # Using macOS agents which have Android SDK pre-installed
  # For Windows agents, use: vmImage: 'windows-latest'
  # For self-hosted Windows agents with Android devices, use:
  # name: 'YourSelfHostedPool'

stages:
  - stage: Build
    displayName: 'Build Stage'
    jobs:
      - job: MavenBuild
        displayName: 'Build Maven Project'
        steps:
          - task: JavaToolInstaller@0
            displayName: 'Install Java JDK 11'
            inputs:
              versionSpec: '11'
              jdkArchitectureOption: 'x64'
              jdkSourceOption: 'PreInstalled'

          - task: Maven@4
            displayName: 'Maven Clean Compile'
            inputs:
              mavenPomFile: '$(mavenPOMFile)'
              goals: 'clean compile'
              options: '-DskipTests'
              publishJUnitResults: false
              javaHomeOption: 'JDKVersion'
              jdkVersionOption: '$(jdkVersion)'
              mavenVersionOption: 'Default'
              mavenOptions: '-Xmx3072m'

          - task: PublishBuildArtifacts@1
            displayName: 'Publish Build Artifacts'
            inputs:
              PathtoPublish: '$(System.DefaultWorkingDirectory)/target'
              ArtifactName: 'build-output'
              publishLocation: 'Container'

  - stage: Test
    displayName: 'Test Stage'
    dependsOn: Build
    jobs:
      - job: AndroidTests
        displayName: 'Run Android Appium Tests'
        timeoutInMinutes: 90
        steps:
          - task: JavaToolInstaller@0
            displayName: 'Install Java JDK 11'
            inputs:
              versionSpec: '11'
              jdkArchitectureOption: 'x64'
              jdkSourceOption: 'PreInstalled'

          - task: NodeTool@0
            displayName: 'Install Node.js'
            inputs:
              versionSpec: '20.x'

          # Install Android SDK (if not using macOS agent with pre-installed SDK)
          - bash: |
              echo "üì± Setting up Android SDK..."
              export ANDROID_HOME=$HOME/android-sdk
              export PATH=$PATH:$ANDROID_HOME/tools:$ANDROID_HOME/platform-tools
              
              # Check if Android SDK is already installed
              if [ ! -d "$ANDROID_HOME" ]; then
                echo "Installing Android SDK..."
                mkdir -p $ANDROID_HOME
                cd $ANDROID_HOME
                wget -q https://dl.google.com/android/repository/commandlinetools-linux-9477386_latest.zip
                unzip -q commandlinetools-linux-9477386_latest.zip
                mkdir -p cmdline-tools/latest
                mv cmdline-tools/* cmdline-tools/latest/ || true
                export PATH=$ANDROID_HOME/cmdline-tools/latest/bin:$PATH
                yes | sdkmanager --licenses || true
                sdkmanager "platform-tools" "platforms;android-$(androidSdkVersion)" "build-tools;30.0.3"
              fi
              
              echo "‚úÖ Android SDK setup complete"
              echo "##vso[task.setvariable variable=ANDROID_HOME]$ANDROID_HOME"
            displayName: 'Setup Android SDK'
            condition: eq(variables['Agent.OS'], 'Linux')

          # For macOS agents (already have Android SDK)
          - bash: |
              echo "üì± Configuring Android SDK on macOS..."
              
              # Try multiple possible Android SDK locations
              if [ -n "$ANDROID_SDK_ROOT" ]; then
                export ANDROID_HOME=$ANDROID_SDK_ROOT
                echo "Using ANDROID_SDK_ROOT: $ANDROID_SDK_ROOT"
              elif [ -n "$ANDROID_HOME" ]; then
                echo "ANDROID_HOME already set: $ANDROID_HOME"
              elif [ -d "$HOME/Library/Android/sdk" ]; then
                export ANDROID_HOME="$HOME/Library/Android/sdk"
                echo "Using default macOS location: $ANDROID_HOME"
              else
                echo "‚ùå Android SDK not found!"
                echo "Attempting to install Android SDK..."
                brew install --cask android-commandlinetools || true
                export ANDROID_HOME="$HOME/Library/Android/sdk"
              fi
              
              # Add Android SDK tools to PATH
              export PATH=$PATH:$ANDROID_HOME/platform-tools:$ANDROID_HOME/emulator:$ANDROID_HOME/tools:$ANDROID_HOME/tools/bin
              
              # Verify Android SDK
              echo "ANDROID_HOME: $ANDROID_HOME"
              echo "Checking for platform-tools..."
              ls -la "$ANDROID_HOME/platform-tools" || echo "Platform tools not found"
              
              # Check ADB
              if command -v adb &> /dev/null; then
                echo "‚úÖ ADB found: $(which adb)"
                adb version
              else
                echo "‚ö†Ô∏è ADB not found in PATH"
              fi
              
              # Set environment variable for subsequent steps
              echo "##vso[task.setvariable variable=ANDROID_HOME]$ANDROID_HOME"
              echo "##vso[task.setvariable variable=PATH]$PATH"
            displayName: 'Configure Android SDK (macOS)'
            condition: eq(variables['Agent.OS'], 'Darwin')

          # For Windows agents - Install Android SDK Command-line Tools
          - powershell: |
              $ErrorActionPreference = "Stop"
              
              # Define Android SDK paths
              $androidSdkRoot = "$env:USERPROFILE\AppData\Local\Android\Sdk"
              $cmdlineToolsZip = "commandlinetools-win-9477386_latest.zip"
              
              # Check if Android SDK is already installed
              if (-Not (Test-Path $androidSdkRoot)) {
                Write-Host "Installing Android SDK..."
                mkdir $androidSdkRoot
                
                # Download and install Command-line Tools
                Invoke-WebRequest -Uri "https://dl.google.com/android/repository/$cmdlineToolsZip" -OutFile $cmdlineToolsZip
                Expand-Archive -Path $cmdlineToolsZip -DestinationPath $androidSdkRoot -Force
                Remove-Item -Path $cmdlineToolsZip
                
                # Set environment variables
                [System.Environment]::SetEnvironmentVariable("ANDROID_HOME", $androidSdkRoot, [System.EnvironmentVariableTarget]::User)
                [System.Environment]::SetEnvironmentVariable("PATH", "$env:PATH;$androidSdkRoot\cmdline-tools\latest\bin;$androidSdkRoot\platform-tools;$androidSdkRoot\emulator", [System.EnvironmentVariableTarget]::User)
                
                # Accept licenses and install SDK components
                & "$androidSdkRoot\cmdline-tools\latest\bin\sdkmanager" --licenses
                & "$androidSdkRoot\cmdline-tools\latest\bin\sdkmanager" "platform-tools" "platforms;android-$(androidSdkVersion)" "build-tools;30.0.3"
              }
              
              Write-Host "‚úÖ Android SDK setup complete"
            displayName: 'Setup Android SDK (Windows)'
            condition: eq(variables['Agent.OS'], 'Windows_NT')

          - task: Npm@1
            displayName: 'Install Appium'
            inputs:
              command: 'custom'
              customCommand: 'install -g appium@$(appiumVersion)'

          - bash: |
              echo "üîå Installing Appium UiAutomator2 Driver..."
              
              # Verify Appium is installed
              if ! command -v appium &> /dev/null; then
                echo "‚ùå Appium is not installed!"
                exit 1
              fi
              
              echo "Appium version:"
              appium --version
              
              # Install UiAutomator2 driver with error handling
              echo "Installing uiautomator2 driver..."
              if appium driver install uiautomator2; then
                echo "‚úÖ UiAutomator2 driver installation command completed"
              else
                echo "‚ö†Ô∏è Driver installation command returned non-zero exit code, checking if already installed..."
              fi
              
              # Verify driver installation - show all installed drivers
              echo "Listing installed drivers:"
              appium driver list --installed || true
              
              # Alternative verification - try to list all drivers and check
              echo "All available drivers:"
              appium driver list || true
              
              # Final verification - check if uiautomator2 appears in installed list
              INSTALLED_DRIVERS=$(appium driver list --installed 2>&1 || echo "")
              echo "Installed drivers output: $INSTALLED_DRIVERS"
              
              if echo "$INSTALLED_DRIVERS" | grep -iq "uiautomator2"; then
                echo "‚úÖ UiAutomator2 driver successfully verified"
                exit 0
              else
                echo "‚ö†Ô∏è Could not verify UiAutomator2 in standard output, checking alternative methods..."
                # Try running appium driver list without filter
                ALL_DRIVERS=$(appium driver list 2>&1 || echo "")
                if echo "$ALL_DRIVERS" | grep -E "uiautomator2.*installed" -i; then
                  echo "‚úÖ UiAutomator2 driver found via alternative check"
                  exit 0
                else
                  echo "‚ùå UiAutomator2 driver verification failed"
                  echo "Attempting to continue anyway as driver may still work..."
                  exit 0
                fi
              fi
            displayName: 'Install Appium Drivers'
            continueOnError: false

          - bash: |
              echo "üì± Checking for connected Android devices..."
              adb devices -l
              echo "Current ADB devices:"
              adb devices
              
              # Wait for device to be ready
              timeout=60
              while [ $timeout -gt 0 ]; do
                device_count=$(adb devices | grep -c "device$")
                if [ $device_count -gt 0 ]; then
                  echo "‚úÖ Android device detected!"
                  adb shell getprop ro.build.version.release
                  break
                fi
                echo "Waiting for device... ($timeout seconds remaining)"
                sleep 5
                timeout=$((timeout-5))
              done
            displayName: 'Detect Android Device'
            continueOnError: true

          # Download build artifacts from previous stage
          - task: DownloadBuildArtifacts@1
            displayName: 'Download Build Artifacts'
            inputs:
              buildType: 'current'
              downloadType: 'single'
              artifactName: 'build-output'
              downloadPath: '$(System.DefaultWorkingDirectory)'

          - bash: |
              echo "üöÄ Starting Appium Server..."
              mkdir -p logs
              appium --address 127.0.0.1 --port 4723 --session-override --log-level warn > logs/appium.log 2>&1 &
              APPIUM_PID=$!
              echo "Appium PID: $APPIUM_PID"
              echo "##vso[task.setvariable variable=APPIUM_PID]$APPIUM_PID"
              
              # Wait for Appium to start
              sleep 10
              
              # Verify Appium is running
              if curl -s http://127.0.0.1:4723/status > /dev/null; then
                echo "‚úÖ Appium server is running"
              else
                echo "‚ùå Appium server failed to start"
                cat logs/appium.log
                exit 1
              fi
            displayName: 'Start Appium Server'

          - task: Maven@4
            displayName: 'Run TestNG Tests'
            inputs:
              mavenPomFile: '$(mavenPOMFile)'
              goals: 'test'
              options: '-Dtestng.xml=testng.xml'
              publishJUnitResults: true
              testResultsFiles: '**/surefire-reports/TEST-*.xml'
              testRunTitle: 'Android Appium Tests'
              javaHomeOption: 'JDKVersion'
              jdkVersionOption: '$(jdkVersion)'
              mavenVersionOption: 'Default'
              mavenOptions: '-Xmx3072m'
            continueOnError: true

          - bash: |
              echo "üõë Stopping Appium Server..."
              if [ ! -z "$APPIUM_PID" ]; then
                kill $APPIUM_PID || true
                echo "Appium server stopped"
              fi
            displayName: 'Stop Appium Server'
            condition: always()

          # Publish Test Results
          - task: PublishTestResults@2
            displayName: 'Publish Test Results'
            inputs:
              testResultsFormat: 'JUnit'
              testResultsFiles: '**/surefire-reports/TEST-*.xml'
              mergeTestResults: true
              failTaskOnFailedTests: false
              testRunTitle: 'Eptura Android Automation Tests'
            condition: always()

          # Publish Screenshots
          - task: PublishBuildArtifacts@1
            displayName: 'Publish Screenshots'
            inputs:
              PathtoPublish: '$(screenshotsFolder)'
              ArtifactName: 'test-screenshots'
              publishLocation: 'Container'
            condition: always()

          # Publish Extent Reports
          - task: PublishBuildArtifacts@1
            displayName: 'Publish Extent Report'
            inputs:
              PathtoPublish: '$(extentReportFolder)/Extent-report.html'
              ArtifactName: 'extent-report'
              publishLocation: 'Container'
            condition: always()

          # Publish TestNG Reports
          - task: PublishBuildArtifacts@1
            displayName: 'Publish TestNG Reports'
            inputs:
              PathtoPublish: '$(System.DefaultWorkingDirectory)/test-output'
              ArtifactName: 'testng-reports'
              publishLocation: 'Container'
            condition: always()

          # Publish Appium Logs
          - task: PublishBuildArtifacts@1
            displayName: 'Publish Appium Logs'
            inputs:
              PathtoPublish: '$(System.DefaultWorkingDirectory)/logs'
              ArtifactName: 'appium-logs'
              publishLocation: 'Container'
            condition: always()

  - stage: Report
    displayName: 'Generate Reports'
    dependsOn: Test
    condition: always()
    jobs:
      - job: GenerateReports
        displayName: 'Generate Test Reports'
        steps:
          - task: DownloadBuildArtifacts@1
            displayName: 'Download Test Artifacts'
            inputs:
              buildType: 'current'
              downloadType: 'specific'
              itemPattern: '**'
              downloadPath: '$(System.DefaultWorkingDirectory)/artifacts'

          - bash: |
              echo "üìä Test Execution Summary"
              echo "=========================="
              if [ -d "artifacts/test-screenshots" ]; then
                echo "Screenshots captured: $(find artifacts/test-screenshots -type f | wc -l)"
              fi
              
              if [ -f "artifacts/extent-report/Extent-report.html" ]; then
                echo "‚úÖ Extent Report generated"
              fi
              
              if [ -d "artifacts/testng-reports" ]; then
                echo "‚úÖ TestNG Reports generated"
              fi
            displayName: 'Test Summary'
            condition: always()

          - task: PublishPipelineArtifact@1
            displayName: 'Publish Combined Reports'
            inputs:
              targetPath: '$(System.DefaultWorkingDirectory)/artifacts'
              artifact: 'all-test-reports'
              publishLocation: 'pipeline'
            condition: always()